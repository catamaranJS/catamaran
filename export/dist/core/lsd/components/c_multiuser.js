"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t["default"]=e,t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),_get=function(e,t,s){for(var i=!0;i;){var r=e,n=t,a=s;i=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,n);if(void 0!==o){if("value"in o)return o.value;var u=o.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(r);if(null===l)return void 0;e=l,t=n,s=a,i=!0,o=l=void 0}},_ces=require("ces"),CES=_interopRequireWildcard(_ces),_libBabylon=require("../lib/babylon"),BABYLON=_interopRequireWildcard(_libBabylon),_utilsUtils=require("../utils/utils"),defaults=_utilsUtils.utils.defaultArgs();defaults._name="multiuser";var c_multiuser=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?defaults:arguments[0];_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.name=e._name,this.firebaseRef=e._fbURL,this.scene=e._scene,this.sysInit=!1,this.userInit=!1,_utilsUtils.utils.loadScript("https://cdn.firebase.com/js/client/2.3.0/firebase.js",this.setMultiUserData.bind(this))}return _inherits(t,e),_createClass(t,[{key:"setMultiUserData",value:function(){this.multiuser=new Firebase(this.firebaseRef),this.users=new Firebase(this.firebaseRef+"users"),this.user={name:null,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},sprite:null},this.currentUsers=[],this.fakeUser=["Tom","Richard","Jane","John","Dan","Josh","Brendon","Emma","Peter"],this.spriteImg="assets/sprites/users.png",this.sprites=[],this.Alerts=new Firebase(this.firebaseRef+"alerts"),this.currentAlerts=[],this.currentUserKey=null,this.executeUserRemoval=null,this.userToUpdate=this.firebaseRef+"users/",this.spriteAnimations=[20,40,60,80],this.zombieMode=!1,this.isCurrentlyUsing=!1,this.spManager=null,this.playerSprite=null,this.spriteID=20,this.initSys()}},{key:"initSys",value:function(){this.setUser(null,new BABYLON.Vector3(0,0,0)),this.spManager=new BABYLON.SpriteManager("userManager",this.spriteImg,1e3,128,this.scene),this.spManager.layerMask=3,this.playerSprite=new BABYLON.Sprite("player",this.spManager),this.playerSprite.isPickable=!0,this.zombieMode?this.playerSprite.playAnimation(80,100,!0,100):this.playerSprite.playAnimation(Math.abs(20-this.user.spriteID),parseInt(this.user.spriteID),!0,100),this.playerSprite.position=new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),this.sprites.push({sprite:this.playerSprite,key:this.currentUserKey}),window.requestAnimationFrame(function(){this.Alerts.on("child_added",function(e){this.currentAlerts.push(e.val())}.bind(this)),this.Alerts.once("value",function(e){e.forEach(function(e){this.currentAlerts.push(e.val())}.bind(this))}.bind(this)),this.users.on("child_changed",function(e){for(var t=0;t<this.currentUsers.length;t++)e.key()==this.currentUsers[t].key&&(this.currentUsers[t].data=e.val())}.bind(this)),this.users.once("value",function(e){this.checkUsers(e)}.bind(this)),this.sysInit=!0,setTimeout(function(){this.addUsers()}.bind(this),500)}.bind(this))}},{key:"addUsers",value:function(){for(var e=0;e<this.currentUsers.length;e++)this.currentUsers[e].key!=this.currentUserKey&&this.generateUserSprites(this.currentUsers[e],e);this.userInit=!0}},{key:"checkUsers",value:function(e){var t=!1;e.forEach(function(s){null!=window.localStorage.getItem("vr_user_key")&&s.key()==window.localStorage.getItem("vr_user_key")&&(this.user=s.val(),this.currentUserKey=s.key(),this.userToUpdate+=s.key(),this.userToUpdate=new Firebase(this.userToUpdate),this.isCurrentlyUsing=!0),void 0!=s.val().name&&void 0!=s.val().position&&void 0!=s.val().rotation&&void 0!=s.val().sprite&&void 0!=s.val().spriteID&&(t||(t=!0,e.forEach(function(e){this.currentUsers.push({data:e.val(),key:e.key()})}.bind(this))))}.bind(this))}},{key:"generateUserSprites",value:function(e,t){var s=new BABYLON.SpriteManager(e.key,e.data.sprite,1,128,this.scene);s.layerMask=3,s.texture=this.spManager.texture.clone();var i=new BABYLON.Sprite(e.key,s);i.isPickable=!0,i.position=void 0!=typeof e.data.position?e.data.position:new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),i.size=14,e.data.zombieMode?i.playAnimation(80,100,!0,100):i.playAnimation(Math.abs(20-parseInt(e.data.spriteID)),parseInt(e.data.spriteID),!0,100),this.sprites.push({sprite:i,key:e.key})}},{key:"deleteUser",value:function(e){var t=new Firebase(this.firebaseRef+"users/"+e);t.once("value",function(s){var i=BABYLON.Mesh.CreateBox("foutain",1,this.babylonMod.scene);i.isVisible=!1,i.position=new BABYLON.Vector3(s.val().position.x,s.val().position.y,s.val().position.z);var r=new BABYLON.ParticleSystem("particles",1e3,this.babylonMod.scene);r.particleTexture=new BABYLON.Texture("bartvr/img/textures/flare.png",this.babylonMod.scene),r.emitter=i,r.minEmitBox=new BABYLON.Vector3(-1,0,0),r.maxEmitBox=new BABYLON.Vector3(1,0,0),r.color1=new BABYLON.Color4(.7,.8,1,1),r.color2=new BABYLON.Color4(.2,.5,1,1),r.colorDead=new BABYLON.Color4(0,0,.2,0),r.minSize=.1,r.maxSize=.5,r.minLifeTime=.1,r.maxLifeTime=.3,r.emitRate=1e3,r.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,r.gravity=new BABYLON.Vector3(0,-9.81,0),r.direction1=new BABYLON.Vector3(-4,6,4),r.direction2=new BABYLON.Vector3(4,6,-4),r.minEmitPower=1,r.maxEmitPower=3,r.updateSpeed=.005,r.start(),setTimeout(function(){r.stop(),r.dispose();for(var s=0;s<this.scene.spriteManagers.length;s++)this.scene.spriteManagers[s].name==e&&this.scene.spriteManagers[s].dispose();t.remove()}.bind(this),5e3)}.bind(this),function(e){console.log(e)})}},{key:"setUser",value:function(){var e=(arguments.length<=0||void 0===arguments[0]?{name:"userName",position:{x:0,y:0,z:0}}:arguments[0],arguments.length<=1||void 0===arguments[1]?{}:arguments[1]);if(null==window.localStorage.getItem("vr_user")){e.x=_utilsUtils.utils.randomPos(-85,2),e.y=0,e.z=_utilsUtils.utils.randomPos(5,15);var t=null;t=null==this.user.name?_utilsUtils.utils.randomArr(this.fakeUser):this.user.name;try{window.localStorage.setItem("vr_user",t)}catch(s){alert("please allow local storage please disable private mode")}this.user={name:t,position:e,rotation:new BABYLON.Vector3(0,0,0),sprite:this.spriteImg,spriteID:_utilsUtils.utils.randomArr(this.spriteAnimations)},this.users.once("value",function(e){this.checkUsers(e)}.bind(this)),this.users=this.users.push(this.user),this.currentUserKey=this.users.key();try{window.localStorage.setItem("vr_user_key",this.currentUserKey)}catch(s){console.log(s)}}}},{key:"updateUser",value:function(e,t){this.sysInit&&(this.isCurrentlyUsing?this.userToUpdate.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}):null!=this.user.name&&this.users.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}))}},{key:"debug",value:function(){}}]),t}(CES.Component);exports.c_multiuser=c_multiuser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUvbHNkL2NvbXBvbmVudHMvY19tdWx0aXVzZXIuanMiXSwibmFtZXMiOlsiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiX2NsYXNzQ2FsbENoZWNrIiwiaW5zdGFuY2UiLCJDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIl9pbmhlcml0cyIsInN1YkNsYXNzIiwic3VwZXJDbGFzcyIsImNyZWF0ZSIsImNvbnN0cnVjdG9yIiwidmFsdWUiLCJlbnVtZXJhYmxlIiwid3JpdGFibGUiLCJjb25maWd1cmFibGUiLCJzZXRQcm90b3R5cGVPZiIsIl9fcHJvdG9fXyIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsIl9jcmVhdGVDbGFzcyIsImRlZmluZVByb3BlcnRpZXMiLCJ0YXJnZXQiLCJwcm9wcyIsImkiLCJsZW5ndGgiLCJkZXNjcmlwdG9yIiwicHJvdG9Qcm9wcyIsInN0YXRpY1Byb3BzIiwiX2dldCIsIl94NCIsIl94NSIsIl94NiIsIl9hZ2FpbiIsIm9iamVjdCIsInByb3BlcnR5IiwicmVjZWl2ZXIiLCJGdW5jdGlvbiIsImRlc2MiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ1bmRlZmluZWQiLCJnZXR0ZXIiLCJnZXQiLCJwYXJlbnQiLCJnZXRQcm90b3R5cGVPZiIsIl9jZXMiLCJyZXF1aXJlIiwiQ0VTIiwiX2xpYkJhYnlsb24iLCJCQUJZTE9OIiwiX3V0aWxzVXRpbHMiLCJkZWZhdWx0cyIsInV0aWxzIiwiZGVmYXVsdEFyZ3MiLCJfbmFtZSIsImNfbXVsdGl1c2VyIiwiX0NFUyRDb21wb25lbnQiLCJfb3B0cyIsImFyZ3VtZW50cyIsInRoaXMiLCJuYW1lIiwiZmlyZWJhc2VSZWYiLCJfZmJVUkwiLCJzY2VuZSIsIl9zY2VuZSIsInN5c0luaXQiLCJ1c2VySW5pdCIsImxvYWRTY3JpcHQiLCJzZXRNdWx0aVVzZXJEYXRhIiwiYmluZCIsIm11bHRpdXNlciIsIkZpcmViYXNlIiwidXNlcnMiLCJ1c2VyIiwicG9zaXRpb24iLCJ4IiwieSIsInoiLCJyb3RhdGlvbiIsInNwcml0ZSIsImN1cnJlbnRVc2VycyIsImZha2VVc2VyIiwic3ByaXRlSW1nIiwic3ByaXRlcyIsIkFsZXJ0cyIsImN1cnJlbnRBbGVydHMiLCJjdXJyZW50VXNlcktleSIsImV4ZWN1dGVVc2VyUmVtb3ZhbCIsInVzZXJUb1VwZGF0ZSIsInNwcml0ZUFuaW1hdGlvbnMiLCJ6b21iaWVNb2RlIiwiaXNDdXJyZW50bHlVc2luZyIsInNwTWFuYWdlciIsInBsYXllclNwcml0ZSIsInNwcml0ZUlEIiwiaW5pdFN5cyIsInNldFVzZXIiLCJWZWN0b3IzIiwiU3ByaXRlTWFuYWdlciIsImxheWVyTWFzayIsIlNwcml0ZSIsImlzUGlja2FibGUiLCJwbGF5QW5pbWF0aW9uIiwiTWF0aCIsImFicyIsInBhcnNlSW50IiwicHVzaCIsIndpbmRvdyIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsIm9uIiwiYWxlcnREYXRhIiwidmFsIiwib25jZSIsImZvckVhY2giLCJkYXRhIiwidXNlckRhdGEiLCJjaGVja1VzZXJzIiwic2V0VGltZW91dCIsImFkZFVzZXJzIiwiZ2VuZXJhdGVVc2VyU3ByaXRlcyIsInVzZXJIYXZlTG9hZGVkIiwibG9jYWxTdG9yYWdlIiwiZ2V0SXRlbSIsIl9kYXRhIiwiX2lkIiwic3ByaXRlTWFuYWdlclJpZGVyIiwidGV4dHVyZSIsImNsb25lIiwicGxheWVyIiwic2l6ZSIsIl9ka2V5IiwidXNlclJlZiIsImZvdW50YWluIiwiTWVzaCIsIkNyZWF0ZUJveCIsImJhYnlsb25Nb2QiLCJpc1Zpc2libGUiLCJwYXJ0aWNsZVN5c3RlbSIsIlBhcnRpY2xlU3lzdGVtIiwicGFydGljbGVUZXh0dXJlIiwiVGV4dHVyZSIsImVtaXR0ZXIiLCJtaW5FbWl0Qm94IiwibWF4RW1pdEJveCIsImNvbG9yMSIsIkNvbG9yNCIsImNvbG9yMiIsImNvbG9yRGVhZCIsIm1pblNpemUiLCJtYXhTaXplIiwibWluTGlmZVRpbWUiLCJtYXhMaWZlVGltZSIsImVtaXRSYXRlIiwiYmxlbmRNb2RlIiwiQkxFTkRNT0RFX09ORU9ORSIsImdyYXZpdHkiLCJkaXJlY3Rpb24xIiwiZGlyZWN0aW9uMiIsIm1pbkVtaXRQb3dlciIsIm1heEVtaXRQb3dlciIsInVwZGF0ZVNwZWVkIiwic3RhcnQiLCJzdG9wIiwiZGlzcG9zZSIsInNwcml0ZU1hbmFnZXJzIiwicmVtb3ZlIiwiZXJyb3JPYmplY3QiLCJjb25zb2xlIiwibG9nIiwiX3BvcyIsInJhbmRvbVBvcyIsIl91c2VybmFtZSIsInJhbmRvbUFyciIsInNldEl0ZW0iLCJlIiwiYWxlcnQiLCJzZXQiLCJDb21wb25lbnQiXSwibWFwcGluZ3MiOiJBQUFBLFlBVUEsU0FBU0EseUJBQXdCQyxHQUFPLEdBQUlBLEdBQU9BLEVBQUlDLFdBQWMsTUFBT0QsRUFBYyxJQUFJRSxLQUFhLElBQVcsTUFBUEYsRUFBZSxJQUFLLEdBQUlHLEtBQU9ILEdBQVdJLE9BQU9DLFVBQVVDLGVBQWVDLEtBQUtQLEVBQUtHLEtBQU1ELEVBQU9DLEdBQU9ILEVBQUlHLEdBQW1DLE9BQXpCRCxHQUFPLFdBQWFGLEVBQVlFLEVBRXJRLFFBQVNNLGlCQUFnQkMsRUFBVUMsR0FBZSxLQUFNRCxZQUFvQkMsSUFBZ0IsS0FBTSxJQUFJQyxXQUFVLHFDQUVoSCxRQUFTQyxXQUFVQyxFQUFVQyxHQUFjLEdBQTBCLGtCQUFmQSxJQUE0QyxPQUFmQSxFQUF1QixLQUFNLElBQUlILFdBQVUsaUVBQW9FRyxHQUFlRCxHQUFTUixVQUFZRCxPQUFPVyxPQUFPRCxHQUFjQSxFQUFXVCxXQUFhVyxhQUFlQyxNQUFPSixFQUFVSyxZQUFZLEVBQU9DLFVBQVUsRUFBTUMsY0FBYyxLQUFlTixJQUFZVixPQUFPaUIsZUFBaUJqQixPQUFPaUIsZUFBZVIsRUFBVUMsR0FBY0QsRUFBU1MsVUFBWVIsR0FaamVWLE9BQU9tQixlQUFlQyxRQUFTLGNB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S2MsTUFBUWIsS0FBSytHLEVBQVdqRyxTQUFVK0YsRUFBTTNGLFNBQVUsR0FBSTdCLFNBQVFnRCxRQUFRLEVBQUcsRUFBRyxHQUFJbEIsT0FBT3BCLEtBQUt1QixVQUFXWSxTQUFVNUMsWUFBQUUsTUFBTXdILFVBQVVqSCxLQUFLOEIsbUJBRTNJOUIsS0FBS2EsTUFBTXdDLEtBQUssUUFBUyxTQUFTRyxHQUM5QnhELEtBQUt5RCxXQUFXRCxJQUNsQjlDLEtBQUtWLE9BR1BBLEtBQUthLE1BQVFiLEtBQUthLE1BQU1rQyxLQUFNL0MsS0FBS2MsTUFDbkNkLEtBQUsyQixlQUFpQjNCLEtBQUthLE1BQU0xRSxLQUNqQyxLQUNFNkcsT0FBT2MsYUFBYW9ELFFBQVEsY0FBZWxILEtBQUsyQixnQkFDakQsTUFBTXdGLEdBQ0hQLFFBQVFDLElBQUlNLFFBMENoQmhMLElBQUssYUFDTGMsTUFwQ00sU0FBQzhELEVBQVVJLEdBQ2hCbkIsS0FBS00sVUFDRE4sS0FBS2dDLGlCQUNOaEMsS0FBSzZCLGFBQWF3RixLQUFLcEgsS0FBTUQsS0FBS2MsS0FBS2IsS0FBTWMsU0FBVUEsRUFBVUksU0FBVUEsRUFBVUMsT0FBUXBCLEtBQUtjLEtBQUtNLE9BQVNlLFNBQVVuQyxLQUFLYyxLQUFLcUIsV0FFL0csTUFBbEJuQyxLQUFLYyxLQUFLYixNQUNYRCxLQUFLYSxNQUFNd0csS0FBS3BILEtBQU1ELEtBQUtjLEtBQUtiLEtBQU1jLFNBQVVBLEVBQVVJLFNBQVVBLEVBQVVDLE9BQVFwQixLQUFLYyxLQUFLTSxPQUFRZSxTQUFVbkMsS0FBS2MsS0FBS3FCLGVBMENsSWhHLElBQUssUUFDTGMsTUFyQ0MsZ0JBdk9TMkMsR0FBb0JSLElBQUlrSSxVQWtSdEM5SixTQUFRb0MsWUFBY0EiLCJmaWxlIjoiY29yZS9sc2QvY29tcG9uZW50cy9jX211bHRpdXNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIENFUyBmcm9tICdjZXMnO1xuaW1wb3J0ICogYXMgQkFCWUxPTiBmcm9tICcuLi9saWIvYmFieWxvbic7XG5pbXBvcnQgeyB1dGlscyB9IGZyb20gJy4uL3V0aWxzL3V0aWxzJztcbnZhciBkZWZhdWx0cyA9IHV0aWxzLmRlZmF1bHRBcmdzKCk7XG5kZWZhdWx0cy5fbmFtZSA9ICdtdWx0aXVzZXInO1xuXG4vKipcbiAqIC4uLlxuICogQGF1dGhvciBCcmVuZG9uIFNtaXRoXG4gKiBodHRwOi8vc2VhY2xvdWQ5Lm9yZ1xuICogTGlnaHRXZWlnaHQgM0QgU3lzdGVtIERlc2lnbiBlbmdpbmVcbiAqL1xuXG4gZXhwb3J0IGNsYXNzIGNfbXVsdGl1c2VyIGV4dGVuZHMgQ0VTLkNvbXBvbmVudHtcbiAgY29uc3RydWN0b3IoX29wdHMgPSBkZWZhdWx0cyl7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm5hbWUgPSBfb3B0cy5fbmFtZTtcbiAgICB0aGlzLmZpcmViYXNlUmVmID0gX29wdHMuX2ZiVVJMO1xuICAgIHRoaXMuc2NlbmUgPSAgX29wdHMuX3NjZW5lO1xuICAgIHRoaXMuc3lzSW5pdCA9IGZhbHNlO1xuICAgIHRoaXMudXNlckluaXQgPSBmYWxzZTtcbiAgICB1dGlscy5sb2FkU2NyaXB0KFwiaHR0cHM6Ly9jZG4uZmlyZWJhc2UuY29tL2pzL2NsaWVudC8yLjMuMC9maXJlYmFzZS5qc1wiLCB0aGlzLnNldE11bHRpVXNlckRhdGEuYmluZCh0aGlzKSk7XG4gICAgXG4gIH1cblxuICBzZXRNdWx0aVVzZXJEYXRhKCl7XG4gICAgdGhpcy5tdWx0aXVzZXIgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZik7XG4gICAgdGhpcy51c2VycyA9IG5ldyBGaXJlYmFzZSh0aGlzLmZpcmViYXNlUmVmICsgJ3VzZXJzJyk7XG4gICAgdGhpcy51c2VyID0ge25hbWU6bnVsbCwgcG9zaXRpb246e3g6MCwgeTowLCB6OjB9LCByb3RhdGlvbjp7eDowLCB5OjAsIHo6MH0sIHNwcml0ZTpudWxsfTtcbiAgICB0aGlzLmN1cnJlbnRVc2VycyA9IFtdO1xuICAgIHRoaXMuZmFrZVVzZXIgPSBbJ1RvbScsJ1JpY2hhcmQnLCdKYW5lJywnSm9obicsJ0RhbicsJ0pvc2gnLCdCcmVuZG9uJywnRW1tYScsJ1BldGVyJ107XG4gICAgdGhpcy5zcHJpdGVJbWcgPSAnYXNzZXRzL3Nwcml0ZXMvdXNlcnMucG5nJztcbiAgICB0aGlzLnNwcml0ZXMgPSBbXTtcbiAgICB0aGlzLkFsZXJ0cyA9IG5ldyBGaXJlYmFzZSh0aGlzLmZpcmViYXNlUmVmICsgJ2FsZXJ0cycpO1xuICAgIHRoaXMuY3VycmVudEFsZXJ0cyA9IFtdO1xuICAgIHRoaXMuY3VycmVudFVzZXJLZXkgPSBudWxsO1xuICAgIHRoaXMuZXhlY3V0ZVVzZXJSZW1vdmFsID0gbnVsbDtcbiAgICB0aGlzLnVzZXJUb1VwZGF0ZSA9ICB0aGlzLmZpcmViYXNlUmVmKyAndXNlcnMvJztcbiAgICB0aGlzLnNwcml0ZUFuaW1hdGlvbnMgPSBbMjAsNDAsNjAsODBdO1xuICAgIHRoaXMuem9tYmllTW9kZSA9IGZhbHNlO1xuICAgIHRoaXMuaXNDdXJyZW50bHlVc2luZyAgPSBmYWxzZTtcbiAgICB0aGlzLnNwTWFuYWdlciA9IG51bGw7XG4gICAgdGhpcy5wbGF5ZXJTcHJpdGUgPSBudWxsO1xuICAgIHRoaXMuc3ByaXRlSUQgPSAyMDtcbiAgICB0aGlzLmluaXRTeXMoKTtcbiAgfVxuXG4gIGluaXRTeXMoKXtcblxuICAgIHRoaXMuc2V0VXNlcihudWxsLCBuZXcgQkFCWUxPTi5WZWN0b3IzKDAsIDAsIDApKTtcblxuICAgIC8qXG4gICAgaWYoICEgdGhpcy5hcHAuX3BsYXRmb3JtLmlzKCdhbmRyb2lkJykgKXtcbiAgICAgICAgdGhpcy5odWQgPSBuZXcgQmFydFZSX0hlYWRzVXBEaXNwbGF5KHRoaXMuc2NlbmUsIHRoaXMpO1xuICAgIH1cbiAgICAqL1xuXG4gICAgdGhpcy5zcE1hbmFnZXIgID0gbmV3IEJBQllMT04uU3ByaXRlTWFuYWdlcihcInVzZXJNYW5hZ2VyXCIsIHRoaXMuc3ByaXRlSW1nLCAxMDAwLCAxMjgsIHRoaXMuc2NlbmUpO1xuICAgIHRoaXMuc3BNYW5hZ2VyLmxheWVyTWFzayA9IDM7XG4gICAgdGhpcy5wbGF5ZXJTcHJpdGUgPSBuZXcgQkFCWUxPTi5TcHJpdGUoXCJwbGF5ZXJcIiwgdGhpcy5zcE1hbmFnZXIgKTtcbiAgICB0aGlzLnBsYXllclNwcml0ZS5pc1BpY2thYmxlID0gdHJ1ZTtcblxuICAgXG5cbiAgICBpZih0aGlzLnpvbWJpZU1vZGUpe1xuICAgICAgdGhpcy5wbGF5ZXJTcHJpdGUucGxheUFuaW1hdGlvbiggODAsICAxMDAsIHRydWUsIDEwMCk7XG4gICAgfWVsc2V7XG4gICAgICB0aGlzLnBsYXllclNwcml0ZS5wbGF5QW5pbWF0aW9uKE1hdGguYWJzKCAyMCAtIHRoaXMudXNlci5zcHJpdGVJRCksICBwYXJzZUludCh0aGlzLnVzZXIuc3ByaXRlSUQpLCB0cnVlLCAxMDApO1xuICAgIH1cbiAgICAvL3RoaXMuc2NlbmUuYWN0aXZlQ2FtZXJhLnBvc2l0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyh0aGlzLnVzZXIucG9zaXRpb24ueCwgdGhpcy51c2VyLnBvc2l0aW9uLnksIHRoaXMudXNlci5wb3NpdGlvbi56KTtcbiAgICB0aGlzLnBsYXllclNwcml0ZS5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjModGhpcy51c2VyLnBvc2l0aW9uLngsIHRoaXMudXNlci5wb3NpdGlvbi55LCB0aGlzLnVzZXIucG9zaXRpb24ueik7XG4gICAgLy8gdGhpcy5zY2VuZS5hY3RpdmVDYW1lcmEucm90YXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKHRoaXMuRGF0YS51c2VyLnJvdGF0aW9uLngsIHRoaXMuRGF0YS51c2VyLnJvdGF0aW9uLnksIHRoaXMuRGF0YS51c2VyLnJvdGF0aW9uLnopO1xuICAgIHRoaXMuc3ByaXRlcy5wdXNoKHtzcHJpdGU6dGhpcy5wbGF5ZXJTcHJpdGUsIGtleTp0aGlzLmN1cnJlbnRVc2VyS2V5fSk7XG5cbiAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXtcbiAgICB0aGlzLkFsZXJ0cy5vbihcImNoaWxkX2FkZGVkXCIsIGZ1bmN0aW9uKGFsZXJ0RGF0YSkge1xuICAgICAgdGhpcy5jdXJyZW50QWxlcnRzLnB1c2goYWxlcnREYXRhLnZhbCgpKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5BbGVydHMub25jZShcInZhbHVlXCIsIGZ1bmN0aW9uKGFsZXJ0RGF0YSkge1xuICAgICAgYWxlcnREYXRhLmZvckVhY2goZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICB0aGlzLmN1cnJlbnRBbGVydHMucHVzaChkYXRhLnZhbCgpKTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMudXNlcnMub24oXCJjaGlsZF9jaGFuZ2VkXCIsIGZ1bmN0aW9uKHVzZXJEYXRhKSB7XG4gICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5jdXJyZW50VXNlcnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZih1c2VyRGF0YS5rZXkoKSA9PSB0aGlzLmN1cnJlbnRVc2Vyc1tpXS5rZXkpe1xuICAgICAgICAgdGhpcy5jdXJyZW50VXNlcnNbaV0uZGF0YSA9ICB1c2VyRGF0YS52YWwoKTtcbiAgICAgICB9XG4gICAgIH1cbiAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLnVzZXJzLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbih1c2VyRGF0YSkge1xuICAgICAgICB0aGlzLmNoZWNrVXNlcnModXNlckRhdGEpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLnN5c0luaXQgPSB0cnVlOyBcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICB0aGlzLmFkZFVzZXJzKCk7XG4gICAgfS5iaW5kKHRoaXMpLCA1MDApO1xuICB9LmJpbmQodGhpcykpO1xufVxuXG5hZGRVc2Vycygpe1xuICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLmN1cnJlbnRVc2Vycy5sZW5ndGg7IGkrKyl7XG4gICAgICAgIGlmKHRoaXMuY3VycmVudFVzZXJzW2ldLmtleSAhPSB0aGlzLmN1cnJlbnRVc2VyS2V5KXtcbiAgICAgICAgICAgIHRoaXMuZ2VuZXJhdGVVc2VyU3ByaXRlcyh0aGlzLmN1cnJlbnRVc2Vyc1tpXSwgaSk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgdGhpcy51c2VySW5pdCA9IHRydWU7XG59XG5cbmNoZWNrVXNlcnModXNlckRhdGEpe1xuICB2YXIgdXNlckhhdmVMb2FkZWQgPSBmYWxzZTtcbiAgICAgIHVzZXJEYXRhLmZvckVhY2goZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICBpZih3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJ2cl91c2VyX2tleVwiKSAhPSBudWxsICYmIGRhdGEua2V5KCkgPT0gd2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKFwidnJfdXNlcl9rZXlcIikgKXtcbiAgICAgICAgICB0aGlzLnVzZXIgPSBkYXRhLnZhbCgpO1xuICAgICAgICAgIHRoaXMuY3VycmVudFVzZXJLZXkgPSBkYXRhLmtleSgpO1xuICAgICAgICAgIHRoaXMudXNlclRvVXBkYXRlICs9ICBkYXRhLmtleSgpO1xuICAgICAgICAgIHRoaXMudXNlclRvVXBkYXRlID0gbmV3IEZpcmViYXNlKHRoaXMudXNlclRvVXBkYXRlKTtcbiAgICAgICAgICB0aGlzLmlzQ3VycmVudGx5VXNpbmcgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGlmKGRhdGEudmFsKCkubmFtZSAhPSB1bmRlZmluZWQgJiYgZGF0YS52YWwoKS5wb3NpdGlvbiAhPSB1bmRlZmluZWQgJiYgZGF0YS52YWwoKS5yb3RhdGlvbiAhPSB1bmRlZmluZWQgJiYgZGF0YS52YWwoKS5zcHJpdGUgIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkuc3ByaXRlSUQgIT0gdW5kZWZpbmVkKXtcbiAgICAgICAgICBpZighdXNlckhhdmVMb2FkZWQpe1xuICAgICAgICAgICAgICB1c2VySGF2ZUxvYWRlZCA9IHRydWU7XG4gICAgICAgICAgICAgIHVzZXJEYXRhLmZvckVhY2goZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50VXNlcnMucHVzaCh7ZGF0YTpkYXRhLnZhbCgpLCBrZXk6IGRhdGEua2V5KCl9KTtcbiAgICAgICAgICAgICAgfS5iaW5kKHRoaXMpKTtcbiAgICAgICAgICB9ICBcbiAgICAgICAgfVxuICAgICAgfS5iaW5kKHRoaXMpKTtcbn1cblxuZ2VuZXJhdGVVc2VyU3ByaXRlcyhfZGF0YSwgX2lkKXtcbiAgICB2YXIgc3ByaXRlTWFuYWdlclJpZGVyID0gbmV3IEJBQllMT04uU3ByaXRlTWFuYWdlcihfZGF0YS5rZXksIF9kYXRhLmRhdGEuc3ByaXRlLCAxLCAxMjgsIHRoaXMuc2NlbmUpO1xuICAgIHNwcml0ZU1hbmFnZXJSaWRlci5sYXllck1hc2sgPSAzO1xuICAgIHNwcml0ZU1hbmFnZXJSaWRlci50ZXh0dXJlID0gdGhpcy5zcE1hbmFnZXIudGV4dHVyZS5jbG9uZSgpO1xuICAgIGxldCBwbGF5ZXIgPSBuZXcgQkFCWUxPTi5TcHJpdGUoX2RhdGEua2V5LCBzcHJpdGVNYW5hZ2VyUmlkZXIgKTtcbiAgICBwbGF5ZXIuaXNQaWNrYWJsZSA9IHRydWU7XG4gICAgaWYodHlwZW9mICBfZGF0YS5kYXRhLnBvc2l0aW9uICE9IHVuZGVmaW5lZCl7XG4gICAgICBwbGF5ZXIucG9zaXRpb24gPSBfZGF0YS5kYXRhLnBvc2l0aW9uO1xuICAgIH1lbHNle1xuICAgICAgcGxheWVyLnBvc2l0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyh0aGlzLnVzZXIucG9zaXRpb24ueCwgdGhpcy51c2VyLnBvc2l0aW9uLnksIHRoaXMudXNlci5wb3NpdGlvbi56KTtcbiAgICB9XG4gICAgLy9wbGF5ZXIucm90YXRpb24gPSBfZGF0YS5kYXRhLnJvdGF0aW9uO1xuICAgIHBsYXllci5zaXplID0gMTQuMDtcbiAgICBpZihfZGF0YS5kYXRhLnpvbWJpZU1vZGUpe1xuICAgICAgICBwbGF5ZXIucGxheUFuaW1hdGlvbiggODAsICAxMDAsIHRydWUsIDEwMCk7XG4gICAgfWVsc2V7XG4gICAgICAgIHBsYXllci5wbGF5QW5pbWF0aW9uKE1hdGguYWJzKCAyMCAtIHBhcnNlSW50KF9kYXRhLmRhdGEuc3ByaXRlSUQpKSwgIHBhcnNlSW50KF9kYXRhLmRhdGEuc3ByaXRlSUQpLCB0cnVlLCAxMDApO1xuICAgIH1cbiAgICB0aGlzLnNwcml0ZXMucHVzaCh7c3ByaXRlOnBsYXllciwga2V5Ol9kYXRhLmtleX0pO1xufVxuXG5kZWxldGVVc2VyKF9ka2V5KXtcbiAgdmFyIHVzZXJSZWYgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICd1c2Vycy8nICArIF9ka2V5KTtcbiAgdXNlclJlZi5vbmNlKFwidmFsdWVcIiwgZnVuY3Rpb24oX2RhdGEpIHtcbiAgICB2YXIgZm91bnRhaW4gPSBCQUJZTE9OLk1lc2guQ3JlYXRlQm94KFwiZm91dGFpblwiLCAxLjAsIHRoaXMuYmFieWxvbk1vZC5zY2VuZSk7XG4gICAgZm91bnRhaW4uaXNWaXNpYmxlID0gZmFsc2U7XG4gICAgZm91bnRhaW4ucG9zaXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKF9kYXRhLnZhbCgpLnBvc2l0aW9uLngsIF9kYXRhLnZhbCgpLnBvc2l0aW9uLnksIF9kYXRhLnZhbCgpLnBvc2l0aW9uLnopXG4gICAgdmFyIHBhcnRpY2xlU3lzdGVtID0gbmV3IEJBQllMT04uUGFydGljbGVTeXN0ZW0oXCJwYXJ0aWNsZXNcIiwgMTAwMCwgdGhpcy5iYWJ5bG9uTW9kLnNjZW5lKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5wYXJ0aWNsZVRleHR1cmUgPSBuZXcgQkFCWUxPTi5UZXh0dXJlKFwiYmFydHZyL2ltZy90ZXh0dXJlcy9mbGFyZS5wbmdcIiwgdGhpcy5iYWJ5bG9uTW9kLnNjZW5lKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5lbWl0dGVyID0gZm91bnRhaW47IC8vIHRoZSBzdGFydGluZyBvYmplY3QsIHRoZSBlbWl0dGVyXG4gICAgcGFydGljbGVTeXN0ZW0ubWluRW1pdEJveCA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoLTEsIDAsIDApOyAvLyBTdGFydGluZyBhbGwgZnJvbVxuICAgIHBhcnRpY2xlU3lzdGVtLm1heEVtaXRCb3ggPSBuZXcgQkFCWUxPTi5WZWN0b3IzKDEsIDAsIDApOyAvLyBUby4uLlxuICAgIHBhcnRpY2xlU3lzdGVtLmNvbG9yMSA9IG5ldyBCQUJZTE9OLkNvbG9yNCgwLjcsIDAuOCwgMS4wLCAxLjApO1xuICAgIHBhcnRpY2xlU3lzdGVtLmNvbG9yMiA9IG5ldyBCQUJZTE9OLkNvbG9yNCgwLjIsIDAuNSwgMS4wLCAxLjApO1xuICAgIHBhcnRpY2xlU3lzdGVtLmNvbG9yRGVhZCA9IG5ldyBCQUJZTE9OLkNvbG9yNCgwLCAwLCAwLjIsIDAuMCk7XG4gICAgcGFydGljbGVTeXN0ZW0ubWluU2l6ZSA9IDAuMTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5tYXhTaXplID0gMC41O1xuICAgIHBhcnRpY2xlU3lzdGVtLm1pbkxpZmVUaW1lID0gMC4xO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1heExpZmVUaW1lID0gMC4zO1xuICAgIHBhcnRpY2xlU3lzdGVtLmVtaXRSYXRlID0gMTAwMDtcbiAgICBwYXJ0aWNsZVN5c3RlbS5ibGVuZE1vZGUgPSBCQUJZTE9OLlBhcnRpY2xlU3lzdGVtLkJMRU5ETU9ERV9PTkVPTkU7XG4gICAgcGFydGljbGVTeXN0ZW0uZ3Jhdml0eSA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgLTkuODEsIDApO1xuICAgIHBhcnRpY2xlU3lzdGVtLmRpcmVjdGlvbjEgPSBuZXcgQkFCWUxPTi5WZWN0b3IzKC00LCA2LCA0KTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5kaXJlY3Rpb24yID0gbmV3IEJBQllMT04uVmVjdG9yMyg0LCA2LCAtNCk7XG4gICAgcGFydGljbGVTeXN0ZW0ubWluRW1pdFBvd2VyID0gMTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5tYXhFbWl0UG93ZXIgPSAzO1xuICAgIHBhcnRpY2xlU3lzdGVtLnVwZGF0ZVNwZWVkID0gMC4wMDU7XG4gICAgcGFydGljbGVTeXN0ZW0uc3RhcnQoKTtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgICBwYXJ0aWNsZVN5c3RlbS5zdG9wKCk7XG4gICAgICBwYXJ0aWNsZVN5c3RlbS5kaXNwb3NlKCk7XG4gICAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5zY2VuZS5zcHJpdGVNYW5hZ2Vycy5sZW5ndGg7IGkrKyl7XG4gICAgICAgIGlmKCAgdGhpcy5zY2VuZS5zcHJpdGVNYW5hZ2Vyc1tpXS5uYW1lID09IF9ka2V5KXtcbiAgICAgICAgICB0aGlzLnNjZW5lLnNwcml0ZU1hbmFnZXJzW2ldLmRpc3Bvc2UoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdXNlclJlZi5yZW1vdmUoKTtcbiAgICB9LmJpbmQodGhpcyksIDUwMDApOyAgICAgICBcbiAgfS5iaW5kKHRoaXMpLCBmdW5jdGlvbiAoZXJyb3JPYmplY3QpIHtcbiAgIGNvbnNvbGUubG9nKGVycm9yT2JqZWN0KTtcbiB9KTtcbn1cblxuc2V0VXNlcihfdXNlciA9IHtuYW1lOiAndXNlck5hbWUnLCBwb3NpdGlvbjoge3g6MCwgeTowLCB6OjB9fSwgX3BvcyA9IHt9ICl7XG4gIGlmKHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInZyX3VzZXJcIikgPT0gbnVsbCl7XG4gICAgX3Bvcy54ID0gdXRpbHMucmFuZG9tUG9zKC04NSwgMik7XG4gICAgX3Bvcy55ID0gMDtcbiAgICBfcG9zLnogPSB1dGlscy5yYW5kb21Qb3MoNSwgMTUpO1xuICAgIHZhciBfdXNlcm5hbWUgPSBudWxsO1xuICAgIGlmKHRoaXMudXNlci5uYW1lID09IG51bGwpe1xuICAgICAgX3VzZXJuYW1lID0gIHV0aWxzLnJhbmRvbUFycih0aGlzLmZha2VVc2VyKTtcbiAgICB9ZWxzZXtcbiAgICAgIF91c2VybmFtZSA9IHRoaXMudXNlci5uYW1lO1xuICAgIH1cbiAgICB0cnl7XG4gICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ2cl91c2VyXCIsIF91c2VybmFtZSk7XG4gICAgfWNhdGNoKGUpe1xuICAgICAgYWxlcnQoJ3BsZWFzZSBhbGxvdyBsb2NhbCBzdG9yYWdlIHBsZWFzZSBkaXNhYmxlIHByaXZhdGUgbW9kZScpO1xuICAgIH1cbiAgICB0aGlzLnVzZXIgPSB7bmFtZTpfdXNlcm5hbWUsIHBvc2l0aW9uOiBfcG9zLCByb3RhdGlvbjogbmV3IEJBQllMT04uVmVjdG9yMygwLCAwLCAwKSwgc3ByaXRlOnRoaXMuc3ByaXRlSW1nLCBzcHJpdGVJRDogdXRpbHMucmFuZG9tQXJyKHRoaXMuc3ByaXRlQW5pbWF0aW9ucykgfTtcblxuICAgIHRoaXMudXNlcnMub25jZShcInZhbHVlXCIsIGZ1bmN0aW9uKHVzZXJEYXRhKSB7XG4gICAgICAgIHRoaXMuY2hlY2tVc2Vycyh1c2VyRGF0YSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuXG4gICAgdGhpcy51c2VycyA9IHRoaXMudXNlcnMucHVzaCggdGhpcy51c2VyKTsgIFxuICAgIHRoaXMuY3VycmVudFVzZXJLZXkgPSB0aGlzLnVzZXJzLmtleSgpO1xuICAgIHRyeXtcbiAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShcInZyX3VzZXJfa2V5XCIsIHRoaXMuY3VycmVudFVzZXJLZXkgKTtcbiAgICB9Y2F0Y2goZSl7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgIH1cblxuICB9XG59XG5cblxudXBkYXRlVXNlcihwb3NpdGlvbiwgcm90YXRpb24pe1xuICBpZih0aGlzLnN5c0luaXQpe1xuICAgICAgaWYodGhpcy5pc0N1cnJlbnRseVVzaW5nKXtcbiAgICAgICAgdGhpcy51c2VyVG9VcGRhdGUuc2V0KHtuYW1lOiB0aGlzLnVzZXIubmFtZSwgcG9zaXRpb246IHBvc2l0aW9uLCByb3RhdGlvbjogcm90YXRpb24sIHNwcml0ZTogdGhpcy51c2VyLnNwcml0ZSwgIHNwcml0ZUlEOiB0aGlzLnVzZXIuc3ByaXRlSUQgfSk7XG4gICAgICB9ZWxzZXtcbiAgICAgICAgaWYodGhpcy51c2VyLm5hbWUgIT0gbnVsbCl7XG4gICAgICAgICAgdGhpcy51c2Vycy5zZXQoe25hbWU6IHRoaXMudXNlci5uYW1lLCBwb3NpdGlvbjogcG9zaXRpb24sIHJvdGF0aW9uOiByb3RhdGlvbiwgc3ByaXRlOiB0aGlzLnVzZXIuc3ByaXRlLCBzcHJpdGVJRDogdGhpcy51c2VyLnNwcml0ZUlEIH0pO1xuICAgICAgICB9XG4gICAgICB9XG4gIH1cbn1cblxuZGVidWcoKXtcblxufVxuXG5cbn0iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=