"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),_get=function(e,t,s){for(var i=!0;i;){var r=e,n=t,a=s;i=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,n);if(void 0!==o){if("value"in o)return o.value;var u=o.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(r);if(null===l)return void 0;e=l,t=n,s=a,i=!0,o=l=void 0}},CES=require("CES"),BABYLON=require("../lib/babylon"),utils=require("../utils/utils"),defaults=utils.defaultArgs();defaults._name="multiuser";var c_multiuser=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?defaults:arguments[0];_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.name=e._name,this.firebaseRef=e._fbURL,this.scene=e._scene,this.sysInit=!1,this.userInit=!1,utils.loadScript("https://cdn.firebase.com/js/client/2.3.0/firebase.js",this.setMultiUserData.bind(this))}return _inherits(t,e),_createClass(t,[{key:"setMultiUserData",value:function(){this.multiuser=new Firebase(this.firebaseRef),this.users=new Firebase(this.firebaseRef+"users"),this.user={name:null,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},sprite:null},this.currentUsers=[],this.fakeUser=["Tom","Richard","Jane","John","Dan","Josh","Brendon","Emma","Peter"],this.spriteImg="assets/sprites/users.png",this.sprites=[],this.Alerts=new Firebase(this.firebaseRef+"alerts"),this.currentAlerts=[],this.currentUserKey=null,this.executeUserRemoval=null,this.userToUpdate=this.firebaseRef+"users/",this.spriteAnimations=[20,40,60,80],this.zombieMode=!1,this.isCurrentlyUsing=!1,this.spManager=null,this.playerSprite=null,this.spriteID=20,this.initSys()}},{key:"initSys",value:function(){this.setUser(null,new BABYLON.Vector3(0,0,0)),this.spManager=new BABYLON.SpriteManager("userManager",this.spriteImg,1e3,128,this.scene),this.spManager.layerMask=3,this.playerSprite=new BABYLON.Sprite("player",this.spManager),this.playerSprite.isPickable=!0,this.zombieMode?this.playerSprite.playAnimation(80,100,!0,100):this.playerSprite.playAnimation(Math.abs(20-this.user.spriteID),parseInt(this.user.spriteID),!0,100),this.playerSprite.position=new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),this.sprites.push({sprite:this.playerSprite,key:this.currentUserKey}),window.requestAnimationFrame(function(){this.Alerts.on("child_added",function(e){this.currentAlerts.push(e.val())}.bind(this)),this.Alerts.once("value",function(e){e.forEach(function(e){this.currentAlerts.push(e.val())}.bind(this))}.bind(this)),this.users.on("child_changed",function(e){for(var t=0;t<this.currentUsers.length;t++)e.key()==this.currentUsers[t].key&&(this.currentUsers[t].data=e.val())}.bind(this)),this.users.once("value",function(e){this.checkUsers(e)}.bind(this)),this.sysInit=!0,setTimeout(function(){this.addUsers()}.bind(this),500)}.bind(this))}},{key:"addUsers",value:function(){for(var e=0;e<this.currentUsers.length;e++)this.currentUsers[e].key!=this.currentUserKey&&this.generateUserSprites(this.currentUsers[e],e);this.userInit=!0}},{key:"checkUsers",value:function(e){var t=!1;e.forEach(function(s){null!=window.localStorage.getItem("vr_user_key")&&s.key()==window.localStorage.getItem("vr_user_key")&&(this.user=s.val(),this.currentUserKey=s.key(),this.userToUpdate+=s.key(),this.userToUpdate=new Firebase(this.userToUpdate),this.isCurrentlyUsing=!0),void 0!=s.val().name&&void 0!=s.val().position&&void 0!=s.val().rotation&&void 0!=s.val().sprite&&void 0!=s.val().spriteID&&(t||(t=!0,e.forEach(function(e){this.currentUsers.push({data:e.val(),key:e.key()})}.bind(this))))}.bind(this))}},{key:"generateUserSprites",value:function(e,t){var s=new BABYLON.SpriteManager(e.key,e.data.sprite,1,128,this.scene);s.layerMask=3,s.texture=this.spManager.texture.clone();var i=new BABYLON.Sprite(e.key,s);i.isPickable=!0,i.position=void 0!=typeof e.data.position?e.data.position:new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),i.size=14,e.data.zombieMode?i.playAnimation(80,100,!0,100):i.playAnimation(Math.abs(20-parseInt(e.data.spriteID)),parseInt(e.data.spriteID),!0,100),this.sprites.push({sprite:i,key:e.key})}},{key:"deleteUser",value:function(e){var t=new Firebase(this.firebaseRef+"users/"+e);t.once("value",function(s){var i=BABYLON.Mesh.CreateBox("foutain",1,this.babylonMod.scene);i.isVisible=!1,i.position=new BABYLON.Vector3(s.val().position.x,s.val().position.y,s.val().position.z);var r=new BABYLON.ParticleSystem("particles",1e3,this.babylonMod.scene);r.particleTexture=new BABYLON.Texture("bartvr/img/textures/flare.png",this.babylonMod.scene),r.emitter=i,r.minEmitBox=new BABYLON.Vector3(-1,0,0),r.maxEmitBox=new BABYLON.Vector3(1,0,0),r.color1=new BABYLON.Color4(.7,.8,1,1),r.color2=new BABYLON.Color4(.2,.5,1,1),r.colorDead=new BABYLON.Color4(0,0,.2,0),r.minSize=.1,r.maxSize=.5,r.minLifeTime=.1,r.maxLifeTime=.3,r.emitRate=1e3,r.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,r.gravity=new BABYLON.Vector3(0,-9.81,0),r.direction1=new BABYLON.Vector3(-4,6,4),r.direction2=new BABYLON.Vector3(4,6,-4),r.minEmitPower=1,r.maxEmitPower=3,r.updateSpeed=.005,r.start(),setTimeout(function(){r.stop(),r.dispose();for(var s=0;s<this.scene.spriteManagers.length;s++)this.scene.spriteManagers[s].name==e&&this.scene.spriteManagers[s].dispose();t.remove()}.bind(this),5e3)}.bind(this),function(e){console.log(e)})}},{key:"setUser",value:function(){var e=(arguments.length<=0||void 0===arguments[0]?{name:"userName",position:{x:0,y:0,z:0}}:arguments[0],arguments.length<=1||void 0===arguments[1]?{}:arguments[1]);if(null==window.localStorage.getItem("vr_user")){e.x=utils.randomPos(-85,2),e.y=0,e.z=utils.randomPos(5,15);var t=null;t=null==this.user.name?utils.randomArr(this.fakeUser):this.user.name;try{window.localStorage.setItem("vr_user",t)}catch(s){alert("please allow local storage please disable private mode")}this.user={name:t,position:e,rotation:new BABYLON.Vector3(0,0,0),sprite:this.spriteImg,spriteID:utils.randomArr(this.spriteAnimations)},this.users.once("value",function(e){this.checkUsers(e)}.bind(this)),this.users=this.users.push(this.user),this.currentUserKey=this.users.key();try{window.localStorage.setItem("vr_user_key",this.currentUserKey)}catch(s){console.log(s)}}}},{key:"updateUser",value:function(e,t){this.sysInit&&(this.isCurrentlyUsing?this.userToUpdate.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}):null!=this.user.name&&this.users.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}))}},{key:"debug",value:function(){}}]),t}(CES.Component);module.exports=c_multiuser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUvbHNkL2NvbXBvbmVudHMvY19tdWx0aXVzZXIuanMiXSwibmFtZXMiOlsiX2NsYXNzQ2FsbENoZWNrIiwiaW5zdGFuY2UiLCJDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIl9pbmhlcml0cyIsInN1YkNsYXNzIiwic3VwZXJDbGFzcyIsInByb3RvdHlwZSIsIk9iamVjdCIsImNyZWF0ZSIsImNvbnN0cnVjdG9yIiwidmFsdWUiLCJlbnVtZXJhYmxlIiwid3JpdGFibGUiLCJjb25maWd1cmFibGUiLCJzZXRQcm90b3R5cGVPZiIsIl9fcHJvdG9fXyIsIl9jcmVhdGVDbGFzcyIsImRlZmluZVByb3BlcnRpZXMiLCJ0YXJnZXQiLCJwcm9wcyIsImkiLCJsZW5ndGgiLCJkZXNjcmlwdG9yIiwiZGVmaW5lUHJvcGVydHkiLCJrZXkiLCJwcm90b1Byb3BzIiwic3RhdGljUHJvcHMiLCJfZ2V0IiwiX3g0IiwiX3g1IiwiX3g2IiwiX2FnYWluIiwib2JqZWN0IiwicHJvcGVydHkiLCJyZWNlaXZlciIsIkZ1bmN0aW9uIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsInVuZGVmaW5lZCIsImdldHRlciIsImdldCIsImNhbGwiLCJwYXJlbnQiLCJnZXRQcm90b3R5cGVPZiIsIkNFUyIsInJlcXVpcmUiLCJCQUJZTE9OIiwidXRpbHMiLCJkZWZhdWx0cyIsImRlZmF1bHRBcmdzIiwiX25hbWUiLCJjX211bHRpdXNlciIsIl9DRVMkQ29tcG9uZW50IiwiX29wdHMiLCJhcmd1bWVudHMiLCJ0aGlzIiwibmFtZSIsImZpcmViYXNlUmVmIiwiX2ZiVVJMIiwic2NlbmUiLCJfc2NlbmUiLCJzeXNJbml0IiwidXNlckluaXQiLCJsb2FkU2NyaXB0Iiwic2V0TXVsdGlVc2VyRGF0YSIsImJpbmQiLCJtdWx0aXVzZXIiLCJGaXJlYmFzZSIsInVzZXJzIiwidXNlciIsInBvc2l0aW9uIiwieCIsInkiLCJ6Iiwicm90YXRpb24iLCJzcHJpdGUiLCJjdXJyZW50VXNlcnMiLCJmYWtlVXNlciIsInNwcml0ZUltZyIsInNwcml0ZXMiLCJBbGVydHMiLCJjdXJyZW50QWxlcnRzIiwiY3VycmVudFVzZXJLZXkiLCJleGVjdXRlVXNlclJlbW92YWwiLCJ1c2VyVG9VcGRhdGUiLCJzcHJpdGVBbmltYXRpb25zIiwiem9tYmllTW9kZSIsImlzQ3VycmVudGx5VXNpbmciLCJzcE1hbmFnZXIiLCJwbGF5ZXJTcHJpdGUiLCJzcHJpdGVJRCIsImluaXRTeXMiLCJzZXRVc2VyIiwiVmVjdG9yMyIsIlNwcml0ZU1hbmFnZXIiLCJsYXllck1hc2siLCJTcHJpdGUiLCJpc1BpY2thYmxlIiwicGxheUFuaW1hdGlvbiIsIk1hdGgiLCJhYnMiLCJwYXJzZUludCIsInB1c2giLCJ3aW5kb3ciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJvbiIsImFsZXJ0RGF0YSIsInZhbCIsIm9uY2UiLCJmb3JFYWNoIiwiZGF0YSIsInVzZXJEYXRhIiwiY2hlY2tVc2VycyIsInNldFRpbWVvdXQiLCJhZGRVc2VycyIsImdlbmVyYXRlVXNlclNwcml0ZXMiLCJ1c2VySGF2ZUxvYWRlZCIsImxvY2FsU3RvcmFnZSIsImdldEl0ZW0iLCJfZGF0YSIsIl9pZCIsInNwcml0ZU1hbmFnZXJSaWRlciIsInRleHR1cmUiLCJjbG9uZSIsInBsYXllciIsInNpemUiLCJfZGtleSIsInVzZXJSZWYiLCJmb3VudGFpbiIsIk1lc2giLCJDcmVhdGVCb3giLCJiYWJ5bG9uTW9kIiwiaXNWaXNpYmxlIiwicGFydGljbGVTeXN0ZW0iLCJQYXJ0aWNsZVN5c3RlbSIsInBhcnRpY2xlVGV4dHVyZSIsIlRleHR1cmUiLCJlbWl0dGVyIiwibWluRW1pdEJveCIsIm1heEVtaXRCb3giLCJjb2xvcjEiLCJDb2xvcjQiLCJjb2xvcjIiLCJjb2xvckRlYWQiLCJtaW5TaXplIiwibWF4U2l6ZSIsIm1pbkxpZmVUaW1lIiwibWF4TGlmZVRpbWUiLCJlbWl0UmF0ZSIsImJsZW5kTW9kZSIsIkJMRU5ETU9ERV9PTkVPTkUiLCJncmF2aXR5IiwiZGlyZWN0aW9uMSIsImRpcmVjdGlvbjIiLCJtaW5FbWl0UG93ZXIiLCJtYXhFbWl0UG93ZXIiLCJ1cGRhdGVTcGVlZCIsInN0YXJ0Iiwic3RvcCIsImRpc3Bvc2UiLCJzcHJpdGVNYW5hZ2VycyIsInJlbW92ZSIsImVycm9yT2JqZWN0IiwiY29uc29sZSIsImxvZyIsIl9wb3MiLCJyYW5kb21Qb3MiLCJfdXNlcm5hbWUiLCJyYW5kb21BcnIiLCJzZXRJdGVtIiwiZSIsImFsZXJ0Iiwic2V0IiwiQ29tcG9uZW50IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUEsWUFNQSxTQUFTQSxpQkFBZ0JDLEVBQVVDLEdBQWUsS0FBTUQsWUFBb0JDLElBQWdCLEtBQU0sSUFBSUMsV0FBVSxxQ0FFaEgsUUFBU0MsV0FBVUMsRUFBVUMsR0FBYyxHQUEwQixrQkFBZkEsSUFBNEMsT0FBZkEsRUFBdUIsS0FBTSxJQUFJSCxXQUFVLGlFQUFvRUcsR0FBZUQsR0FBU0UsVUFBWUMsT0FBT0MsT0FBT0gsR0FBY0EsRUFBV0MsV0FBYUcsYUFBZUMsTUFBT04sRUFBVU8sWUFBWSxFQUFPQyxVQUFVLEVBQU1DLGNBQWMsS0FBZVIsSUFBWUUsT0FBT08sZUFBaUJQLE9BQU9PLGVBQWVWLEVBQVVDLEdBQWNELEVBQVNXLFVBQVlWLEdBTmplLEdBQUlXLGNBQWUsV0FBZSxRQUFTQyxHQUFpQkMsRUFBUUMsR0FBUyxJQUFLLEdBQUlDLEdBQUksRUFBR0EsRUFBSUQsRUFBTUUsT0FBUUQsSUFBSyxDQUFFLEdBQUlFLEdBQWFILEVBQU1DLEVBQUlFLEdBQVdYLFdBQWFXLEVBQVdYLGFBQWMsRUFBT1csRUFBV1QsY0FBZSxFQUFVLFNBQVdTLEtBQVlBLEVBQVdWLFVBQVcsR0FBTUwsT0FBT2dCLGVBQWVMLEVBQVFJLEVBQVdFLElBQUtGLElBQWlCLE1BQU8sVUFBVXJCLEVBQWF3QixFQUFZQyxHQUFpSixNQUE5SEQsSUFBWVIsRUFBaUJoQixFQUFZSyxVQUFXbUIsR0FBaUJDLEdBQWFULEVBQWlCaEIsRUFB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QUtnQyxpQkFDTmhDLEtBQUs2QixhQUFhd0YsS0FBS3BILEtBQU1ELEtBQUtjLEtBQUtiLEtBQU1jLFNBQVVBLEVBQVVJLFNBQVVBLEVBQVVDLE9BQVFwQixLQUFLYyxLQUFLTSxPQUFTZSxTQUFVbkMsS0FBS2MsS0FBS3FCLFdBRS9HLE1BQWxCbkMsS0FBS2MsS0FBS2IsTUFDWEQsS0FBS2EsTUFBTXdHLEtBQUtwSCxLQUFNRCxLQUFLYyxLQUFLYixLQUFNYyxTQUFVQSxFQUFVSSxTQUFVQSxFQUFVQyxPQUFRcEIsS0FBS2MsS0FBS00sT0FBUWUsU0FBVW5DLEtBQUtjLEtBQUtxQixlQTZCbElsRSxJQUFLLFFBQ0xkLE1BeEJDLGdCQXZPRXlDLEdBQW9CUCxJQUFJaUksVUE2Ty9CQyxRQUFPQyxRQUFVNUgiLCJmaWxlIjoiY29yZS9sc2QvY29tcG9uZW50cy9jX211bHRpdXNlci5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBDRVMgPSByZXF1aXJlKCdDRVMnKTtcbnZhciBCQUJZTE9OID0gcmVxdWlyZSgnLi4vbGliL2JhYnlsb24nKTtcbnZhciB1dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzL3V0aWxzJyk7XG52YXIgZGVmYXVsdHMgPSB1dGlscy5kZWZhdWx0QXJncygpO1xuZGVmYXVsdHMuX25hbWUgPSAnbXVsdGl1c2VyJztcbi8qKlxuICogLi4uXG4gKiBAYXV0aG9yIEJyZW5kb24gU21pdGhcbiAqIGh0dHA6Ly9zZWFjbG91ZDkub3JnXG4gKiBMaWdodFdlaWdodCAzRCBTeXN0ZW0gRGVzaWduIGVuZ2luZVxuICovXG5cbiBjbGFzcyBjX211bHRpdXNlciBleHRlbmRzIENFUy5Db21wb25lbnR7XG4gIGNvbnN0cnVjdG9yKF9vcHRzID0gZGVmYXVsdHMpe1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5uYW1lID0gX29wdHMuX25hbWU7XG4gICAgdGhpcy5maXJlYmFzZVJlZiA9IF9vcHRzLl9mYlVSTDtcbiAgICB0aGlzLnNjZW5lID0gIF9vcHRzLl9zY2VuZTtcbiAgICB0aGlzLnN5c0luaXQgPSBmYWxzZTtcbiAgICB0aGlzLnVzZXJJbml0ID0gZmFsc2U7XG4gICAgdXRpbHMubG9hZFNjcmlwdChcImh0dHBzOi8vY2RuLmZpcmViYXNlLmNvbS9qcy9jbGllbnQvMi4zLjAvZmlyZWJhc2UuanNcIiwgdGhpcy5zZXRNdWx0aVVzZXJEYXRhLmJpbmQodGhpcykpO1xuICAgIFxuICB9XG5cbiAgc2V0TXVsdGlVc2VyRGF0YSgpe1xuICAgIHRoaXMubXVsdGl1c2VyID0gbmV3IEZpcmViYXNlKHRoaXMuZmlyZWJhc2VSZWYpO1xuICAgIHRoaXMudXNlcnMgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICd1c2VycycpO1xuICAgIHRoaXMudXNlciA9IHtuYW1lOm51bGwsIHBvc2l0aW9uOnt4OjAsIHk6MCwgejowfSwgcm90YXRpb246e3g6MCwgeTowLCB6OjB9LCBzcHJpdGU6bnVsbH07XG4gICAgdGhpcy5jdXJyZW50VXNlcnMgPSBbXTtcbiAgICB0aGlzLmZha2VVc2VyID0gWydUb20nLCdSaWNoYXJkJywnSmFuZScsJ0pvaG4nLCdEYW4nLCdKb3NoJywnQnJlbmRvbicsJ0VtbWEnLCdQZXRlciddO1xuICAgIHRoaXMuc3ByaXRlSW1nID0gJ2Fzc2V0cy9zcHJpdGVzL3VzZXJzLnBuZyc7XG4gICAgdGhpcy5zcHJpdGVzID0gW107XG4gICAgdGhpcy5BbGVydHMgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICdhbGVydHMnKTtcbiAgICB0aGlzLmN1cnJlbnRBbGVydHMgPSBbXTtcbiAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gbnVsbDtcbiAgICB0aGlzLmV4ZWN1dGVVc2VyUmVtb3ZhbCA9IG51bGw7XG4gICAgdGhpcy51c2VyVG9VcGRhdGUgPSAgdGhpcy5maXJlYmFzZVJlZisgJ3VzZXJzLyc7XG4gICAgdGhpcy5zcHJpdGVBbmltYXRpb25zID0gWzIwLDQwLDYwLDgwXTtcbiAgICB0aGlzLnpvbWJpZU1vZGUgPSBmYWxzZTtcbiAgICB0aGlzLmlzQ3VycmVudGx5VXNpbmcgID0gZmFsc2U7XG4gICAgdGhpcy5zcE1hbmFnZXIgPSBudWxsO1xuICAgIHRoaXMucGxheWVyU3ByaXRlID0gbnVsbDtcbiAgICB0aGlzLnNwcml0ZUlEID0gMjA7XG4gICAgdGhpcy5pbml0U3lzKCk7XG4gIH1cblxuICBpbml0U3lzKCl7XG5cbiAgICB0aGlzLnNldFVzZXIobnVsbCwgbmV3IEJBQllMT04uVmVjdG9yMygwLCAwLCAwKSk7XG5cbiAgICAvKlxuICAgIGlmKCAhIHRoaXMuYXBwLl9wbGF0Zm9ybS5pcygnYW5kcm9pZCcpICl7XG4gICAgICAgIHRoaXMuaHVkID0gbmV3IEJhcnRWUl9IZWFkc1VwRGlzcGxheSh0aGlzLnNjZW5lLCB0aGlzKTtcbiAgICB9XG4gICAgKi9cblxuICAgIHRoaXMuc3BNYW5hZ2VyICA9IG5ldyBCQUJZTE9OLlNwcml0ZU1hbmFnZXIoXCJ1c2VyTWFuYWdlclwiLCB0aGlzLnNwcml0ZUltZywgMTAwMCwgMTI4LCB0aGlzLnNjZW5lKTtcbiAgICB0aGlzLnNwTWFuYWdlci5sYXllck1hc2sgPSAzO1xuICAgIHRoaXMucGxheWVyU3ByaXRlID0gbmV3IEJBQllMT04uU3ByaXRlKFwicGxheWVyXCIsIHRoaXMuc3BNYW5hZ2VyICk7XG4gICAgdGhpcy5wbGF5ZXJTcHJpdGUuaXNQaWNrYWJsZSA9IHRydWU7XG5cbiAgIFxuXG4gICAgaWYodGhpcy56b21iaWVNb2RlKXtcbiAgICAgIHRoaXMucGxheWVyU3ByaXRlLnBsYXlBbmltYXRpb24oIDgwLCAgMTAwLCB0cnVlLCAxMDApO1xuICAgIH1lbHNle1xuICAgICAgdGhpcy5wbGF5ZXJTcHJpdGUucGxheUFuaW1hdGlvbihNYXRoLmFicyggMjAgLSB0aGlzLnVzZXIuc3ByaXRlSUQpLCAgcGFyc2VJbnQodGhpcy51c2VyLnNwcml0ZUlEKSwgdHJ1ZSwgMTAwKTtcbiAgICB9XG4gICAgLy90aGlzLnNjZW5lLmFjdGl2ZUNhbWVyYS5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjModGhpcy51c2VyLnBvc2l0aW9uLngsIHRoaXMudXNlci5wb3NpdGlvbi55LCB0aGlzLnVzZXIucG9zaXRpb24ueik7XG4gICAgdGhpcy5wbGF5ZXJTcHJpdGUucG9zaXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKHRoaXMudXNlci5wb3NpdGlvbi54LCB0aGlzLnVzZXIucG9zaXRpb24ueSwgdGhpcy51c2VyLnBvc2l0aW9uLnopO1xuICAgIC8vIHRoaXMuc2NlbmUuYWN0aXZlQ2FtZXJhLnJvdGF0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyh0aGlzLkRhdGEudXNlci5yb3RhdGlvbi54LCB0aGlzLkRhdGEudXNlci5yb3RhdGlvbi55LCB0aGlzLkRhdGEudXNlci5yb3RhdGlvbi56KTtcbiAgICB0aGlzLnNwcml0ZXMucHVzaCh7c3ByaXRlOnRoaXMucGxheWVyU3ByaXRlLCBrZXk6dGhpcy5jdXJyZW50VXNlcktleX0pO1xuXG4gICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7XG4gICAgdGhpcy5BbGVydHMub24oXCJjaGlsZF9hZGRlZFwiLCBmdW5jdGlvbihhbGVydERhdGEpIHtcbiAgICAgIHRoaXMuY3VycmVudEFsZXJ0cy5wdXNoKGFsZXJ0RGF0YS52YWwoKSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuQWxlcnRzLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbihhbGVydERhdGEpIHtcbiAgICAgIGFsZXJ0RGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50QWxlcnRzLnB1c2goZGF0YS52YWwoKSk7XG4gICAgICB9LmJpbmQodGhpcykpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLnVzZXJzLm9uKFwiY2hpbGRfY2hhbmdlZFwiLCBmdW5jdGlvbih1c2VyRGF0YSkge1xuICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY3VycmVudFVzZXJzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgaWYodXNlckRhdGEua2V5KCkgPT0gdGhpcy5jdXJyZW50VXNlcnNbaV0ua2V5KXtcbiAgICAgICAgIHRoaXMuY3VycmVudFVzZXJzW2ldLmRhdGEgPSAgdXNlckRhdGEudmFsKCk7XG4gICAgICAgfVxuICAgICB9XG4gICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy51c2Vycy5vbmNlKFwidmFsdWVcIiwgZnVuY3Rpb24odXNlckRhdGEpIHtcbiAgICAgICAgdGhpcy5jaGVja1VzZXJzKHVzZXJEYXRhKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5zeXNJbml0ID0gdHJ1ZTsgXG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgdGhpcy5hZGRVc2VycygpO1xuICAgIH0uYmluZCh0aGlzKSwgNTAwKTtcbiAgfS5iaW5kKHRoaXMpKTtcbn1cblxuYWRkVXNlcnMoKXtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5jdXJyZW50VXNlcnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZih0aGlzLmN1cnJlbnRVc2Vyc1tpXS5rZXkgIT0gdGhpcy5jdXJyZW50VXNlcktleSl7XG4gICAgICAgICAgICB0aGlzLmdlbmVyYXRlVXNlclNwcml0ZXModGhpcy5jdXJyZW50VXNlcnNbaV0sIGkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudXNlckluaXQgPSB0cnVlO1xufVxuXG5jaGVja1VzZXJzKHVzZXJEYXRhKXtcbiAgdmFyIHVzZXJIYXZlTG9hZGVkID0gZmFsc2U7XG4gICAgICB1c2VyRGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgaWYod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKFwidnJfdXNlcl9rZXlcIikgIT0gbnVsbCAmJiBkYXRhLmtleSgpID09IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInZyX3VzZXJfa2V5XCIpICl7XG4gICAgICAgICAgdGhpcy51c2VyID0gZGF0YS52YWwoKTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gZGF0YS5rZXkoKTtcbiAgICAgICAgICB0aGlzLnVzZXJUb1VwZGF0ZSArPSAgZGF0YS5rZXkoKTtcbiAgICAgICAgICB0aGlzLnVzZXJUb1VwZGF0ZSA9IG5ldyBGaXJlYmFzZSh0aGlzLnVzZXJUb1VwZGF0ZSk7XG4gICAgICAgICAgdGhpcy5pc0N1cnJlbnRseVVzaW5nID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZihkYXRhLnZhbCgpLm5hbWUgIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkucG9zaXRpb24gIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkucm90YXRpb24gIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkuc3ByaXRlICE9IHVuZGVmaW5lZCAmJiBkYXRhLnZhbCgpLnNwcml0ZUlEICE9IHVuZGVmaW5lZCl7XG4gICAgICAgICAgaWYoIXVzZXJIYXZlTG9hZGVkKXtcbiAgICAgICAgICAgICAgdXNlckhhdmVMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB1c2VyRGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFVzZXJzLnB1c2goe2RhdGE6ZGF0YS52YWwoKSwga2V5OiBkYXRhLmtleSgpfSk7XG4gICAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgICAgfSAgXG4gICAgICAgIH1cbiAgICAgIH0uYmluZCh0aGlzKSk7XG59XG5cbmdlbmVyYXRlVXNlclNwcml0ZXMoX2RhdGEsIF9pZCl7XG4gICAgdmFyIHNwcml0ZU1hbmFnZXJSaWRlciA9IG5ldyBCQUJZTE9OLlNwcml0ZU1hbmFnZXIoX2RhdGEua2V5LCBfZGF0YS5kYXRhLnNwcml0ZSwgMSwgMTI4LCB0aGlzLnNjZW5lKTtcbiAgICBzcHJpdGVNYW5hZ2VyUmlkZXIubGF5ZXJNYXNrID0gMztcbiAgICBzcHJpdGVNYW5hZ2VyUmlkZXIudGV4dHVyZSA9IHRoaXMuc3BNYW5hZ2VyLnRleHR1cmUuY2xvbmUoKTtcbiAgICBsZXQgcGxheWVyID0gbmV3IEJBQllMT04uU3ByaXRlKF9kYXRhLmtleSwgc3ByaXRlTWFuYWdlclJpZGVyICk7XG4gICAgcGxheWVyLmlzUGlja2FibGUgPSB0cnVlO1xuICAgIGlmKHR5cGVvZiAgX2RhdGEuZGF0YS5wb3NpdGlvbiAhPSB1bmRlZmluZWQpe1xuICAgICAgcGxheWVyLnBvc2l0aW9uID0gX2RhdGEuZGF0YS5wb3NpdGlvbjtcbiAgICB9ZWxzZXtcbiAgICAgIHBsYXllci5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjModGhpcy51c2VyLnBvc2l0aW9uLngsIHRoaXMudXNlci5wb3NpdGlvbi55LCB0aGlzLnVzZXIucG9zaXRpb24ueik7XG4gICAgfVxuICAgIC8vcGxheWVyLnJvdGF0aW9uID0gX2RhdGEuZGF0YS5yb3RhdGlvbjtcbiAgICBwbGF5ZXIuc2l6ZSA9IDE0LjA7XG4gICAgaWYoX2RhdGEuZGF0YS56b21iaWVNb2RlKXtcbiAgICAgICAgcGxheWVyLnBsYXlBbmltYXRpb24oIDgwLCAgMTAwLCB0cnVlLCAxMDApO1xuICAgIH1lbHNle1xuICAgICAgICBwbGF5ZXIucGxheUFuaW1hdGlvbihNYXRoLmFicyggMjAgLSBwYXJzZUludChfZGF0YS5kYXRhLnNwcml0ZUlEKSksICBwYXJzZUludChfZGF0YS5kYXRhLnNwcml0ZUlEKSwgdHJ1ZSwgMTAwKTtcbiAgICB9XG4gICAgdGhpcy5zcHJpdGVzLnB1c2goe3Nwcml0ZTpwbGF5ZXIsIGtleTpfZGF0YS5rZXl9KTtcbn1cblxuZGVsZXRlVXNlcihfZGtleSl7XG4gIHZhciB1c2VyUmVmID0gbmV3IEZpcmViYXNlKHRoaXMuZmlyZWJhc2VSZWYgKyAndXNlcnMvJyAgKyBfZGtleSk7XG4gIHVzZXJSZWYub25jZShcInZhbHVlXCIsIGZ1bmN0aW9uKF9kYXRhKSB7XG4gICAgdmFyIGZvdW50YWluID0gQkFCWUxPTi5NZXNoLkNyZWF0ZUJveChcImZvdXRhaW5cIiwgMS4wLCB0aGlzLmJhYnlsb25Nb2Quc2NlbmUpO1xuICAgIGZvdW50YWluLmlzVmlzaWJsZSA9IGZhbHNlO1xuICAgIGZvdW50YWluLnBvc2l0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyhfZGF0YS52YWwoKS5wb3NpdGlvbi54LCBfZGF0YS52YWwoKS5wb3NpdGlvbi55LCBfZGF0YS52YWwoKS5wb3NpdGlvbi56KVxuICAgIHZhciBwYXJ0aWNsZVN5c3RlbSA9IG5ldyBCQUJZTE9OLlBhcnRpY2xlU3lzdGVtKFwicGFydGljbGVzXCIsIDEwMDAsIHRoaXMuYmFieWxvbk1vZC5zY2VuZSk7XG4gICAgcGFydGljbGVTeXN0ZW0ucGFydGljbGVUZXh0dXJlID0gbmV3IEJBQllMT04uVGV4dHVyZShcImJhcnR2ci9pbWcvdGV4dHVyZXMvZmxhcmUucG5nXCIsIHRoaXMuYmFieWxvbk1vZC5zY2VuZSk7XG4gICAgcGFydGljbGVTeXN0ZW0uZW1pdHRlciA9IGZvdW50YWluOyAvLyB0aGUgc3RhcnRpbmcgb2JqZWN0LCB0aGUgZW1pdHRlclxuICAgIHBhcnRpY2xlU3lzdGVtLm1pbkVtaXRCb3ggPSBuZXcgQkFCWUxPTi5WZWN0b3IzKC0xLCAwLCAwKTsgLy8gU3RhcnRpbmcgYWxsIGZyb21cbiAgICBwYXJ0aWNsZVN5c3RlbS5tYXhFbWl0Qm94ID0gbmV3IEJBQllMT04uVmVjdG9yMygxLCAwLCAwKTsgLy8gVG8uLi5cbiAgICBwYXJ0aWNsZVN5c3RlbS5jb2xvcjEgPSBuZXcgQkFCWUxPTi5Db2xvcjQoMC43LCAwLjgsIDEuMCwgMS4wKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5jb2xvcjIgPSBuZXcgQkFCWUxPTi5Db2xvcjQoMC4yLCAwLjUsIDEuMCwgMS4wKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5jb2xvckRlYWQgPSBuZXcgQkFCWUxPTi5Db2xvcjQoMCwgMCwgMC4yLCAwLjApO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1pblNpemUgPSAwLjE7XG4gICAgcGFydGljbGVTeXN0ZW0ubWF4U2l6ZSA9IDAuNTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5taW5MaWZlVGltZSA9IDAuMTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5tYXhMaWZlVGltZSA9IDAuMztcbiAgICBwYXJ0aWNsZVN5c3RlbS5lbWl0UmF0ZSA9IDEwMDA7XG4gICAgcGFydGljbGVTeXN0ZW0uYmxlbmRNb2RlID0gQkFCWUxPTi5QYXJ0aWNsZVN5c3RlbS5CTEVORE1PREVfT05FT05FO1xuICAgIHBhcnRpY2xlU3lzdGVtLmdyYXZpdHkgPSBuZXcgQkFCWUxPTi5WZWN0b3IzKDAsIC05LjgxLCAwKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5kaXJlY3Rpb24xID0gbmV3IEJBQllMT04uVmVjdG9yMygtNCwgNiwgNCk7XG4gICAgcGFydGljbGVTeXN0ZW0uZGlyZWN0aW9uMiA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoNCwgNiwgLTQpO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1pbkVtaXRQb3dlciA9IDE7XG4gICAgcGFydGljbGVTeXN0ZW0ubWF4RW1pdFBvd2VyID0gMztcbiAgICBwYXJ0aWNsZVN5c3RlbS51cGRhdGVTcGVlZCA9IDAuMDA1O1xuICAgIHBhcnRpY2xlU3lzdGVtLnN0YXJ0KCk7XG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgcGFydGljbGVTeXN0ZW0uc3RvcCgpO1xuICAgICAgcGFydGljbGVTeXN0ZW0uZGlzcG9zZSgpO1xuICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuc2NlbmUuc3ByaXRlTWFuYWdlcnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZiggIHRoaXMuc2NlbmUuc3ByaXRlTWFuYWdlcnNbaV0ubmFtZSA9PSBfZGtleSl7XG4gICAgICAgICAgdGhpcy5zY2VuZS5zcHJpdGVNYW5hZ2Vyc1tpXS5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHVzZXJSZWYucmVtb3ZlKCk7XG4gICAgfS5iaW5kKHRoaXMpLCA1MDAwKTsgICAgICAgXG4gIH0uYmluZCh0aGlzKSwgZnVuY3Rpb24gKGVycm9yT2JqZWN0KSB7XG4gICBjb25zb2xlLmxvZyhlcnJvck9iamVjdCk7XG4gfSk7XG59XG5cbnNldFVzZXIoX3VzZXIgPSB7bmFtZTogJ3VzZXJOYW1lJywgcG9zaXRpb246IHt4OjAsIHk6MCwgejowfX0sIF9wb3MgPSB7fSApe1xuICBpZih3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJ2cl91c2VyXCIpID09IG51bGwpe1xuICAgIF9wb3MueCA9IHV0aWxzLnJhbmRvbVBvcygtODUsIDIpO1xuICAgIF9wb3MueSA9IDA7XG4gICAgX3Bvcy56ID0gdXRpbHMucmFuZG9tUG9zKDUsIDE1KTtcbiAgICB2YXIgX3VzZXJuYW1lID0gbnVsbDtcbiAgICBpZih0aGlzLnVzZXIubmFtZSA9PSBudWxsKXtcbiAgICAgIF91c2VybmFtZSA9ICB1dGlscy5yYW5kb21BcnIodGhpcy5mYWtlVXNlcik7XG4gICAgfWVsc2V7XG4gICAgICBfdXNlcm5hbWUgPSB0aGlzLnVzZXIubmFtZTtcbiAgICB9XG4gICAgdHJ5e1xuICAgICAgd2luZG93LmxvY2FsU3RvcmFnZS5zZXRJdGVtKFwidnJfdXNlclwiLCBfdXNlcm5hbWUpO1xuICAgIH1jYXRjaChlKXtcbiAgICAgIGFsZXJ0KCdwbGVhc2UgYWxsb3cgbG9jYWwgc3RvcmFnZSBwbGVhc2UgZGlzYWJsZSBwcml2YXRlIG1vZGUnKTtcbiAgICB9XG4gICAgdGhpcy51c2VyID0ge25hbWU6X3VzZXJuYW1lLCBwb3NpdGlvbjogX3Bvcywgcm90YXRpb246IG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMCwgMCksIHNwcml0ZTp0aGlzLnNwcml0ZUltZywgc3ByaXRlSUQ6IHV0aWxzLnJhbmRvbUFycih0aGlzLnNwcml0ZUFuaW1hdGlvbnMpIH07XG5cbiAgICB0aGlzLnVzZXJzLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbih1c2VyRGF0YSkge1xuICAgICAgICB0aGlzLmNoZWNrVXNlcnModXNlckRhdGEpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cblxuICAgIHRoaXMudXNlcnMgPSB0aGlzLnVzZXJzLnB1c2goIHRoaXMudXNlcik7ICBcbiAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gdGhpcy51c2Vycy5rZXkoKTtcbiAgICB0cnl7XG4gICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ2cl91c2VyX2tleVwiLCB0aGlzLmN1cnJlbnRVc2VyS2V5ICk7XG4gICAgfWNhdGNoKGUpe1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICB9XG5cbiAgfVxufVxuXG5cbnVwZGF0ZVVzZXIocG9zaXRpb24sIHJvdGF0aW9uKXtcbiAgaWYodGhpcy5zeXNJbml0KXtcbiAgICAgIGlmKHRoaXMuaXNDdXJyZW50bHlVc2luZyl7XG4gICAgICAgIHRoaXMudXNlclRvVXBkYXRlLnNldCh7bmFtZTogdGhpcy51c2VyLm5hbWUsIHBvc2l0aW9uOiBwb3NpdGlvbiwgcm90YXRpb246IHJvdGF0aW9uLCBzcHJpdGU6IHRoaXMudXNlci5zcHJpdGUsICBzcHJpdGVJRDogdGhpcy51c2VyLnNwcml0ZUlEIH0pO1xuICAgICAgfWVsc2V7XG4gICAgICAgIGlmKHRoaXMudXNlci5uYW1lICE9IG51bGwpe1xuICAgICAgICAgIHRoaXMudXNlcnMuc2V0KHtuYW1lOiB0aGlzLnVzZXIubmFtZSwgcG9zaXRpb246IHBvc2l0aW9uLCByb3RhdGlvbjogcm90YXRpb24sIHNwcml0ZTogdGhpcy51c2VyLnNwcml0ZSwgc3ByaXRlSUQ6IHRoaXMudXNlci5zcHJpdGVJRCB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICB9XG59XG5cbmRlYnVnKCl7XG5cbn1cblxuXG59XG5tb2R1bGUuZXhwb3J0cyA9IGNfbXVsdGl1c2VyOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==