"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t["default"]=e,t}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),_get=function(e,t,s){for(var i=!0;i;){var r=e,n=t,a=s;i=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,n);if(void 0!==o){if("value"in o)return o.value;var u=o.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(r);if(null===l)return void 0;e=l,t=n,s=a,i=!0,o=l=void 0}},_ces=require("ces"),CES=_interopRequireWildcard(_ces),_utilsUtils=require("../utils/utils"),_libBabylon=require("../lib/babylon");Object.defineProperty(exports,"BABYLON",{enumerable:!0,get:function(){return _libBabylon.BABYLON}});var defaults=_utilsUtils.utils.defaultArgs();defaults._name="multiuser";var c_multiuser=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?defaults:arguments[0];_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.name=e._name,this.firebaseRef=e._fbURL,this.scene=e._scene,this.sysInit=!1,this.userInit=!1,_utilsUtils.utils.loadScript("https://cdn.firebase.com/js/client/2.3.0/firebase.js",this.setMultiUserData.bind(this))}return _inherits(t,e),_createClass(t,[{key:"setMultiUserData",value:function(){this.multiuser=new Firebase(this.firebaseRef),this.users=new Firebase(this.firebaseRef+"users"),this.user={name:null,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},sprite:null},this.currentUsers=[],this.fakeUser=["Tom","Richard","Jane","John","Dan","Josh","Brendon","Emma","Peter"],this.spriteImg="assets/sprites/users.png",this.sprites=[],this.Alerts=new Firebase(this.firebaseRef+"alerts"),this.currentAlerts=[],this.currentUserKey=null,this.executeUserRemoval=null,this.userToUpdate=this.firebaseRef+"users/",this.spriteAnimations=[20,40,60,80],this.zombieMode=!1,this.isCurrentlyUsing=!1,this.spManager=null,this.playerSprite=null,this.spriteID=20,this.initSys()}},{key:"initSys",value:function(){this.setUser(null,new BABYLON.Vector3(0,0,0)),this.spManager=new BABYLON.SpriteManager("userManager",this.spriteImg,1e3,128,this.scene),this.spManager.layerMask=3,this.playerSprite=new BABYLON.Sprite("player",this.spManager),this.playerSprite.isPickable=!0,this.zombieMode?this.playerSprite.playAnimation(80,100,!0,100):this.playerSprite.playAnimation(Math.abs(20-this.user.spriteID),parseInt(this.user.spriteID),!0,100),this.playerSprite.position=new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),this.sprites.push({sprite:this.playerSprite,key:this.currentUserKey}),window.requestAnimationFrame(function(){this.Alerts.on("child_added",function(e){this.currentAlerts.push(e.val())}.bind(this)),this.Alerts.once("value",function(e){e.forEach(function(e){this.currentAlerts.push(e.val())}.bind(this))}.bind(this)),this.users.on("child_changed",function(e){for(var t=0;t<this.currentUsers.length;t++)e.key()==this.currentUsers[t].key&&(this.currentUsers[t].data=e.val())}.bind(this)),this.users.once("value",function(e){this.checkUsers(e)}.bind(this)),this.sysInit=!0,setTimeout(function(){this.addUsers()}.bind(this),500)}.bind(this))}},{key:"addUsers",value:function(){for(var e=0;e<this.currentUsers.length;e++)this.currentUsers[e].key!=this.currentUserKey&&this.generateUserSprites(this.currentUsers[e],e);this.userInit=!0}},{key:"checkUsers",value:function(e){var t=!1;e.forEach(function(s){null!=window.localStorage.getItem("vr_user_key")&&s.key()==window.localStorage.getItem("vr_user_key")&&(this.user=s.val(),this.currentUserKey=s.key(),this.userToUpdate+=s.key(),this.userToUpdate=new Firebase(this.userToUpdate),this.isCurrentlyUsing=!0),void 0!=s.val().name&&void 0!=s.val().position&&void 0!=s.val().rotation&&void 0!=s.val().sprite&&void 0!=s.val().spriteID&&(t||(t=!0,e.forEach(function(e){this.currentUsers.push({data:e.val(),key:e.key()})}.bind(this))))}.bind(this))}},{key:"generateUserSprites",value:function(e,t){var s=new BABYLON.SpriteManager(e.key,e.data.sprite,1,128,this.scene);s.layerMask=3,s.texture=this.spManager.texture.clone();var i=new BABYLON.Sprite(e.key,s);i.isPickable=!0,i.position=void 0!=typeof e.data.position?e.data.position:new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),i.size=14,e.data.zombieMode?i.playAnimation(80,100,!0,100):i.playAnimation(Math.abs(20-parseInt(e.data.spriteID)),parseInt(e.data.spriteID),!0,100),this.sprites.push({sprite:i,key:e.key})}},{key:"deleteUser",value:function(e){var t=new Firebase(this.firebaseRef+"users/"+e);t.once("value",function(s){var i=BABYLON.Mesh.CreateBox("foutain",1,this.babylonMod.scene);i.isVisible=!1,i.position=new BABYLON.Vector3(s.val().position.x,s.val().position.y,s.val().position.z);var r=new BABYLON.ParticleSystem("particles",1e3,this.babylonMod.scene);r.particleTexture=new BABYLON.Texture("bartvr/img/textures/flare.png",this.babylonMod.scene),r.emitter=i,r.minEmitBox=new BABYLON.Vector3(-1,0,0),r.maxEmitBox=new BABYLON.Vector3(1,0,0),r.color1=new BABYLON.Color4(.7,.8,1,1),r.color2=new BABYLON.Color4(.2,.5,1,1),r.colorDead=new BABYLON.Color4(0,0,.2,0),r.minSize=.1,r.maxSize=.5,r.minLifeTime=.1,r.maxLifeTime=.3,r.emitRate=1e3,r.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,r.gravity=new BABYLON.Vector3(0,-9.81,0),r.direction1=new BABYLON.Vector3(-4,6,4),r.direction2=new BABYLON.Vector3(4,6,-4),r.minEmitPower=1,r.maxEmitPower=3,r.updateSpeed=.005,r.start(),setTimeout(function(){r.stop(),r.dispose();for(var s=0;s<this.scene.spriteManagers.length;s++)this.scene.spriteManagers[s].name==e&&this.scene.spriteManagers[s].dispose();t.remove()}.bind(this),5e3)}.bind(this),function(e){console.log(e)})}},{key:"setUser",value:function(){var e=(arguments.length<=0||void 0===arguments[0]?{name:"userName",position:{x:0,y:0,z:0}}:arguments[0],arguments.length<=1||void 0===arguments[1]?{}:arguments[1]);if(null==window.localStorage.getItem("vr_user")){e.x=_utilsUtils.utils.randomPos(-85,2),e.y=0,e.z=_utilsUtils.utils.randomPos(5,15);var t=null;t=null==this.user.name?_utilsUtils.utils.randomArr(this.fakeUser):this.user.name;try{window.localStorage.setItem("vr_user",t)}catch(s){alert("please allow local storage please disable private mode")}this.user={name:t,position:e,rotation:new BABYLON.Vector3(0,0,0),sprite:this.spriteImg,spriteID:_utilsUtils.utils.randomArr(this.spriteAnimations)},this.users.once("value",function(e){this.checkUsers(e)}.bind(this)),this.users=this.users.push(this.user),this.currentUserKey=this.users.key();try{window.localStorage.setItem("vr_user_key",this.currentUserKey)}catch(s){console.log(s)}}}},{key:"updateUser",value:function(e,t){this.sysInit&&(this.isCurrentlyUsing?this.userToUpdate.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}):null!=this.user.name&&this.users.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}))}},{key:"debug",value:function(){}}]),t}(CES.Component);exports.c_multiuser=c_multiuser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUvbHNkL2NvbXBvbmVudHMvY19tdWx0aXVzZXIuanMiXSwibmFtZXMiOlsiX2ludGVyb3BSZXF1aXJlV2lsZGNhcmQiLCJvYmoiLCJfX2VzTW9kdWxlIiwibmV3T2JqIiwia2V5IiwiT2JqZWN0IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJjYWxsIiwiX2NsYXNzQ2FsbENoZWNrIiwiaW5zdGFuY2UiLCJDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIl9pbmhlcml0cyIsInN1YkNsYXNzIiwic3VwZXJDbGFzcyIsImNyZWF0ZSIsImNvbnN0cnVjdG9yIiwidmFsdWUiLCJlbnVtZXJhYmxlIiwid3JpdGFibGUiLCJjb25maWd1cmFibGUiLCJzZXRQcm90b3R5cGVPZiIsIl9fcHJvdG9fXyIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsIl9jcmVhdGVDbGFzcyIsImRlZmluZVByb3BlcnRpZXMiLCJ0YXJnZXQiLCJwcm9wcyIsImkiLCJsZW5ndGgiLCJkZXNjcmlwdG9yIiwicHJvdG9Qcm9wcyIsInN0YXRpY1Byb3BzIiwiX2dldCIsIl94NCIsIl94NSIsIl94NiIsIl9hZ2FpbiIsIm9iamVjdCIsInByb3BlcnR5IiwicmVjZWl2ZXIiLCJGdW5jdGlvbiIsImRlc2MiLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJ1bmRlZmluZWQiLCJnZXR0ZXIiLCJnZXQiLCJwYXJlbnQiLCJnZXRQcm90b3R5cGVPZiIsIl9jZXMiLCJyZXF1aXJlIiwiQ0VTIiwiX3V0aWxzVXRpbHMiLCJfbGliQmFieWxvbiIsIkJBQllMT04iLCJkZWZhdWx0cyIsInV0aWxzIiwiZGVmYXVsdEFyZ3MiLCJfbmFtZSIsImNfbXVsdGl1c2VyIiwiX0NFUyRDb21wb25lbnQiLCJfb3B0cyIsImFyZ3VtZW50cyIsInRoaXMiLCJuYW1lIiwiZmlyZWJhc2VSZWYiLCJfZmJVUkwiLCJzY2VuZSIsIl9zY2VuZSIsInN5c0luaXQiLCJ1c2VySW5pdCIsImxvYWRTY3JpcHQiLCJzZXRNdWx0aVVzZXJEYXRhIiwiYmluZCIsIm11bHRpdXNlciIsIkZpcmViYXNlIiwidXNlcnMiLCJ1c2VyIiwicG9zaXRpb24iLCJ4IiwieSIsInoiLCJyb3RhdGlvbiIsInNwcml0ZSIsImN1cnJlbnRVc2VycyIsImZha2VVc2VyIiwic3ByaXRlSW1nIiwic3ByaXRlcyIsIkFsZXJ0cyIsImN1cnJlbnRBbGVydHMiLCJjdXJyZW50VXNlcktleSIsImV4ZWN1dGVVc2VyUmVtb3ZhbCIsInVzZXJUb1VwZGF0ZSIsInNwcml0ZUFuaW1hdGlvbnMiLCJ6b21iaWVNb2RlIiwiaXNDdXJyZW50bHlVc2luZyIsInNwTWFuYWdlciIsInBsYXllclNwcml0ZSIsInNwcml0ZUlEIiwiaW5pdFN5cyIsInNldFVzZXIiLCJWZWN0b3IzIiwiU3ByaXRlTWFuYWdlciIsImxheWVyTWFzayIsIlNwcml0ZSIsImlzUGlja2FibGUiLCJwbGF5QW5pbWF0aW9uIiwiTWF0aCIsImFicyIsInBhcnNlSW50IiwicHVzaCIsIndpbmRvdyIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsIm9uIiwiYWxlcnREYXRhIiwidmFsIiwib25jZSIsImZvckVhY2giLCJkYXRhIiwidXNlckRhdGEiLCJjaGVja1VzZXJzIiwic2V0VGltZW91dCIsImFkZFVzZXJzIiwiZ2VuZXJhdGVVc2VyU3ByaXRlcyIsInVzZXJIYXZlTG9hZGVkIiwibG9jYWxTdG9yYWdlIiwiZ2V0SXRlbSIsIl9kYXRhIiwiX2lkIiwic3ByaXRlTWFuYWdlclJpZGVyIiwidGV4dHVyZSIsImNsb25lIiwicGxheWVyIiwic2l6ZSIsIl9ka2V5IiwidXNlclJlZiIsImZvdW50YWluIiwiTWVzaCIsIkNyZWF0ZUJveCIsImJhYnlsb25Nb2QiLCJpc1Zpc2libGUiLCJwYXJ0aWNsZVN5c3RlbSIsIlBhcnRpY2xlU3lzdGVtIiwicGFydGljbGVUZXh0dXJlIiwiVGV4dHVyZSIsImVtaXR0ZXIiLCJtaW5FbWl0Qm94IiwibWF4RW1pdEJveCIsImNvbG9yMSIsIkNvbG9yNCIsImNvbG9yMiIsImNvbG9yRGVhZCIsIm1pblNpemUiLCJtYXhTaXplIiwibWluTGlmZVRpbWUiLCJtYXhMaWZlVGltZSIsImVtaXRSYXRlIiwiYmxlbmRNb2RlIiwiQkxFTkRNT0RFX09ORU9ORSIsImdyYXZpdHkiLCJkaXJlY3Rpb24xIiwiZGlyZWN0aW9uMiIsIm1pbkVtaXRQb3dlciIsIm1heEVtaXRQb3dlciIsInVwZGF0ZVNwZWVkIiwic3RhcnQiLCJzdG9wIiwiZGlzcG9zZSIsInNwcml0ZU1hbmFnZXJzIiwicmVtb3ZlIiwiZXJyb3JPYmplY3QiLCJjb25zb2xlIiwibG9nIiwiX3BvcyIsInJhbmRvbVBvcyIsIl91c2VybmFtZSIsInJhbmRvbUFyciIsInNldEl0ZW0iLCJlIiwiYWxlcnQiLCJzZXQiLCJDb21wb25lbnQiXSwibWFwcGluZ3MiOiJBQUFBLFlBVUEsU0FBU0EseUJBQXdCQyxHQUFPLEdBQUlBLEdBQU9BLEVBQUlDLFdBQWMsTUFBT0QsRUFBYyxJQUFJRSxLQUFhLElBQVcsTUFBUEYsRUFBZSxJQUFLLEdBQUlHLEtBQU9ILEdBQVdJLE9BQU9DLFVBQVVDLGVBQWVDLEtBQUtQLEVBQUtHLEtBQU1ELEVBQU9DLEdBQU9ILEVBQUlHLEdBQW1DLE9BQXpCRCxHQUFPLFdBQWFGLEVBQVlFLEVBRXJRLFFBQVNNLGlCQUFnQkMsRUFBVUMsR0FBZSxLQUFNRCxZQUFvQkMsSUFBZ0IsS0FBTSxJQUFJQyxXQUFVLHFDQUVoSCxRQUFTQyxXQUFVQyxFQUFVQyxHQUFjLEdBQTBCLGtCQUFmQSxJQUE0QyxPQUFmQSxFQUF1QixLQUFNLElBQUlILFdBQVUsaUVBQW9FRyxHQUFlRCxHQUFTUixVQUFZRCxPQUFPVyxPQUFPRCxHQUFjQSxFQUFXVCxXQUFhVyxhQUFlQyxNQUFPSixFQUFVSyxZQUFZLEVBQU9DLFVBQVUsRUFBTUMsY0FBYyxLQUFlTixJQUFZVixPQUFPaUIsZUFBaUJqQixPQUFPaUIsZUFBZVIsRUFBVUMsR0FBY0QsRUFBU1MsVUFBWVIsR0FaamVWLE9BQU9tQixlQUFlQyxRQUFTLGNBQzdCUCxPQUFPLEdBR1QsSUFBSVEsY0FBZSxXQUFlLFFBQVNDLEdBQWlCQyxFQUFRQyxHQUFTLElBQUssR0FBSUMsR0FBSSxFQUFHQSxFQUFJRCxFQUFNRSxPQUFRRCxJQUFLLENBQUUsR0FBSUUsR0FBYUgsRUFBTUMsRUFBSUUsR0FBV2IsV0FBYWEsRUFBV2IsYUFBYyxFQUFPYSxFQUFXWCxjQUFlLEVBQVUsU0FBV1csS0FBWUEsRUFBV1osVUFBVyxHQUFNZixPQUFPbUIsZUFBZUksRUFBUUksRUFBVzVCLElBQUs0QixJQUFpQixNQUFPLFVBQVVyQixFQUFhc0IsRUFBWUMsR0FBaUosTUFBOUhELElBQVlOLEVBQWlCaEIsRUFBWUwsVUFBVzJCLEdBQWlCQyxHQUFhUCxFQUFpQmhCLEVBQWF1QixHQUFxQnZCLE1BRTdoQndCLEtBQU8sU0FBYUMsRUFBS0MsRUFBS0MsR0FBcUMsSUFBOUIsR0FBSUMsSUFBUyxFQUF3QkEsR0FBUSxDQUFFLEdBQUlDLEdBQVNKLEVBQUtLLEVBQVdKLEVBQUtLLEVBQVdKLENBQUtDLElBQVMsRUFBc0IsT0FBWEMsSUFBaUJBLEVBQVNHLFNBQVNyQyxVQUFXLElBQUlzQyxHQUFPdkMsT0FBT3dDLHlCQUF5QkwsRUFBUUMsRUFBVyxJQUFhSyxTQUFURixFQUFKLENBQTZPLEdBQUksU0FBV0EsR0FBUSxNQUFPQSxHQUFLMUIsS0FBZ0IsSUFBSTZCLEdBQVNILEVBQUtJLEdBQUssT0FBZUYsVUFBWEMsRUFBK0JELE9BQW9CQyxFQUFPdkMsS0FBS2tDLEdBQWhXLEdBQUlPLEdBQVM1QyxPQUFPNkMsZUFBZVYsRUFBUyxJQUFlLE9BQVhTLEVBQW1CLE1BQU9ILE9BQW9CVixHQUFNYSxFQUFRWixFQUFNSSxFQUFVSCxFQUFNSSxFQUFVSCxHQUFTLEVBQU1LLEVBQU9LLEVBQVNILFNBUTNjSyxLQUFPQyxRQWhCVSxPQUFUQyxJQUFHckQsd0JBQUFtRCxNQW9CWEcsWUFBY0YsUUFsQkksa0JBb0JsQkcsWUFBY0gsUUFyQk0saUJBdUJ4Qi9DLFFBQU9tQixlQUFlQyxRQUFTLFdBQzdCTixZQUFZLEVBQ1o2QixJQUFLLFdBQ0gsTUFBT08sYUExQkZDLFVBRVQsSUFBSUMsVUFBV0gsWUFBQUksTUFBTUMsYUFDckJGLFVBQVNHLE1BQVEsV0FxQ2pCLElBNUJjQyxhQUFXLFNBQUFDLEdBQ1osUUFEQ0QsS0FnQ1YsR0EvQlVFLEdBQUtDLFVBQUFqQyxRQUFBLEdBQUFlLFNBQUFrQixVQUFBLEdBQUdQLFNBQVFPLFVBQUEsRUFpQzFCdkQsaUJBQWdCd0QsS0FsQ05KLEdBRVYxQixLQUFBOUIsT0FBQTZDLGVBRlVXLEVBQVd2RCxXQUFBLGNBQUEyRCxNQUFBekQsS0FBQXlELE1BR3JCQSxLQUFLQyxLQUFPSCxFQUFNSCxNQUNsQkssS0FBS0UsWUFBY0osRUFBTUssT0FDekJILEtBQUtJLE1BQVNOLEVBQU1PLE9BQ3BCTCxLQUFLTSxTQUFVLEVBQ2ZOLEtBQUtPLFVBQVcsRUFDaEJsQixZQUFBSSxNQUFNZSxXQUFXLHVEQUF3RFIsS0FBS1MsaUJBQWlCQyxLQUFLVixPQTRRdEcsTUF2UEFwRCxXQTdCWWdELEVBQVdDLEdBNkN2QnBDLGFBN0NZbUMsSUE4Q1Z6RCxJQUFLLG1CQUNMYyxNQW5DYyxXQUNkK0MsS0FBS1csVUFBWSxHQUFJQyxVQUFTWixLQUFLRSxhQUNuQ0YsS0FBS2EsTUFBUSxHQUFJRCxVQUFTWixLQUFLRSxZQUFjLFNBQzdDRixLQUFLYyxNQUFRYixLQUFLLEtBQU1jLFVBQVVDLEVBQUUsRUFBR0MsRUFBRSxFQUFHQyxFQUFFLEdBQUlDLFVBQVVILEVBQUUsRUFBR0MsRUFBRSxFQUFHQyxFQUFFLEdBQUlFLE9BQU8sTUFDbkZwQixLQUFLcUIsZ0JBQ0xyQixLQUFLc0IsVUFBWSxNQUFNLFVBQVUsT0FBTyxPQUFPLE1BQU0sT0FBTyxVQUFVLE9BQU8sU0FDN0V0QixLQUFLdUIsVUFBWSwyQkFDakJ2QixLQUFLd0IsV0FDTHhCLEtBQUt5QixPQUFTLEdBQUliLFVBQVNaLEtBQUtFLFlBQWMsVUFDOUNGLEtBQUswQixpQkFDTDFCLEtBQUsyQixlQUFpQixLQUN0QjNCLEtBQUs0QixtQkFBcUIsS0FDMUI1QixLQUFLNkIsYUFBZ0I3QixLQUFLRSxZQUFhLFNBQ3ZDRixLQUFLOEIsa0JBQW9CLEdBQUcsR0FBRyxHQUFHLElBQ2xDOUIsS0FBSytCLFlBQWEsRUFDbEIvQixLQUFLZ0Msa0JBQW9CLEVBQ3pCaEMsS0FBS2lDLFVBQVksS0FDakJqQyxLQUFLa0MsYUFBZSxLQUNwQmxDLEtBQUttQyxTQUFXLEdBQ2hCbkMsS0FBS29DLGFBc0NMakcsSUFBSyxVQUNMYyxNQXBDSyxXQUVMK0MsS0FBS3FDLFFBQVEsS0FBTSxHQUFJOUMsU0FBUStDLFFBQVEsRUFBRyxFQUFHLElBUTdDdEMsS0FBS2lDLFVBQWEsR0FBSTFDLFNBQVFnRCxjQUFjLGNBQWV2QyxLQUFLdUIsVUFBVyxJQUFNLElBQUt2QixLQUFLSSxPQUMzRkosS0FBS2lDLFVBQVVPLFVBQVksRUFDM0J4QyxLQUFLa0MsYUFBZSxHQUFJM0MsU0FBUWtELE9BQU8sU0FBVXpDLEtBQUtpQyxXQUN0RGpDLEtBQUtrQyxhQUFhUSxZQUFhLEVBSTVCMUMsS0FBSytCLFdBQ04vQixLQUFLa0MsYUFBYVMsY0FBZSxHQUFLLEtBQUssRUFBTSxLQUVqRDNDLEtBQUtrQyxhQUFhUyxjQUFjQyxLQUFLQyxJQUFLLEdBQUs3QyxLQUFLYyxLQUFLcUIsVUFBWVcsU0FBUzlDLEtBQUtjLEtBQUtxQixXQUFXLEVBQU0sS0FHM0duQyxLQUFLa0MsYUFBYW5CLFNBQVcsR0FBSXhCLFNBQVErQyxRQUFRdEMsS0FBS2MsS0FBS0MsU0FBU0MsRUFBR2hCLEtBQUtjLEtBQUtDLFNBQVNFLEVBQUdqQixLQUFLYyxLQUFLQyxTQUFTRyxHQUVoSGxCLEtBQUt3QixRQUFRdUIsTUFBTTNCLE9BQU9wQixLQUFLa0MsYUFBYy9GLElBQUk2RCxLQUFLMkIsaUJBRXZEcUIsT0FBT0Msc0JBQXNCLFdBQzVCakQsS0FBS3lCLE9BQU95QixHQUFHLGNBQWUsU0FBU0MsR0FDckNuRCxLQUFLMEIsY0FBY3FCLEtBQUtJLEVBQVVDLFFBQ2xDMUMsS0FBS1YsT0FFUEEsS0FBS3lCLE9BQU80QixLQUFLLFFBQVMsU0FBU0YsR0FDakNBLEVBQVVHLFFBQVEsU0FBU0MsR0FDekJ2RCxLQUFLMEIsY0FBY3FCLEtBQUtRLEVBQUtILFFBQzdCMUMsS0FBS1YsUUFDUFUsS0FBS1YsT0FFUEEsS0FBS2EsTUFBTXFDLEdBQUcsZ0JBQWlCLFNBQVNNLEdBQ3RDLElBQUksR0FBSTNGLEdBQUksRUFBR0EsRUFBSW1DLEtBQUtxQixhQUFhdkQsT0FBUUQsSUFDeEMyRixFQUFTckgsT0FBUzZELEtBQUtxQixhQUFheEQsR0FBRzFCLE1BQ3pDNkQsS0FBS3FCLGFBQWF4RCxHQUFHMEYsS0FBUUMsRUFBU0osUUFHMUMxQyxLQUFLVixPQUVOQSxLQUFLYSxNQUFNd0MsS0FBSyxRQUFTLFNBQVNHLEdBQzlCeEQsS0FBS3lELFdBQVdELElBQ2xCOUMsS0FBS1YsT0FFUEEsS0FBS00sU0FBVSxFQUNmb0QsV0FBVyxXQUNUMUQsS0FBSzJELFlBQ0xqRCxLQUFLVixNQUFPLE1BQ2RVLEtBQUtWLFVBcUNMN0QsSUFBSyxXQUNMYyxNQW5DSSxXQUNKLElBQUksR0FBSVksR0FBSSxFQUFHQSxFQUFJbUMsS0FBS3FCLGFBQWF2RCxPQUFRRCxJQUN0Q21DLEtBQUtxQixhQUFheEQsR0FBRzFCLEtBQU82RCxLQUFLMkIsZ0JBQ2hDM0IsS0FBSzRELG9CQUFvQjVELEtBQUtxQixhQUFheEQsR0FBSUEsRUFHdkRtQyxNQUFLTyxVQUFXLEtBc0NoQnBFLElBQUssYUFDTGMsTUFwQ00sU0FBQ3VHLEdBQ1QsR0FBSUssSUFBaUIsQ0FDakJMLEdBQVNGLFFBQVEsU0FBU0MsR0FDeUIsTUFBOUNQLE9BQU9jLGFBQWFDLFFBQVEsZ0JBQTBCUixFQUFLcEgsT0FBUzZHLE9BQU9jLGFBQWFDLFFBQVEsaUJBQ2pHL0QsS0FBS2MsS0FBT3lDLEVBQUtILE1BQ2pCcEQsS0FBSzJCLGVBQWlCNEIsRUFBS3BILE1BQzNCNkQsS0FBSzZCLGNBQWlCMEIsRUFBS3BILE1BQzNCNkQsS0FBSzZCLGFBQWUsR0FBSWpCLFVBQVNaLEtBQUs2QixjQUN0QzdCLEtBQUtnQyxrQkFBbUIsR0FFSm5ELFFBQW5CMEUsRUFBS0gsTUFBTW5ELE1BQTRDcEIsUUFBdkIwRSxFQUFLSCxNQUFNckMsVUFBZ0RsQyxRQUF2QjBFLEVBQUtILE1BQU1qQyxVQUE4Q3RDLFFBQXJCMEUsRUFBS0gsTUFBTWhDLFFBQThDdkMsUUFBdkIwRSxFQUFLSCxNQUFNakIsV0FDbEowQixJQUNBQSxHQUFpQixFQUNqQkwsRUFBU0YsUUFBUSxTQUFTQyxHQUN6QnZELEtBQUtxQixhQUFhMEIsTUFBTVEsS0FBS0EsRUFBS0gsTUFBT2pILElBQUtvSCxFQUFLcEgsU0FDbER1RSxLQUFLVixVQUdiVSxLQUFLVixVQXVDVDdELElBQUssc0JBQ0xjLE1BckNlLFNBQUMrRyxFQUFPQyxHQUN2QixHQUFJQyxHQUFxQixHQUFJM0UsU0FBUWdELGNBQWN5QixFQUFNN0gsSUFBSzZILEVBQU1ULEtBQUtuQyxPQUFRLEVBQUcsSUFBS3BCLEtBQUtJLE1BQzlGOEQsR0FBbUIxQixVQUFZLEVBQy9CMEIsRUFBbUJDLFFBQVVuRSxLQUFLaUMsVUFBVWtDLFFBQVFDLE9BQ3BELElBQUlDLEdBQVMsR0FBSTlFLFNBQVFrRCxPQUFPdUIsRUFBTTdILElBQUsrSCxFQUMzQ0csR0FBTzNCLFlBQWEsRUFFbEIyQixFQUFPdEQsU0FEeUJsQyxjQUF2Qm1GLEdBQU1ULEtBQUt4QyxTQUNGaUQsRUFBTVQsS0FBS3hDLFNBRVgsR0FBSXhCLFNBQVErQyxRQUFRdEMsS0FBS2MsS0FBS0MsU0FBU0MsRUFBR2hCLEtBQUtjLEtBQUtDLFNBQVNFLEVBQUdqQixLQUFLYyxLQUFLQyxTQUFTRyxHQUd2R21ELEVBQU9DLEtBQU8sR0FDWE4sRUFBTVQsS0FBS3hCLFdBQ1ZzQyxFQUFPMUIsY0FBZSxHQUFLLEtBQUssRUFBTSxLQUV0QzBCLEVBQU8xQixjQUFjQyxLQUFLQyxJQUFLLEdBQUtDLFNBQVNrQixFQUFNVCxLQUFLcEIsV0FBYVcsU0FBU2tCLEVBQU1ULEtBQUtwQixXQUFXLEVBQU0sS0FFOUduQyxLQUFLd0IsUUFBUXVCLE1BQU0zQixPQUFPaUQsRUFBUWxJLElBQUk2SCxFQUFNN0gsU0F3QzVDQSxJQUFLLGFBQ0xjLE1BdENNLFNBQUNzSCxHQUNULEdBQUlDLEdBQVUsR0FBSTVELFVBQVNaLEtBQUtFLFlBQWMsU0FBWXFFLEVBQzFEQyxHQUFRbkIsS0FBSyxRQUFTLFNBQVNXLEdBQzdCLEdBQUlTLEdBQVdsRixRQUFRbUYsS0FBS0MsVUFBVSxVQUFXLEVBQUszRSxLQUFLNEUsV0FBV3hFLE1BQ3RFcUUsR0FBU0ksV0FBWSxFQUNyQkosRUFBUzFELFNBQVcsR0FBSXhCLFNBQVErQyxRQUFRMEIsRUFBTVosTUFBTXJDLFNBQVNDLEVBQUdnRCxFQUFNWixNQUFNckMsU0FBU0UsRUFBRytDLEVBQU1aLE1BQU1yQyxTQUFTRyxFQUM3RyxJQUFJNEQsR0FBaUIsR0FBSXZGLFNBQVF3RixlQUFlLFlBQWEsSUFBTS9FLEtBQUs0RSxXQUFXeEUsTUFDbkYwRSxHQUFlRSxnQkFBa0IsR0FBSXpGLFNBQVEwRixRQUFRLGdDQUFpQ2pGLEtBQUs0RSxXQUFXeEUsT0FDdEcwRSxFQUFlSSxRQUFVVCxFQUN6QkssRUFBZUssV0FBYSxHQUFJNUYsU0FBUStDLFFBQVEsR0FBSSxFQUFHLEdBQ3ZEd0MsRUFBZU0sV0FBYSxHQUFJN0YsU0FBUStDLFFBQVEsRUFBRyxFQUFHLEdBQ3REd0MsRUFBZU8sT0FBUyxHQUFJOUYsU0FBUStGLE9BQU8sR0FBSyxHQUFLLEVBQUssR0FDMURSLEVBQWVTLE9BQVMsR0FBSWhHLFNBQVErRixPQUFPLEdBQUssR0FBSyxFQUFLLEdBQzFEUixFQUFlVSxVQUFZLEdBQUlqRyxTQUFRK0YsT0FBTyxFQUFHLEVBQUcsR0FBSyxHQUN6RFIsRUFBZVcsUUFBVSxHQUN6QlgsRUFBZVksUUFBVSxHQUN6QlosRUFBZWEsWUFBYyxHQUM3QmIsRUFBZWMsWUFBYyxHQUM3QmQsRUFBZWUsU0FBVyxJQUMxQmYsRUFBZWdCLFVBQVl2RyxRQUFRd0YsZUFBZWdCLGlCQUNsRGpCLEVBQWVrQixRQUFVLEdBQUl6RyxTQUFRK0MsUUFBUSxFQUFHLE1BQU8sR0FDdkR3QyxFQUFlbUIsV0FBYSxHQUFJMUcsU0FBUStDLFFBQVEsR0FBSSxFQUFHLEdBQ3ZEd0MsRUFBZW9CLFdBQWEsR0FBSTNHLFNBQVErQyxRQUFRLEVBQUcsRUFBRyxJQUN0RHdDLEVBQWVxQixhQUFlLEVBQzlCckIsRUFBZXNCLGFBQWUsRUFDOUJ0QixFQUFldUIsWUFBYyxLQUM3QnZCLEVBQWV3QixRQUNmNUMsV0FBVyxXQUNUb0IsRUFBZXlCLE9BQ2Z6QixFQUFlMEIsU0FDZixLQUFJLEdBQUkzSSxHQUFJLEVBQUdBLEVBQUltQyxLQUFLSSxNQUFNcUcsZUFBZTNJLE9BQVFELElBQzlDbUMsS0FBS0ksTUFBTXFHLGVBQWU1SSxHQUFHb0MsTUFBUXNFLEdBQ3hDdkUsS0FBS0ksTUFBTXFHLGVBQWU1SSxHQUFHMkksU0FHakNoQyxHQUFRa0MsVUFDUmhHLEtBQUtWLE1BQU8sTUFDZFUsS0FBS1YsTUFBTyxTQUFVMkcsR0FDdkJDLFFBQVFDLElBQUlGLFFBMENYeEssSUFBSyxVQUNMYyxNQXZDRyxXQXdDRCxHQXhDeUQ2SixJQUFsRC9HLFVBQUFqQyxRQUFBLEdBQUFlLFNBQUFrQixVQUFBLElBQUlFLEtBQU0sV0FBWWMsVUFBV0MsRUFBRSxFQUFHQyxFQUFFLEVBQUdDLEVBQUUsSUFBR25CLFVBQUEsR0FBTUEsVUFBQWpDLFFBQUEsR0FBQWUsU0FBQWtCLFVBQUEsTUFBS0EsVUFBQSxHQUN0RSxJQUE2QyxNQUExQ2lELE9BQU9jLGFBQWFDLFFBQVEsV0FBbUIsQ0FDaEQrQyxFQUFLOUYsRUFBSTNCLFlBQUFJLE1BQU1zSCxVQUFVLElBQUssR0FDOUJELEVBQUs3RixFQUFJLEVBQ1Q2RixFQUFLNUYsRUFBSTdCLFlBQUFJLE1BQU1zSCxVQUFVLEVBQUcsR0FDNUIsSUFBSUMsR0FBWSxJQUVkQSxHQURtQixNQUFsQmhILEtBQUtjLEtBQUtiLEtBQ0VaLFlBQUFJLE1BQU13SCxVQUFVakgsS0FBS3NCLFVBRXRCdEIsS0FBS2MsS0FBS2IsSUFFeEIsS0FDRStDLE9BQU9jLGFBQWFvRCxRQUFRLFVBQVdGLEdBQ3hDLE1BQU1HLEdBQ0xDLE1BQU0sMERBRVJwSCxLQUFLYyxNQUFRYixLQUFLK0csRUFBV2pHLFNBQVUrRixFQUFNM0YsU0FBVSxHQUFJNUIsU0FBUStDLFFBQVEsRUFBRyxFQUFHLEdBQUlsQixPQUFPcEIsS0FBS3VCLFVBQVdZLFNBQVU5QyxZQUFBSSxNQUFNd0gsVUFBVWpILEtBQUs4QixtQkFFM0k5QixLQUFLYSxNQUFNd0MsS0FBSyxRQUFTLFNBQVNHLEdBQzlCeEQsS0FBS3lELFdBQVdELElBQ2xCOUMsS0FBS1YsT0FHUEEsS0FBS2EsTUFBUWIsS0FBS2EsTUFBTWtDLEtBQU0vQyxLQUFLYyxNQUNuQ2QsS0FBSzJCLGVBQWlCM0IsS0FBS2EsTUFBTTFFLEtBQ2pDLEtBQ0U2RyxPQUFPYyxhQUFhb0QsUUFBUSxjQUFlbEgsS0FBSzJCLGdCQUNqRCxNQUFNd0YsR0FDSFAsUUFBUUMsSUFBSU0sUUErQ2hCaEwsSUFBSyxhQUNMYyxNQXpDTSxTQUFDOEQsRUFBVUksR0FDaEJuQixLQUFLTSxVQUNETixLQUFLZ0MsaUJBQ05oQyxLQUFLNkIsYUFBYXdGLEtBQUtwSCxLQUFNRCxLQUFLYyxLQUFLYixLQUFNYyxTQUFVQSxFQUFVSSxTQUFVQSxFQUFVQyxPQUFRcEIsS0FBS2MsS0FBS00sT0FBU2UsU0FBVW5DLEtBQUtjLEtBQUtxQixXQUUvRyxNQUFsQm5DLEtBQUtjLEtBQUtiLE1BQ1hELEtBQUthLE1BQU13RyxLQUFLcEgsS0FBTUQsS0FBS2MsS0FBS2IsS0FBTWMsU0FBVUEsRUFBVUksU0FBVUEsRUFBVUMsT0FBUXBCLEtBQUtjLEtBQUtNLE9BQVFlLFNBQVVuQyxLQUFLYyxLQUFLcUIsZUErQ2xJaEcsSUFBSyxRQUNMYyxNQTFDQyxnQkF2T1MyQyxHQUFvQlIsSUFBSWtJLFVBdVJ0QzlKLFNBQVFvQyxZQUFjQSIsImZpbGUiOiJjb3JlL2xzZC9jb21wb25lbnRzL2NfbXVsdGl1c2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgQ0VTIGZyb20gJ2Nlcyc7XG5leHBvcnQgeyBCQUJZTE9OIH0gZnJvbSAnLi4vbGliL2JhYnlsb24nO1xuaW1wb3J0IHsgdXRpbHMgfSBmcm9tICcuLi91dGlscy91dGlscyc7XG52YXIgZGVmYXVsdHMgPSB1dGlscy5kZWZhdWx0QXJncygpO1xuZGVmYXVsdHMuX25hbWUgPSAnbXVsdGl1c2VyJztcblxuLyoqXG4gKiAuLi5cbiAqIEBhdXRob3IgQnJlbmRvbiBTbWl0aFxuICogaHR0cDovL3NlYWNsb3VkOS5vcmdcbiAqIExpZ2h0V2VpZ2h0IDNEIFN5c3RlbSBEZXNpZ24gZW5naW5lXG4gKi9cblxuIGV4cG9ydCBjbGFzcyBjX211bHRpdXNlciBleHRlbmRzIENFUy5Db21wb25lbnR7XG4gIGNvbnN0cnVjdG9yKF9vcHRzID0gZGVmYXVsdHMpe1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5uYW1lID0gX29wdHMuX25hbWU7XG4gICAgdGhpcy5maXJlYmFzZVJlZiA9IF9vcHRzLl9mYlVSTDtcbiAgICB0aGlzLnNjZW5lID0gIF9vcHRzLl9zY2VuZTtcbiAgICB0aGlzLnN5c0luaXQgPSBmYWxzZTtcbiAgICB0aGlzLnVzZXJJbml0ID0gZmFsc2U7XG4gICAgdXRpbHMubG9hZFNjcmlwdChcImh0dHBzOi8vY2RuLmZpcmViYXNlLmNvbS9qcy9jbGllbnQvMi4zLjAvZmlyZWJhc2UuanNcIiwgdGhpcy5zZXRNdWx0aVVzZXJEYXRhLmJpbmQodGhpcykpO1xuICAgIFxuICB9XG5cbiAgc2V0TXVsdGlVc2VyRGF0YSgpe1xuICAgIHRoaXMubXVsdGl1c2VyID0gbmV3IEZpcmViYXNlKHRoaXMuZmlyZWJhc2VSZWYpO1xuICAgIHRoaXMudXNlcnMgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICd1c2VycycpO1xuICAgIHRoaXMudXNlciA9IHtuYW1lOm51bGwsIHBvc2l0aW9uOnt4OjAsIHk6MCwgejowfSwgcm90YXRpb246e3g6MCwgeTowLCB6OjB9LCBzcHJpdGU6bnVsbH07XG4gICAgdGhpcy5jdXJyZW50VXNlcnMgPSBbXTtcbiAgICB0aGlzLmZha2VVc2VyID0gWydUb20nLCdSaWNoYXJkJywnSmFuZScsJ0pvaG4nLCdEYW4nLCdKb3NoJywnQnJlbmRvbicsJ0VtbWEnLCdQZXRlciddO1xuICAgIHRoaXMuc3ByaXRlSW1nID0gJ2Fzc2V0cy9zcHJpdGVzL3VzZXJzLnBuZyc7XG4gICAgdGhpcy5zcHJpdGVzID0gW107XG4gICAgdGhpcy5BbGVydHMgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICdhbGVydHMnKTtcbiAgICB0aGlzLmN1cnJlbnRBbGVydHMgPSBbXTtcbiAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gbnVsbDtcbiAgICB0aGlzLmV4ZWN1dGVVc2VyUmVtb3ZhbCA9IG51bGw7XG4gICAgdGhpcy51c2VyVG9VcGRhdGUgPSAgdGhpcy5maXJlYmFzZVJlZisgJ3VzZXJzLyc7XG4gICAgdGhpcy5zcHJpdGVBbmltYXRpb25zID0gWzIwLDQwLDYwLDgwXTtcbiAgICB0aGlzLnpvbWJpZU1vZGUgPSBmYWxzZTtcbiAgICB0aGlzLmlzQ3VycmVudGx5VXNpbmcgID0gZmFsc2U7XG4gICAgdGhpcy5zcE1hbmFnZXIgPSBudWxsO1xuICAgIHRoaXMucGxheWVyU3ByaXRlID0gbnVsbDtcbiAgICB0aGlzLnNwcml0ZUlEID0gMjA7XG4gICAgdGhpcy5pbml0U3lzKCk7XG4gIH1cblxuICBpbml0U3lzKCl7XG5cbiAgICB0aGlzLnNldFVzZXIobnVsbCwgbmV3IEJBQllMT04uVmVjdG9yMygwLCAwLCAwKSk7XG5cbiAgICAvKlxuICAgIGlmKCAhIHRoaXMuYXBwLl9wbGF0Zm9ybS5pcygnYW5kcm9pZCcpICl7XG4gICAgICAgIHRoaXMuaHVkID0gbmV3IEJhcnRWUl9IZWFkc1VwRGlzcGxheSh0aGlzLnNjZW5lLCB0aGlzKTtcbiAgICB9XG4gICAgKi9cblxuICAgIHRoaXMuc3BNYW5hZ2VyICA9IG5ldyBCQUJZTE9OLlNwcml0ZU1hbmFnZXIoXCJ1c2VyTWFuYWdlclwiLCB0aGlzLnNwcml0ZUltZywgMTAwMCwgMTI4LCB0aGlzLnNjZW5lKTtcbiAgICB0aGlzLnNwTWFuYWdlci5sYXllck1hc2sgPSAzO1xuICAgIHRoaXMucGxheWVyU3ByaXRlID0gbmV3IEJBQllMT04uU3ByaXRlKFwicGxheWVyXCIsIHRoaXMuc3BNYW5hZ2VyICk7XG4gICAgdGhpcy5wbGF5ZXJTcHJpdGUuaXNQaWNrYWJsZSA9IHRydWU7XG5cbiAgIFxuXG4gICAgaWYodGhpcy56b21iaWVNb2RlKXtcbiAgICAgIHRoaXMucGxheWVyU3ByaXRlLnBsYXlBbmltYXRpb24oIDgwLCAgMTAwLCB0cnVlLCAxMDApO1xuICAgIH1lbHNle1xuICAgICAgdGhpcy5wbGF5ZXJTcHJpdGUucGxheUFuaW1hdGlvbihNYXRoLmFicyggMjAgLSB0aGlzLnVzZXIuc3ByaXRlSUQpLCAgcGFyc2VJbnQodGhpcy51c2VyLnNwcml0ZUlEKSwgdHJ1ZSwgMTAwKTtcbiAgICB9XG4gICAgLy90aGlzLnNjZW5lLmFjdGl2ZUNhbWVyYS5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjModGhpcy51c2VyLnBvc2l0aW9uLngsIHRoaXMudXNlci5wb3NpdGlvbi55LCB0aGlzLnVzZXIucG9zaXRpb24ueik7XG4gICAgdGhpcy5wbGF5ZXJTcHJpdGUucG9zaXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKHRoaXMudXNlci5wb3NpdGlvbi54LCB0aGlzLnVzZXIucG9zaXRpb24ueSwgdGhpcy51c2VyLnBvc2l0aW9uLnopO1xuICAgIC8vIHRoaXMuc2NlbmUuYWN0aXZlQ2FtZXJhLnJvdGF0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyh0aGlzLkRhdGEudXNlci5yb3RhdGlvbi54LCB0aGlzLkRhdGEudXNlci5yb3RhdGlvbi55LCB0aGlzLkRhdGEudXNlci5yb3RhdGlvbi56KTtcbiAgICB0aGlzLnNwcml0ZXMucHVzaCh7c3ByaXRlOnRoaXMucGxheWVyU3ByaXRlLCBrZXk6dGhpcy5jdXJyZW50VXNlcktleX0pO1xuXG4gICB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCl7XG4gICAgdGhpcy5BbGVydHMub24oXCJjaGlsZF9hZGRlZFwiLCBmdW5jdGlvbihhbGVydERhdGEpIHtcbiAgICAgIHRoaXMuY3VycmVudEFsZXJ0cy5wdXNoKGFsZXJ0RGF0YS52YWwoKSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuQWxlcnRzLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbihhbGVydERhdGEpIHtcbiAgICAgIGFsZXJ0RGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgdGhpcy5jdXJyZW50QWxlcnRzLnB1c2goZGF0YS52YWwoKSk7XG4gICAgICB9LmJpbmQodGhpcykpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cbiAgICB0aGlzLnVzZXJzLm9uKFwiY2hpbGRfY2hhbmdlZFwiLCBmdW5jdGlvbih1c2VyRGF0YSkge1xuICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY3VycmVudFVzZXJzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgaWYodXNlckRhdGEua2V5KCkgPT0gdGhpcy5jdXJyZW50VXNlcnNbaV0ua2V5KXtcbiAgICAgICAgIHRoaXMuY3VycmVudFVzZXJzW2ldLmRhdGEgPSAgdXNlckRhdGEudmFsKCk7XG4gICAgICAgfVxuICAgICB9XG4gICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy51c2Vycy5vbmNlKFwidmFsdWVcIiwgZnVuY3Rpb24odXNlckRhdGEpIHtcbiAgICAgICAgdGhpcy5jaGVja1VzZXJzKHVzZXJEYXRhKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5zeXNJbml0ID0gdHJ1ZTsgXG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgdGhpcy5hZGRVc2VycygpO1xuICAgIH0uYmluZCh0aGlzKSwgNTAwKTtcbiAgfS5iaW5kKHRoaXMpKTtcbn1cblxuYWRkVXNlcnMoKXtcbiAgICBmb3IobGV0IGkgPSAwOyBpIDwgdGhpcy5jdXJyZW50VXNlcnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZih0aGlzLmN1cnJlbnRVc2Vyc1tpXS5rZXkgIT0gdGhpcy5jdXJyZW50VXNlcktleSl7XG4gICAgICAgICAgICB0aGlzLmdlbmVyYXRlVXNlclNwcml0ZXModGhpcy5jdXJyZW50VXNlcnNbaV0sIGkpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHRoaXMudXNlckluaXQgPSB0cnVlO1xufVxuXG5jaGVja1VzZXJzKHVzZXJEYXRhKXtcbiAgdmFyIHVzZXJIYXZlTG9hZGVkID0gZmFsc2U7XG4gICAgICB1c2VyRGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgaWYod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKFwidnJfdXNlcl9rZXlcIikgIT0gbnVsbCAmJiBkYXRhLmtleSgpID09IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInZyX3VzZXJfa2V5XCIpICl7XG4gICAgICAgICAgdGhpcy51c2VyID0gZGF0YS52YWwoKTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gZGF0YS5rZXkoKTtcbiAgICAgICAgICB0aGlzLnVzZXJUb1VwZGF0ZSArPSAgZGF0YS5rZXkoKTtcbiAgICAgICAgICB0aGlzLnVzZXJUb1VwZGF0ZSA9IG5ldyBGaXJlYmFzZSh0aGlzLnVzZXJUb1VwZGF0ZSk7XG4gICAgICAgICAgdGhpcy5pc0N1cnJlbnRseVVzaW5nID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICBpZihkYXRhLnZhbCgpLm5hbWUgIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkucG9zaXRpb24gIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkucm90YXRpb24gIT0gdW5kZWZpbmVkICYmIGRhdGEudmFsKCkuc3ByaXRlICE9IHVuZGVmaW5lZCAmJiBkYXRhLnZhbCgpLnNwcml0ZUlEICE9IHVuZGVmaW5lZCl7XG4gICAgICAgICAgaWYoIXVzZXJIYXZlTG9hZGVkKXtcbiAgICAgICAgICAgICAgdXNlckhhdmVMb2FkZWQgPSB0cnVlO1xuICAgICAgICAgICAgICB1c2VyRGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgICAgIHRoaXMuY3VycmVudFVzZXJzLnB1c2goe2RhdGE6ZGF0YS52YWwoKSwga2V5OiBkYXRhLmtleSgpfSk7XG4gICAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgICAgfSAgXG4gICAgICAgIH1cbiAgICAgIH0uYmluZCh0aGlzKSk7XG59XG5cbmdlbmVyYXRlVXNlclNwcml0ZXMoX2RhdGEsIF9pZCl7XG4gICAgdmFyIHNwcml0ZU1hbmFnZXJSaWRlciA9IG5ldyBCQUJZTE9OLlNwcml0ZU1hbmFnZXIoX2RhdGEua2V5LCBfZGF0YS5kYXRhLnNwcml0ZSwgMSwgMTI4LCB0aGlzLnNjZW5lKTtcbiAgICBzcHJpdGVNYW5hZ2VyUmlkZXIubGF5ZXJNYXNrID0gMztcbiAgICBzcHJpdGVNYW5hZ2VyUmlkZXIudGV4dHVyZSA9IHRoaXMuc3BNYW5hZ2VyLnRleHR1cmUuY2xvbmUoKTtcbiAgICBsZXQgcGxheWVyID0gbmV3IEJBQllMT04uU3ByaXRlKF9kYXRhLmtleSwgc3ByaXRlTWFuYWdlclJpZGVyICk7XG4gICAgcGxheWVyLmlzUGlja2FibGUgPSB0cnVlO1xuICAgIGlmKHR5cGVvZiAgX2RhdGEuZGF0YS5wb3NpdGlvbiAhPSB1bmRlZmluZWQpe1xuICAgICAgcGxheWVyLnBvc2l0aW9uID0gX2RhdGEuZGF0YS5wb3NpdGlvbjtcbiAgICB9ZWxzZXtcbiAgICAgIHBsYXllci5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjModGhpcy51c2VyLnBvc2l0aW9uLngsIHRoaXMudXNlci5wb3NpdGlvbi55LCB0aGlzLnVzZXIucG9zaXRpb24ueik7XG4gICAgfVxuICAgIC8vcGxheWVyLnJvdGF0aW9uID0gX2RhdGEuZGF0YS5yb3RhdGlvbjtcbiAgICBwbGF5ZXIuc2l6ZSA9IDE0LjA7XG4gICAgaWYoX2RhdGEuZGF0YS56b21iaWVNb2RlKXtcbiAgICAgICAgcGxheWVyLnBsYXlBbmltYXRpb24oIDgwLCAgMTAwLCB0cnVlLCAxMDApO1xuICAgIH1lbHNle1xuICAgICAgICBwbGF5ZXIucGxheUFuaW1hdGlvbihNYXRoLmFicyggMjAgLSBwYXJzZUludChfZGF0YS5kYXRhLnNwcml0ZUlEKSksICBwYXJzZUludChfZGF0YS5kYXRhLnNwcml0ZUlEKSwgdHJ1ZSwgMTAwKTtcbiAgICB9XG4gICAgdGhpcy5zcHJpdGVzLnB1c2goe3Nwcml0ZTpwbGF5ZXIsIGtleTpfZGF0YS5rZXl9KTtcbn1cblxuZGVsZXRlVXNlcihfZGtleSl7XG4gIHZhciB1c2VyUmVmID0gbmV3IEZpcmViYXNlKHRoaXMuZmlyZWJhc2VSZWYgKyAndXNlcnMvJyAgKyBfZGtleSk7XG4gIHVzZXJSZWYub25jZShcInZhbHVlXCIsIGZ1bmN0aW9uKF9kYXRhKSB7XG4gICAgdmFyIGZvdW50YWluID0gQkFCWUxPTi5NZXNoLkNyZWF0ZUJveChcImZvdXRhaW5cIiwgMS4wLCB0aGlzLmJhYnlsb25Nb2Quc2NlbmUpO1xuICAgIGZvdW50YWluLmlzVmlzaWJsZSA9IGZhbHNlO1xuICAgIGZvdW50YWluLnBvc2l0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyhfZGF0YS52YWwoKS5wb3NpdGlvbi54LCBfZGF0YS52YWwoKS5wb3NpdGlvbi55LCBfZGF0YS52YWwoKS5wb3NpdGlvbi56KVxuICAgIHZhciBwYXJ0aWNsZVN5c3RlbSA9IG5ldyBCQUJZTE9OLlBhcnRpY2xlU3lzdGVtKFwicGFydGljbGVzXCIsIDEwMDAsIHRoaXMuYmFieWxvbk1vZC5zY2VuZSk7XG4gICAgcGFydGljbGVTeXN0ZW0ucGFydGljbGVUZXh0dXJlID0gbmV3IEJBQllMT04uVGV4dHVyZShcImJhcnR2ci9pbWcvdGV4dHVyZXMvZmxhcmUucG5nXCIsIHRoaXMuYmFieWxvbk1vZC5zY2VuZSk7XG4gICAgcGFydGljbGVTeXN0ZW0uZW1pdHRlciA9IGZvdW50YWluOyAvLyB0aGUgc3RhcnRpbmcgb2JqZWN0LCB0aGUgZW1pdHRlclxuICAgIHBhcnRpY2xlU3lzdGVtLm1pbkVtaXRCb3ggPSBuZXcgQkFCWUxPTi5WZWN0b3IzKC0xLCAwLCAwKTsgLy8gU3RhcnRpbmcgYWxsIGZyb21cbiAgICBwYXJ0aWNsZVN5c3RlbS5tYXhFbWl0Qm94ID0gbmV3IEJBQllMT04uVmVjdG9yMygxLCAwLCAwKTsgLy8gVG8uLi5cbiAgICBwYXJ0aWNsZVN5c3RlbS5jb2xvcjEgPSBuZXcgQkFCWUxPTi5Db2xvcjQoMC43LCAwLjgsIDEuMCwgMS4wKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5jb2xvcjIgPSBuZXcgQkFCWUxPTi5Db2xvcjQoMC4yLCAwLjUsIDEuMCwgMS4wKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5jb2xvckRlYWQgPSBuZXcgQkFCWUxPTi5Db2xvcjQoMCwgMCwgMC4yLCAwLjApO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1pblNpemUgPSAwLjE7XG4gICAgcGFydGljbGVTeXN0ZW0ubWF4U2l6ZSA9IDAuNTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5taW5MaWZlVGltZSA9IDAuMTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5tYXhMaWZlVGltZSA9IDAuMztcbiAgICBwYXJ0aWNsZVN5c3RlbS5lbWl0UmF0ZSA9IDEwMDA7XG4gICAgcGFydGljbGVTeXN0ZW0uYmxlbmRNb2RlID0gQkFCWUxPTi5QYXJ0aWNsZVN5c3RlbS5CTEVORE1PREVfT05FT05FO1xuICAgIHBhcnRpY2xlU3lzdGVtLmdyYXZpdHkgPSBuZXcgQkFCWUxPTi5WZWN0b3IzKDAsIC05LjgxLCAwKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5kaXJlY3Rpb24xID0gbmV3IEJBQllMT04uVmVjdG9yMygtNCwgNiwgNCk7XG4gICAgcGFydGljbGVTeXN0ZW0uZGlyZWN0aW9uMiA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoNCwgNiwgLTQpO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1pbkVtaXRQb3dlciA9IDE7XG4gICAgcGFydGljbGVTeXN0ZW0ubWF4RW1pdFBvd2VyID0gMztcbiAgICBwYXJ0aWNsZVN5c3RlbS51cGRhdGVTcGVlZCA9IDAuMDA1O1xuICAgIHBhcnRpY2xlU3lzdGVtLnN0YXJ0KCk7XG4gICAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgICAgcGFydGljbGVTeXN0ZW0uc3RvcCgpO1xuICAgICAgcGFydGljbGVTeXN0ZW0uZGlzcG9zZSgpO1xuICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuc2NlbmUuc3ByaXRlTWFuYWdlcnMubGVuZ3RoOyBpKyspe1xuICAgICAgICBpZiggIHRoaXMuc2NlbmUuc3ByaXRlTWFuYWdlcnNbaV0ubmFtZSA9PSBfZGtleSl7XG4gICAgICAgICAgdGhpcy5zY2VuZS5zcHJpdGVNYW5hZ2Vyc1tpXS5kaXNwb3NlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHVzZXJSZWYucmVtb3ZlKCk7XG4gICAgfS5iaW5kKHRoaXMpLCA1MDAwKTsgICAgICAgXG4gIH0uYmluZCh0aGlzKSwgZnVuY3Rpb24gKGVycm9yT2JqZWN0KSB7XG4gICBjb25zb2xlLmxvZyhlcnJvck9iamVjdCk7XG4gfSk7XG59XG5cbnNldFVzZXIoX3VzZXIgPSB7bmFtZTogJ3VzZXJOYW1lJywgcG9zaXRpb246IHt4OjAsIHk6MCwgejowfX0sIF9wb3MgPSB7fSApe1xuICBpZih3aW5kb3cubG9jYWxTdG9yYWdlLmdldEl0ZW0oXCJ2cl91c2VyXCIpID09IG51bGwpe1xuICAgIF9wb3MueCA9IHV0aWxzLnJhbmRvbVBvcygtODUsIDIpO1xuICAgIF9wb3MueSA9IDA7XG4gICAgX3Bvcy56ID0gdXRpbHMucmFuZG9tUG9zKDUsIDE1KTtcbiAgICB2YXIgX3VzZXJuYW1lID0gbnVsbDtcbiAgICBpZih0aGlzLnVzZXIubmFtZSA9PSBudWxsKXtcbiAgICAgIF91c2VybmFtZSA9ICB1dGlscy5yYW5kb21BcnIodGhpcy5mYWtlVXNlcik7XG4gICAgfWVsc2V7XG4gICAgICBfdXNlcm5hbWUgPSB0aGlzLnVzZXIubmFtZTtcbiAgICB9XG4gICAgdHJ5e1xuICAgICAgd2luZG93LmxvY2FsU3RvcmFnZS5zZXRJdGVtKFwidnJfdXNlclwiLCBfdXNlcm5hbWUpO1xuICAgIH1jYXRjaChlKXtcbiAgICAgIGFsZXJ0KCdwbGVhc2UgYWxsb3cgbG9jYWwgc3RvcmFnZSBwbGVhc2UgZGlzYWJsZSBwcml2YXRlIG1vZGUnKTtcbiAgICB9XG4gICAgdGhpcy51c2VyID0ge25hbWU6X3VzZXJuYW1lLCBwb3NpdGlvbjogX3Bvcywgcm90YXRpb246IG5ldyBCQUJZTE9OLlZlY3RvcjMoMCwgMCwgMCksIHNwcml0ZTp0aGlzLnNwcml0ZUltZywgc3ByaXRlSUQ6IHV0aWxzLnJhbmRvbUFycih0aGlzLnNwcml0ZUFuaW1hdGlvbnMpIH07XG5cbiAgICB0aGlzLnVzZXJzLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbih1c2VyRGF0YSkge1xuICAgICAgICB0aGlzLmNoZWNrVXNlcnModXNlckRhdGEpO1xuICAgIH0uYmluZCh0aGlzKSk7XG5cblxuICAgIHRoaXMudXNlcnMgPSB0aGlzLnVzZXJzLnB1c2goIHRoaXMudXNlcik7ICBcbiAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gdGhpcy51c2Vycy5rZXkoKTtcbiAgICB0cnl7XG4gICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ2cl91c2VyX2tleVwiLCB0aGlzLmN1cnJlbnRVc2VyS2V5ICk7XG4gICAgfWNhdGNoKGUpe1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICB9XG5cbiAgfVxufVxuXG5cbnVwZGF0ZVVzZXIocG9zaXRpb24sIHJvdGF0aW9uKXtcbiAgaWYodGhpcy5zeXNJbml0KXtcbiAgICAgIGlmKHRoaXMuaXNDdXJyZW50bHlVc2luZyl7XG4gICAgICAgIHRoaXMudXNlclRvVXBkYXRlLnNldCh7bmFtZTogdGhpcy51c2VyLm5hbWUsIHBvc2l0aW9uOiBwb3NpdGlvbiwgcm90YXRpb246IHJvdGF0aW9uLCBzcHJpdGU6IHRoaXMudXNlci5zcHJpdGUsICBzcHJpdGVJRDogdGhpcy51c2VyLnNwcml0ZUlEIH0pO1xuICAgICAgfWVsc2V7XG4gICAgICAgIGlmKHRoaXMudXNlci5uYW1lICE9IG51bGwpe1xuICAgICAgICAgIHRoaXMudXNlcnMuc2V0KHtuYW1lOiB0aGlzLnVzZXIubmFtZSwgcG9zaXRpb246IHBvc2l0aW9uLCByb3RhdGlvbjogcm90YXRpb24sIHNwcml0ZTogdGhpcy51c2VyLnNwcml0ZSwgc3ByaXRlSUQ6IHRoaXMudXNlci5zcHJpdGVJRCB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICB9XG59XG5cbmRlYnVnKCl7XG5cbn1cblxuXG59Il0sInNvdXJjZVJvb3QiOiIvc291cmNlLyJ9