"use strict";function _interopRequireDefault(t){return t&&t.__esModule?t:{"default":t}}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(t.__proto__=e)}var _createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var r=e[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}return function(e,i,r){return i&&t(e.prototype,i),r&&t(e,r),e}}(),_get=function(t,e,i){for(var r=!0;r;){var n=t,a=e,h=i;s=o=u=void 0,r=!1,null===n&&(n=Function.prototype);var s=Object.getOwnPropertyDescriptor(n,a);if(void 0!==s){if("value"in s)return s.value;var u=s.get;return void 0===u?void 0:u.call(h)}var o=Object.getPrototypeOf(n);if(null===o)return void 0;t=o,e=a,i=h,r=!0}},_AnimationJs=require("./Animation.js"),_AnimationJs2=_interopRequireDefault(_AnimationJs),AniDom=function(t){function e(){_classCallCheck(this,e),_get(Object.getPrototypeOf(e.prototype),"constructor",this).call(this),this.frames=[],this.lastId=0,this.batch={hash:{},read:[],write:[],mode:null}}return _inherits(e,t),_createClass(e,[{key:"read",value:function(t,e){var i=this.add("read",t,e),r=i.id;this.batch.read.push(i.id);var n="reading"===this.batch.mode||this.batch.scheduled;return n?r:(this.scheduleBatch(),r)}},{key:"write",value:function(t,e){var i=this.add("write",t,e),r=this.batch.mode,n=i.id;this.batch.write.push(i.id);var a="writing"===r||"reading"===r||this.batch.scheduled;return a?n:(this.scheduleBatch(),n)}},{key:"defer",value:function(t,e,i){"function"==typeof t&&(i=e,e=t,t=1);var r=this,n=t-1;return this.schedule(n,function(){r.run({fn:e,ctx:i})})}},{key:"clear",value:function(t){if("function"==typeof t)return this.clearFrame(t);t=Number(t);var e=this.batch.hash[t];if(e){var i=this.batch[e.type],r=i.indexOf(t);delete this.batch.hash[t],~r&&i.splice(r,1)}}},{key:"clearFrame",value:function(t){var e=this.frames.indexOf(t);~e&&this.frames.splice(e,1)}},{key:"scheduleBatch",value:function(){var t=this;this.schedule(0,function(){t.batch.scheduled=!1,t.runBatch()}),this.batch.scheduled=!0}},{key:"uniqueId",value:function(){return++this.lastId}},{key:"flush",value:function(t){for(var e;e=t.shift();)this.run(this.batch.hash[e])}},{key:"runBatch",value:function(){try{this.batch.mode="reading",this.flush(this.batch.read),this.batch.mode="writing",this.flush(this.batch.write),this.batch.mode=null}catch(t){throw this.runBatch(),t}}},{key:"add",value:function(t,e,i){var r=this.uniqueId();return this.batch.hash[r]={id:r,fn:e,ctx:i,type:t}}},{key:"run",value:function(t){var e=t.ctx||this,i=t.fn;if(delete this.batch.hash[t.id],!this.onError)return i.call(e);try{i.call(e)}catch(r){this.onError(r)}}},{key:"loop",value:function(){var t=this,e=this.raf;this.looping||(e(function i(){var r=t.frames.shift();t.frames.length?e(i):t.looping=!1,r&&r()}),this.looping=!0)}},{key:"schedule",value:function(t,e){return this.frames[t]?this.schedule(t+1,e):(this.loop(),this.frames[t]=e)}}]),e}(_AnimationJs2["default"]);module.exports=AniDom;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVpL0FuaURvbS5qcyJdLCJuYW1lcyI6WyJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0Iiwib2JqIiwiX19lc01vZHVsZSIsImRlZmF1bHQiLCJfY2xhc3NDYWxsQ2hlY2siLCJpbnN0YW5jZSIsIkNvbnN0cnVjdG9yIiwiVHlwZUVycm9yIiwiX2luaGVyaXRzIiwic3ViQ2xhc3MiLCJzdXBlckNsYXNzIiwicHJvdG90eXBlIiwiT2JqZWN0IiwiY3JlYXRlIiwiY29uc3RydWN0b3IiLCJ2YWx1ZSIsImVudW1lcmFibGUiLCJ3cml0YWJsZSIsImNvbmZpZ3VyYWJsZSIsIl9fcHJvdG9fXyIsIl9jcmVhdGVDbGFzcyIsImRlZmluZVByb3BlcnRpZXMiLCJ0YXJnZXQiLCJwcm9wcyIsImkiLCJsZW5ndGgiLCJkZXNjcmlwdG9yIiwiZGVmaW5lUHJvcGVydHkiLCJrZXkiLCJwcm90b1Byb3BzIiwic3RhdGljUHJvcHMiLCJfZ2V0IiwiX3giLCJfeDIiLCJfeDMiLCJfYWdhaW4iLCJvYmplY3QiLCJwcm9wZXJ0eSIsInJlY2VpdmVyIiwiZGVzYyIsInBhcmVudCIsImdldHRlciIsInVuZGVmaW5lZCIsIkZ1bmN0aW9uIiwiZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yIiwiZ2V0IiwiY2FsbCIsImdldFByb3RvdHlwZU9mIiwiX0FuaW1hdGlvbkpzIiwicmVxdWlyZSIsIl9BbmltYXRpb25KczIiLCJBbmlEb20iLCJfQW5pbWF0aW9uIiwidGhpcyIsImZyYW1lcyIsImxhc3RJZCIsImJhdGNoIiwiaGFzaCIsInJlYWQiLCJ3cml0ZSIsIm1vZGUiLCJmbiIsImN0eCIsImpvYiIsImFkZCIsImlkIiwicHVzaCIsImRvZXNudE5lZWRGcmFtZSIsInNjaGVkdWxlZCIsInNjaGVkdWxlQmF0Y2giLCJmcmFtZSIsInNlbGYiLCJpbmRleCIsInNjaGVkdWxlIiwicnVuIiwiY2xlYXJGcmFtZSIsIk51bWJlciIsImxpc3QiLCJ0eXBlIiwiaW5kZXhPZiIsInNwbGljZSIsInJ1bkJhdGNoIiwic2hpZnQiLCJmbHVzaCIsImUiLCJ1bmlxdWVJZCIsIm9uRXJyb3IiLCJyYWYiLCJsb29waW5nIiwibG9vcCIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUNBLFlBTUEsU0FBU0Esd0JBQXVCQyxHQUFPLE1BQU9BLElBQU9BLEVBQUlDLFdBQWFELEdBQVFFLFVBQVdGLEdBRXpGLFFBQVNHLGlCQUFnQkMsRUFBVUMsR0FBZSxLQUFNRCxZQUFvQkMsSUFBZ0IsS0FBTSxJQUFJQyxXQUFVLHFDQUVoSCxRQUFTQyxXQUFVQyxFQUFVQyxHQUFjLEdBQTBCLGtCQUFmQSxJQUE0QyxPQUFmQSxFQUF1QixLQUFNLElBQUlILFdBQVUsaUVBQW9FRyxHQUFlRCxHQUFTRSxVQUFZQyxPQUFPQyxPQUFPSCxHQUFjQSxFQUFXQyxXQUFhRyxhQUFlQyxNQUFPTixFQUFVTyxZQUFZLEVBQU9DLFVBQVUsRUFBTUMsY0FBYyxLQUFlUixJQUFZRCxFQUFTVSxVQUFZVCxHQVIzWixHQUFJVSxjQUFlLFdBQWUsUUFBU0MsR0FBaUJDLEVBQVFDLEdBQVMsSUFBSyxHQUFJQyxHQUFJLEVBQUdBLEVBQUlELEVBQU1FLE9BQVFELElBQUssQ0FBRSxHQUFJRSxHQUFhSCxFQUFNQyxFQUFJRSxHQUFXVixXQUFhVSxFQUFXVixhQUFjLEVBQU9VLEVBQVdSLGNBQWUsRUFBVSxTQUFXUSxLQUFZQSxFQUFXVCxVQUFXLEdBQU1MLE9BQU9lLGVBQWVMLEVBQVFJLEVBQVdFLElBQUtGLElBQWlCLE1BQU8sVUFBVXBCLEVBQWF1QixFQUFZQyxHQUFpSixNQUE5SEQsSUFBWVIsRUFBaUJmLEVBQVlLLFVBQVdrQixHQUFpQkMsR0FBYVQsRUFBaUJmLEVBQWF3QixHQUFxQnhCLE1BRTdoQnlCLEtBQU8sU0FBYUMsRUFBSUMsRUFBS0MsR0FBcUMsSUFBOUIsR0FBSUMsSUFBUyxFQUF3QkEsR0FBUSxDQUFFLEdBQUlDLEdBQVNKLEVBQUlLLEVBQVdKLEVBQUtLLEVBQVdKLENBQUtLLEdBQU9DLEVBQVNDLEVBQVNDLE9BQVdQ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QVlMYixNQTNDSSxTQUFDeUQsRUFBT1gsR0FNWixNQUFJUixNQUFLQyxPQUFPa0IsR0FDTG5CLEtBQUtvQixTQUFTRCxFQUFRLEVBQUdYLElBTXBDUixLQUFLb0MsT0FJRXBDLEtBQUtDLE9BQU9rQixHQUFTWCxPQTNXOUJWLEdBMlpIRCxjQUFjLFdBekNqQndDLFFBQU9DLFFBQVV4QyIsImZpbGUiOiJ1aS9BbmlEb20uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvL2h0dHBzOi8vZ2l0aHViLmNvbS93aWxzb25wYWdlL2Zhc3Rkb20vYmxvYi9tYXN0ZXIvaW5kZXguanMgXG5pbXBvcnQgQW5pbWF0aW9uIGZyb20gXCIuL0FuaW1hdGlvbi5qc1wiO1xuXG5jbGFzcyBBbmlEb20gZXh0ZW5kcyBBbmltYXRpb24ge1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgICAgICBzdXBlcigpO1xuICAgICAgICAgICAgdGhpcy5mcmFtZXMgPSBbXTtcbiAgICAgICAgICAgIHRoaXMubGFzdElkID0gMDtcbiAgICAgICAgICAgIHRoaXMuYmF0Y2ggPSB7XG4gICAgICAgICAgICAgICAgaGFzaDoge30sXG4gICAgICAgICAgICAgICAgcmVhZDogW10sXG4gICAgICAgICAgICAgICAgd3JpdGU6IFtdLFxuICAgICAgICAgICAgICAgIG1vZGU6IG51bGxcbiAgICAgICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgam9iIHRvIHRoZVxuICAgICAqIHJlYWQgYmF0Y2ggYW5kIHNjaGVkdWxlc1xuICAgICAqIGEgbmV3IGZyYW1lIGlmIG5lZWQgYmUuXG4gICAgICpcbiAgICAgKiBAcGFyYW0gIHtGdW5jdGlvbn0gZm5cbiAgICAgKiBAcHVibGljXG4gICAgICovXG4gICAgcmVhZChmbiwgY3R4KSB7XG4gICAgICAgIHZhciBqb2IgPSB0aGlzLmFkZCgncmVhZCcsIGZuLCBjdHgpO1xuICAgICAgICB2YXIgaWQgPSBqb2IuaWQ7XG5cbiAgICAgICAgLy8gQWRkIHRoaXMgam9iIHRvIHRoZSByZWFkIHF1ZXVlXG4gICAgICAgIHRoaXMuYmF0Y2gucmVhZC5wdXNoKGpvYi5pZCk7XG5cbiAgICAgICAgLy8gV2Ugc2hvdWxkICpub3QqIHNjaGVkdWxlIGEgbmV3IGZyYW1lIGlmOlxuICAgICAgICAvLyAxLiBXZSdyZSAncmVhZGluZydcbiAgICAgICAgLy8gMi4gQSBmcmFtZSBpcyBhbHJlYWR5IHNjaGVkdWxlZFxuICAgICAgICB2YXIgZG9lc250TmVlZEZyYW1lID0gdGhpcy5iYXRjaC5tb2RlID09PSAncmVhZGluZycgfHwgdGhpcy5iYXRjaC5zY2hlZHVsZWQ7XG5cbiAgICAgICAgLy8gSWYgYSBmcmFtZSBpc24ndCBuZWVkZWQsIHJldHVyblxuICAgICAgICBpZiAoZG9lc250TmVlZEZyYW1lKSByZXR1cm4gaWQ7XG5cbiAgICAgICAgLy8gU2NoZWR1bGUgYSBuZXdcbiAgICAgICAgLy8gZnJhbWUsIHRoZW4gcmV0dXJuXG4gICAgICAgIHRoaXMuc2NoZWR1bGVCYXRjaCgpO1xuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQWRkcyBhIGpvYiB0byB0aGVcbiAgICAgKiB3cml0ZSBiYXRjaCBhbmQgc2NoZWR1bGVzXG4gICAgICogYSBuZXcgZnJhbWUgaWYgbmVlZCBiZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmblxuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICB3cml0ZShmbiwgY3R4KSB7XG4gICAgICAgIHZhciBqb2IgPSB0aGlzLmFkZCgnd3JpdGUnLCBmbiwgY3R4KTtcbiAgICAgICAgdmFyIG1vZGUgPSB0aGlzLmJhdGNoLm1vZGU7XG4gICAgICAgIHZhciBpZCA9IGpvYi5pZDtcblxuICAgICAgICAvLyBQdXNoIHRoZSBqb2IgaWQgaW50byB0aGUgcXVldWVcbiAgICAgICAgdGhpcy5iYXRjaC53cml0ZS5wdXNoKGpvYi5pZCk7XG5cbiAgICAgICAgLy8gV2Ugc2hvdWxkICpub3QqIHNjaGVkdWxlIGEgbmV3IGZyYW1lIGlmOlxuICAgICAgICAvLyAxLiBXZSBhcmUgJ3dyaXRpbmcnXG4gICAgICAgIC8vIDIuIFdlIGFyZSAncmVhZGluZydcbiAgICAgICAgLy8gMy4gQSBmcmFtZSBpcyBhbHJlYWR5IHNjaGVkdWxlZC5cbiAgICAgICAgdmFyIGRvZXNudE5lZWRGcmFtZSA9IG1vZGUgPT09ICd3cml0aW5nJyB8fCBtb2RlID09PSAncmVhZGluZycgfHwgdGhpcy5iYXRjaC5zY2hlZHVsZWQ7XG5cbiAgICAgICAgLy8gSWYgYSBmcmFtZSBpc24ndCBuZWVkZWQsIHJldHVyblxuICAgICAgICBpZiAoZG9lc250TmVlZEZyYW1lKSByZXR1cm4gaWQ7XG5cbiAgICAgICAgLy8gU2NoZWR1bGUgYSBuZXdcbiAgICAgICAgLy8gZnJhbWUsIHRoZW4gcmV0dXJuXG4gICAgICAgIHRoaXMuc2NoZWR1bGVCYXRjaCgpO1xuICAgICAgICByZXR1cm4gaWQ7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogRGVmZXJzIHRoZSBnaXZlbiBqb2JcbiAgICAgKiBieSB0aGUgbnVtYmVyIG9mIGZyYW1lc1xuICAgICAqIHNwZWNpZmllZC5cbiAgICAgKlxuICAgICAqIElmIG5vIGZyYW1lcyBhcmUgZ2l2ZW5cbiAgICAgKiB0aGVuIHRoZSBqb2IgaXMgcnVuIGluXG4gICAgICogdGhlIG5leHQgZnJlZSBmcmFtZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSAge051bWJlcn0gICBmcmFtZVxuICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmblxuICAgICAqIEBwdWJsaWNcbiAgICAgKi9cbiAgICBkZWZlcihmcmFtZSwgZm4sIGN0eCkge1xuXG4gICAgICAgIC8vIEFjY2VwdHMgdHdvIGFyZ3VtZW50c1xuICAgICAgICBpZiAodHlwZW9mIGZyYW1lID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICBjdHggPSBmbjtcbiAgICAgICAgICAgIGZuID0gZnJhbWU7XG4gICAgICAgICAgICBmcmFtZSA9IDE7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHZhciBpbmRleCA9IGZyYW1lIC0gMTtcblxuICAgICAgICByZXR1cm4gdGhpcy5zY2hlZHVsZShpbmRleCwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBzZWxmLnJ1bih7XG4gICAgICAgICAgICAgICAgZm46IGZuLFxuICAgICAgICAgICAgICAgIGN0eDogY3R4XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIENsZWFycyBhIHNjaGVkdWxlZCAncmVhZCcsXG4gICAgICogJ3dyaXRlJyBvciAnZGVmZXInIGpvYi5cbiAgICAgKlxuICAgICAqIEBwYXJhbSAge051bWJlcnxTdHJpbmd9IGlkXG4gICAgICogQHB1YmxpY1xuICAgICAqL1xuICAgIGNsZWFyKGlkKSB7XG5cbiAgICAgICAgLy8gRGVmZXIgam9icyBhcmUgY2xlYXJlZCBkaWZmZXJlbnRseVxuICAgICAgICBpZiAodHlwZW9mIGlkID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5jbGVhckZyYW1lKGlkKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEFsbG93IGlkcyB0byBiZSBwYXNzZWQgYXMgc3RyaW5nc1xuICAgICAgICBpZCA9IE51bWJlcihpZCk7XG5cbiAgICAgICAgdmFyIGpvYiA9IHRoaXMuYmF0Y2guaGFzaFtpZF07XG4gICAgICAgIGlmICgham9iKSByZXR1cm47XG5cbiAgICAgICAgdmFyIGxpc3QgPSB0aGlzLmJhdGNoW2pvYi50eXBlXTtcbiAgICAgICAgdmFyIGluZGV4ID0gbGlzdC5pbmRleE9mKGlkKTtcblxuICAgICAgICAvLyBDbGVhciByZWZlcmVuY2VzXG4gICAgICAgIGRlbGV0ZSB0aGlzLmJhdGNoLmhhc2hbaWRdO1xuICAgICAgICBpZiAofmluZGV4KSBsaXN0LnNwbGljZShpbmRleCwgMSk7XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIENsZWFycyBhIHNjaGVkdWxlZCBmcmFtZS5cbiAgICAgKlxuICAgICAqIEBwYXJhbSAge0Z1bmN0aW9ufSBmcmFtZVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgY2xlYXJGcmFtZShmcmFtZSkge1xuICAgICAgICB2YXIgaW5kZXggPSB0aGlzLmZyYW1lcy5pbmRleE9mKGZyYW1lKTtcbiAgICAgICAgaWYgKH5pbmRleCkgdGhpcy5mcmFtZXMuc3BsaWNlKGluZGV4LCAxKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTY2hlZHVsZXMgYSBuZXcgcmVhZC93cml0ZVxuICAgICAqIGJhdGNoIGlmIG9uZSBpc24ndCBwZW5kaW5nLlxuICAgICAqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBzY2hlZHVsZUJhdGNoKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG5cbiAgICAgICAgLy8gU2NoZWR1bGUgYmF0Y2ggZm9yIG5leHQgZnJhbWVcbiAgICAgICAgdGhpcy5zY2hlZHVsZSgwLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHNlbGYuYmF0Y2guc2NoZWR1bGVkID0gZmFsc2U7XG4gICAgICAgICAgICBzZWxmLnJ1bkJhdGNoKCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIC8vIFNldCBmbGFnIHRvIGluZGljYXRlXG4gICAgICAgIC8vIGEgZnJhbWUgaGFzIGJlZW4gc2NoZWR1bGVkXG4gICAgICAgIHRoaXMuYmF0Y2guc2NoZWR1bGVkID0gdHJ1ZTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogR2VuZXJhdGVzIGEgdW5pcXVlXG4gICAgICogaWQgZm9yIGEgam9iLlxuICAgICAqXG4gICAgICogQHJldHVybiB7TnVtYmVyfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgdW5pcXVlSWQoKSB7XG4gICAgICAgIHJldHVybiArK3RoaXMubGFzdElkO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIENhbGxzIGVhY2ggam9iIGluXG4gICAgICogdGhlIGxpc3QgcGFzc2VkLlxuICAgICAqXG4gICAgICogSWYgYSBjb250ZXh0IGhhcyBiZWVuXG4gICAgICogc3RvcmVkIG9uIHRoZSBmdW5jdGlvblxuICAgICAqIHRoZW4gaXQgaXMgdXNlZCwgZWxzZSB0aGVcbiAgICAgKiBjdXJyZW50IGB0aGlzYCBpcyB1c2VkLlxuICAgICAqXG4gICAgICogQHBhcmFtICB7QXJyYXl9IGxpc3RcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGZsdXNoKGxpc3QpIHtcbiAgICAgICAgdmFyIGlkO1xuICAgICAgICB3aGlsZSAoaWQgPSBsaXN0LnNoaWZ0KCkpIHtcbiAgICAgICAgICAgIHRoaXMucnVuKHRoaXMuYmF0Y2guaGFzaFtpZF0pO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUnVucyBhbnkgJ3JlYWQnIGpvYnMgZm9sbG93ZWRcbiAgICAgKiBieSBhbnkgJ3dyaXRlJyBqb2JzLlxuICAgICAqXG4gICAgICogV2UgcnVuIHRoaXMgaW5zaWRlIGEgdHJ5IGNhdGNoXG4gICAgICogc28gdGhhdCBpZiBhbnkgam9icyBlcnJvciwgd2VcbiAgICAgKiBhcmUgYWJsZSB0byByZWNvdmVyIGFuZCBjb250aW51ZVxuICAgICAqIHRvIGZsdXNoIHRoZSBiYXRjaCB1bnRpbCBpdCdzIGVtcHR5LlxuICAgICAqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBydW5CYXRjaCgpIHtcbiAgICAgICAgdHJ5IHtcblxuICAgICAgICAgICAgLy8gU2V0IHRoZSBtb2RlIHRvICdyZWFkaW5nJyxcbiAgICAgICAgICAgIC8vIHRoZW4gZW1wdHkgYWxsIHJlYWQgam9ic1xuICAgICAgICAgICAgdGhpcy5iYXRjaC5tb2RlID0gJ3JlYWRpbmcnO1xuICAgICAgICAgICAgdGhpcy5mbHVzaCh0aGlzLmJhdGNoLnJlYWQpO1xuXG4gICAgICAgICAgICAvLyBTZXQgdGhlIG1vZGUgdG8gJ3dyaXRpbmcnXG4gICAgICAgICAgICAvLyB0aGVuIGVtcHR5IGFsbCB3cml0ZSBqb2JzXG4gICAgICAgICAgICB0aGlzLmJhdGNoLm1vZGUgPSAnd3JpdGluZyc7XG4gICAgICAgICAgICB0aGlzLmZsdXNoKHRoaXMuYmF0Y2gud3JpdGUpO1xuXG4gICAgICAgICAgICB0aGlzLmJhdGNoLm1vZGUgPSBudWxsO1xuXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIHRoaXMucnVuQmF0Y2goKTtcbiAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBBZGRzIGEgbmV3IGpvYiB0b1xuICAgICAqIHRoZSBnaXZlbiBiYXRjaC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7QXJyYXl9ICAgbGlzdFxuICAgICAqIEBwYXJhbSB7RnVuY3Rpb259IGZuXG4gICAgICogQHBhcmFtIHtPYmplY3R9ICAgY3R4XG4gICAgICogQHJldHVybnMge051bWJlcn0gaWRcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIGFkZCh0eXBlLCBmbiwgY3R4KSB7XG4gICAgICAgIHZhciBpZCA9IHRoaXMudW5pcXVlSWQoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMuYmF0Y2guaGFzaFtpZF0gPSB7XG4gICAgICAgICAgICBpZDogaWQsXG4gICAgICAgICAgICBmbjogZm4sXG4gICAgICAgICAgICBjdHg6IGN0eCxcbiAgICAgICAgICAgIHR5cGU6IHR5cGVcbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBSdW5zIGEgZ2l2ZW4gam9iLlxuICAgICAqXG4gICAgICogQXBwbGljYXRpb25zIHVzaW5nIEZhc3REb21cbiAgICAgKiBoYXZlIHRoZSBvcHRpb25zIG9mIHNldHRpbmdcbiAgICAgKiBgZmFzdGRvbS5vbkVycm9yYC5cbiAgICAgKlxuICAgICAqIFRoaXMgd2lsbCBjYXRjaCBhbnlcbiAgICAgKiBlcnJvcnMgdGhhdCBtYXkgdGhyb3dcbiAgICAgKiBpbnNpZGUgY2FsbGJhY2tzLCB3aGljaFxuICAgICAqIGlzIHVzZWZ1bCBhcyBvZnRlbiBET01cbiAgICAgKiBub2RlcyBoYXZlIGJlZW4gcmVtb3ZlZFxuICAgICAqIHNpbmNlIGEgam9iIHdhcyBzY2hlZHVsZWQuXG4gICAgICpcbiAgICAgKiBFeGFtcGxlOlxuICAgICAqXG4gICAgICogICBmYXN0ZG9tLm9uRXJyb3IgPSBmdW5jdGlvbihlKSB7XG4gICAgICogICAgIC8vIFJ1bnMgd2hlbiBqb2JzIGVycm9yXG4gICAgICogICB9O1xuICAgICAqXG4gICAgICogQHBhcmFtICB7T2JqZWN0fSBqb2JcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHJ1bihqb2IpIHtcbiAgICAgICAgdmFyIGN0eCA9IGpvYi5jdHggfHwgdGhpcztcbiAgICAgICAgdmFyIGZuID0gam9iLmZuO1xuXG4gICAgICAgIC8vIENsZWFyIHJlZmVyZW5jZSB0byB0aGUgam9iXG4gICAgICAgIGRlbGV0ZSB0aGlzLmJhdGNoLmhhc2hbam9iLmlkXTtcblxuICAgICAgICAvLyBJZiBubyBgb25FcnJvcmAgaGFuZGxlclxuICAgICAgICAvLyBoYXMgYmVlbiByZWdpc3RlcmVkLCBqdXN0XG4gICAgICAgIC8vIHJ1biB0aGUgam9iIG5vcm1hbGx5LlxuICAgICAgICBpZiAoIXRoaXMub25FcnJvcikge1xuICAgICAgICAgICAgcmV0dXJuIGZuLmNhbGwoY3R4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIElmIGFuIGBvbkVycm9yYCBoYW5kbGVyXG4gICAgICAgIC8vIGhhcyBiZWVuIHJlZ2lzdGVyZWQsIGNhdGNoXG4gICAgICAgIC8vIGVycm9ycyB0aGF0IHRocm93IGluc2lkZVxuICAgICAgICAvLyBjYWxsYmFja3MsIGFuZCBydW4gdGhlXG4gICAgICAgIC8vIGhhbmRsZXIgaW5zdGVhZC5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGZuLmNhbGwoY3R4KTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5vbkVycm9yKGUpO1xuICAgICAgICB9XG4gICAgfTtcblxuICAgIC8qKlxuICAgICAqIFN0YXJ0cyBhIHJBRiBsb29wXG4gICAgICogdG8gZW1wdHkgdGhlIGZyYW1lIHF1ZXVlLlxuICAgICAqXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBsb29wKCkge1xuICAgICAgICB2YXIgc2VsZiA9IHRoaXM7XG4gICAgICAgIHZhciByYWYgPSB0aGlzLnJhZjtcblxuICAgICAgICAvLyBEb24ndCBzdGFydCBtb3JlIHRoYW4gb25lIGxvb3BcbiAgICAgICAgaWYgKHRoaXMubG9vcGluZykgcmV0dXJuO1xuXG4gICAgICAgIHJhZihmdW5jdGlvbiBmcmFtZSgpIHtcbiAgICAgICAgICAgIHZhciBmbiA9IHNlbGYuZnJhbWVzLnNoaWZ0KCk7XG5cbiAgICAgICAgICAgIC8vIElmIG5vIG1vcmUgZnJhbWVzLFxuICAgICAgICAgICAgLy8gc3RvcCBsb29waW5nXG4gICAgICAgICAgICBpZiAoIXNlbGYuZnJhbWVzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgIHNlbGYubG9vcGluZyA9IGZhbHNlO1xuXG4gICAgICAgICAgICAgICAgLy8gT3RoZXJ3aXNlLCBzY2hlZHVsZSB0aGVcbiAgICAgICAgICAgICAgICAvLyBuZXh0IGZyYW1lXG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJhZihmcmFtZSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIFJ1biB0aGUgZnJhbWUuICBOb3RlIHRoYXRcbiAgICAgICAgICAgIC8vIHRoaXMgbWF5IHRocm93IGFuIGVycm9yXG4gICAgICAgICAgICAvLyBpbiB1c2VyIGNvZGUsIGJ1dCBhbGxcbiAgICAgICAgICAgIC8vIGZhc3Rkb20gdGFza3MgYXJlIGRlYWx0XG4gICAgICAgICAgICAvLyB3aXRoIGFscmVhZHkgc28gdGhlIGNvZGVcbiAgICAgICAgICAgIC8vIHdpbGwgY29udGludWUgdG8gaXRlcmF0ZVxuICAgICAgICAgICAgaWYgKGZuKSBmbigpO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmxvb3BpbmcgPSB0cnVlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEFkZHMgYSBmdW5jdGlvbiB0b1xuICAgICAqIGEgc3BlY2lmaWVkIGluZGV4XG4gICAgICogb2YgdGhlIGZyYW1lIHF1ZXVlLlxuICAgICAqXG4gICAgICogQHBhcmFtICB7TnVtYmVyfSAgIGluZGV4XG4gICAgICogQHBhcmFtICB7RnVuY3Rpb259IGZuXG4gICAgICogQHJldHVybiB7RnVuY3Rpb259XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBzY2hlZHVsZShpbmRleCwgZm4pIHtcblxuICAgICAgICAvLyBNYWtlIHN1cmUgdGhpcyBzbG90XG4gICAgICAgIC8vIGhhc24ndCBhbHJlYWR5IGJlZW5cbiAgICAgICAgLy8gdGFrZW4uIElmIGl0IGhhcywgdHJ5XG4gICAgICAgIC8vIHJlLXNjaGVkdWxpbmcgZm9yIHRoZSBuZXh0IHNsb3RcbiAgICAgICAgaWYgKHRoaXMuZnJhbWVzW2luZGV4XSkge1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuc2NoZWR1bGUoaW5kZXggKyAxLCBmbik7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBTdGFydCB0aGUgckFGXG4gICAgICAgIC8vIGxvb3AgdG8gZW1wdHlcbiAgICAgICAgLy8gdGhlIGZyYW1lIHF1ZXVlXG4gICAgICAgIHRoaXMubG9vcCgpO1xuXG4gICAgICAgIC8vIEluc2VydCB0aGlzIGZ1bmN0aW9uIGludG9cbiAgICAgICAgLy8gdGhlIGZyYW1lcyBxdWV1ZSBhbmQgcmV0dXJuXG4gICAgICAgIHJldHVybiB0aGlzLmZyYW1lc1tpbmRleF0gPSBmbjtcbiAgICB9XG5cblxuXG59XG5cbm1vZHVsZS5leHBvcnRzID0gQW5pRG9tOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==