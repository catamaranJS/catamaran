"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _createClass=function(){function e(e,t){for(var s=0;s<t.length;s++){var i=t[s];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,s,i){return s&&e(t.prototype,s),i&&e(t,i),t}}(),_get=function(e,t,s){for(var i=!0;i;){var r=e,n=t,a=s;i=!1,null===r&&(r=Function.prototype);var o=Object.getOwnPropertyDescriptor(r,n);if(void 0!==o){if("value"in o)return o.value;var u=o.get;return void 0===u?void 0:u.call(a)}var l=Object.getPrototypeOf(r);if(null===l)return void 0;e=l,t=n,s=a,i=!0,o=l=void 0}},CES=require("CES"),BABYLON=require("../lib/babylon"),utils=require("../utils/utils"),defaults=utils.defaultArgs();defaults._name="multiuser";var c_multiuser=function(e){function t(){var e=arguments.length<=0||void 0===arguments[0]?defaults:arguments[0];_classCallCheck(this,t),_get(Object.getPrototypeOf(t.prototype),"constructor",this).call(this),this.name=e._name,this.firebaseRef=e._fbURL,this.scene=e._scene,this.sysInit=!1,this.userInit=!1,utils.loadScript("https://cdn.firebase.com/js/client/2.3.0/firebase.js",this.setMultiUserData.bind(this))}return _inherits(t,e),_createClass(t,[{key:"setMultiUserData",value:function(){this.multiuser=new Firebase(this.firebaseRef),this.users=new Firebase(this.firebaseRef+"users"),this.user={name:null,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},sprite:null},this.currentUsers=[],this.fakeUser=["Tom","Richard","Jane","John","Dan","Josh","Brendon","Emma","Peter"],this.spriteImg="assets/sprites/users.png",this.sprites=[],this.Alerts=new Firebase(this.firebaseRef+"alerts"),this.currentAlerts=[],this.currentUserKey=null,this.executeUserRemoval=null,this.userToUpdate=this.firebaseRef+"users/",this.spriteAnimations=[20,40,60,80],this.zombieMode=!1,this.isCurrentlyUsing=!1,this.spManager=null,this.playerSprite=null,this.spriteID=20,this.initSys()}},{key:"initSys",value:function(){this.setUser(null,this.scene.activeCamera.position),this.spManager=new BABYLON.SpriteManager("userManager",this.spriteImg,1e3,128,this.scene),this.spManager.layerMask=3,this.playerSprite=new BABYLON.Sprite("player",this.spManager),this.playerSprite.isPickable=!0,this.zombieMode?this.playerSprite.playAnimation(80,100,!0,100):this.playerSprite.playAnimation(Math.abs(20-this.user.spriteID),parseInt(this.user.spriteID),!0,100),this.scene.activeCamera.position=new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),this.playerSprite.position=new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),this.sprites.push({sprite:this.playerSprite,key:this.currentUserKey}),window.requestAnimationFrame(function(){this.Alerts.on("child_added",function(e){this.currentAlerts.push(e.val())}.bind(this)),this.Alerts.once("value",function(e){e.forEach(function(e){this.currentAlerts.push(e.val())}.bind(this))}.bind(this)),this.users.on("child_added",function(e){this.currentUsers.push({data:e.val(),key:e.key()})}.bind(this)),this.users.on("child_changed",function(e){for(var t=0;t<this.currentUsers.length;t++)e.key()==this.currentUsers[t].key&&(this.currentUsers[t].data=e.val())}.bind(this)),this.users.once("value",function(e){e.forEach(function(e){null!=window.localStorage.getItem("vr_user_key")&&e.key()==window.localStorage.getItem("vr_user_key")&&(this.user=e.val(),this.currentUserKey=e.key(),this.userToUpdate+=e.key(),this.userToUpdate=new Firebase(this.userToUpdate),this.isCurrentlyUsing=!0)}.bind(this))}.bind(this)),this.sysInit=!0,setTimeout(function(){this.addUsers()}.bind(this),500)}.bind(this))}},{key:"addUsers",value:function(){for(var e=0;e<this.currentUsers.length;e++)this.currentUsers[e].key!=this.currentUserKey&&this.generateUserSprites(this.currentUsers[e],e);this.userInit=!0}},{key:"generateUserSprites",value:function(e,t){var s=new BABYLON.SpriteManager(e.key,e.data.sprite,1,128,this.scene);s.layerMask=3,s.texture=this.spManager.texture.clone();var i=new BABYLON.Sprite(e.key,s);i.isPickable=!0,i.position=void 0!=typeof e.data.position?e.data.position:new BABYLON.Vector3(this.user.position.x,this.user.position.y,this.user.position.z),i.size=14,e.data.zombieMode?i.playAnimation(80,100,!0,100):i.playAnimation(Math.abs(20-parseInt(e.data.spriteID)),parseInt(e.data.spriteID),!0,100),this.sprites.push({sprite:i,key:e.key})}},{key:"deleteUser",value:function(e){var t=new Firebase(this.firebaseRef+"users/"+e);t.once("value",function(s){var i=BABYLON.Mesh.CreateBox("foutain",1,this.babylonMod.scene);i.isVisible=!1,i.position=new BABYLON.Vector3(s.val().position.x,s.val().position.y,s.val().position.z);var r=new BABYLON.ParticleSystem("particles",1e3,this.babylonMod.scene);r.particleTexture=new BABYLON.Texture("bartvr/img/textures/flare.png",this.babylonMod.scene),r.emitter=i,r.minEmitBox=new BABYLON.Vector3(-1,0,0),r.maxEmitBox=new BABYLON.Vector3(1,0,0),r.color1=new BABYLON.Color4(.7,.8,1,1),r.color2=new BABYLON.Color4(.2,.5,1,1),r.colorDead=new BABYLON.Color4(0,0,.2,0),r.minSize=.1,r.maxSize=.5,r.minLifeTime=.1,r.maxLifeTime=.3,r.emitRate=1e3,r.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE,r.gravity=new BABYLON.Vector3(0,-9.81,0),r.direction1=new BABYLON.Vector3(-4,6,4),r.direction2=new BABYLON.Vector3(4,6,-4),r.minEmitPower=1,r.maxEmitPower=3,r.updateSpeed=.005,r.start(),setTimeout(function(){r.stop(),r.dispose();for(var s=0;s<this.scene.spriteManagers.length;s++)this.scene.spriteManagers[s].name==e&&this.scene.spriteManagers[s].dispose();t.remove()}.bind(this),5e3)}.bind(this),function(e){console.log(e)})}},{key:"setUser",value:function(){var e=(arguments.length<=0||void 0===arguments[0]?{name:"userName",position:{x:0,y:0,z:0}}:arguments[0],arguments.length<=1||void 0===arguments[1]?{}:arguments[1]);if(null==window.localStorage.getItem("vr_user")){e.x=utils.randomPos(-85,2),e.y=0,e.z=utils.randomPos(5,15);var t=null;t=null==this.user.name?utils.randomArr(this.fakeUser):this.user.name;try{window.localStorage.setItem("vr_user",t)}catch(s){alert("please allow local storage please disable private mode")}this.user={name:t,position:e,rotation:e,sprite:this.spriteImg,spriteID:utils.randomArr(this.spriteAnimations)},this.users=this.users.push(this.user),this.currentUserKey=this.users.key();try{window.localStorage.setItem("vr_user_key",this.currentUserKey)}catch(s){console.log(s)}}}},{key:"updateUser",value:function(e,t){this.sysInit&&(this.isCurrentlyUsing?this.userToUpdate.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}):null!=this.user.name&&this.users.set({name:this.user.name,position:e,rotation:t,sprite:this.user.sprite,spriteID:this.user.spriteID}))}},{key:"debug",value:function(){}}]),t}(CES.Component);module.exports=c_multiuser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvcmUvbHNkL2NvbXBvbmVudHMvY19tdWx0aXVzZXIuanMiXSwibmFtZXMiOlsiX2NsYXNzQ2FsbENoZWNrIiwiaW5zdGFuY2UiLCJDb25zdHJ1Y3RvciIsIlR5cGVFcnJvciIsIl9pbmhlcml0cyIsInN1YkNsYXNzIiwic3VwZXJDbGFzcyIsInByb3RvdHlwZSIsIk9iamVjdCIsImNyZWF0ZSIsImNvbnN0cnVjdG9yIiwidmFsdWUiLCJlbnVtZXJhYmxlIiwid3JpdGFibGUiLCJjb25maWd1cmFibGUiLCJzZXRQcm90b3R5cGVPZiIsIl9fcHJvdG9fXyIsIl9jcmVhdGVDbGFzcyIsImRlZmluZVByb3BlcnRpZXMiLCJ0YXJnZXQiLCJwcm9wcyIsImkiLCJsZW5ndGgiLCJkZXNjcmlwdG9yIiwiZGVmaW5lUHJvcGVydHkiLCJrZXkiLCJwcm90b1Byb3BzIiwic3RhdGljUHJvcHMiLCJfZ2V0IiwiX3g0IiwiX3g1IiwiX3g2IiwiX2FnYWluIiwib2JqZWN0IiwicHJvcGVydHkiLCJyZWNlaXZlciIsIkZ1bmN0aW9uIiwiZGVzYyIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsInVuZGVmaW5lZCIsImdldHRlciIsImdldCIsImNhbGwiLCJwYXJlbnQiLCJnZXRQcm90b3R5cGVPZiIsIkNFUyIsInJlcXVpcmUiLCJCQUJZTE9OIiwidXRpbHMiLCJkZWZhdWx0cyIsImRlZmF1bHRBcmdzIiwiX25hbWUiLCJjX211bHRpdXNlciIsIl9DRVMkQ29tcG9uZW50IiwiX29wdHMiLCJhcmd1bWVudHMiLCJ0aGlzIiwibmFtZSIsImZpcmViYXNlUmVmIiwiX2ZiVVJMIiwic2NlbmUiLCJfc2NlbmUiLCJzeXNJbml0IiwidXNlckluaXQiLCJsb2FkU2NyaXB0Iiwic2V0TXVsdGlVc2VyRGF0YSIsImJpbmQiLCJtdWx0aXVzZXIiLCJGaXJlYmFzZSIsInVzZXJzIiwidXNlciIsInBvc2l0aW9uIiwieCIsInkiLCJ6Iiwicm90YXRpb24iLCJzcHJpdGUiLCJjdXJyZW50VXNlcnMiLCJmYWtlVXNlciIsInNwcml0ZUltZyIsInNwcml0ZXMiLCJBbGVydHMiLCJjdXJyZW50QWxlcnRzIiwiY3VycmVudFVzZXJLZXkiLCJleGVjdXRlVXNlclJlbW92YWwiLCJ1c2VyVG9VcGRhdGUiLCJzcHJpdGVBbmltYXRpb25zIiwiem9tYmllTW9kZSIsImlzQ3VycmVudGx5VXNpbmciLCJzcE1hbmFnZXIiLCJwbGF5ZXJTcHJpdGUiLCJzcHJpdGVJRCIsImluaXRTeXMiLCJzZXRVc2VyIiwiYWN0aXZlQ2FtZXJhIiwiU3ByaXRlTWFuYWdlciIsImxheWVyTWFzayIsIlNwcml0ZSIsImlzUGlja2FibGUiLCJwbGF5QW5pbWF0aW9uIiwiTWF0aCIsImFicyIsInBhcnNlSW50IiwiVmVjdG9yMyIsInB1c2giLCJ3aW5kb3ciLCJyZXF1ZXN0QW5pbWF0aW9uRnJhbWUiLCJvbiIsImFsZXJ0RGF0YSIsInZhbCIsIm9uY2UiLCJmb3JFYWNoIiwiZGF0YSIsInVzZXJEYXRhIiwibG9jYWxTdG9yYWdlIiwiZ2V0SXRlbSIsInNldFRpbWVvdXQiLCJhZGRVc2VycyIsImdlbmVyYXRlVXNlclNwcml0ZXMiLCJfZGF0YSIsIl9pZCIsInNwcml0ZU1hbmFnZXJSaWRlciIsInRleHR1cmUiLCJjbG9uZSIsInBsYXllciIsInNpemUiLCJfZGtleSIsInVzZXJSZWYiLCJmb3VudGFpbiIsIk1lc2giLCJDcmVhdGVCb3giLCJiYWJ5bG9uTW9kIiwiaXNWaXNpYmxlIiwicGFydGljbGVTeXN0ZW0iLCJQYXJ0aWNsZVN5c3RlbSIsInBhcnRpY2xlVGV4dHVyZSIsIlRleHR1cmUiLCJlbWl0dGVyIiwibWluRW1pdEJveCIsIm1heEVtaXRCb3giLCJjb2xvcjEiLCJDb2xvcjQiLCJjb2xvcjIiLCJjb2xvckRlYWQiLCJtaW5TaXplIiwibWF4U2l6ZSIsIm1pbkxpZmVUaW1lIiwibWF4TGlmZVRpbWUiLCJlbWl0UmF0ZSIsImJsZW5kTW9kZSIsIkJMRU5ETU9ERV9PTkVPTkUiLCJncmF2aXR5IiwiZGlyZWN0aW9uMSIsImRpcmVjdGlvbjIiLCJtaW5FbWl0UG93ZXIiLCJtYXhFbWl0UG93ZXIiLCJ1cGRhdGVTcGVlZCIsInN0YXJ0Iiwic3RvcCIsImRpc3Bvc2UiLCJzcHJpdGVNYW5hZ2VycyIsInJlbW92ZSIsImVycm9yT2JqZWN0IiwiY29uc29sZSIsImxvZyIsIl9wb3MiLCJyYW5kb21Qb3MiLCJfdXNlcm5hbWUiLCJyYW5kb21BcnIiLCJzZXRJdGVtIiwiZSIsImFsZXJ0Iiwic2V0IiwiQ29tcG9uZW50IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUEsWUFNQSxTQUFTQSxpQkFBZ0JDLEVBQVVDLEdBQWUsS0FBTUQsWUFBb0JDLElBQWdCLEtBQU0sSUFBSUMsV0FBVSxxQ0FFaEgsUUFBU0MsV0FBVUMsRUFBVUMsR0FBYyxHQUEwQixrQkFBZkEsSUFBNEMsT0FBZkEsRUFBdUIsS0FBTSxJQUFJSCxXQUFVLGlFQUFvRUcsR0FBZUQsR0FBU0UsVUFBWUMsT0FBT0MsT0FBT0gsR0FBY0EsRUFBV0MsV0FBYUcsYUFBZUMsTUFBT04sRUFBVU8sWUFBWSxFQUFPQyxVQUFVLEVBQU1DLGNBQWMsS0FBZVIsSUFBWUUsT0FBT08sZUFBaUJQLE9BQU9PLGVBQWVWLEVBQVVDLEdBQWNELEVBQVNXLFVBQVlWLEdBTmplLEdBQUlXLGNBQWUsV0FBZSxRQUFTQyxHQUFpQkMsRUFBUUMsR0FBUyxJQUFLLEdBQUlDLEdBQUksRUFBR0EsRUFBSUQsRUFBTUUsT0FBUUQsSUFBSyxDQUFFLEdBQUlFLEdBQWFILEVBQU1DLEVBQUlFLEdBQVdYLFdBQWFXLEVBQVdYLGFBQWMsRUFBT1csRUFBV1QsY0FBZSxFQUFVLFNBQVdTLEtBQVlBLEVBQVdWLFVBQVcsR0FBTUwsT0FBT2dCLGVBQWVMLEVBQVFJLEVBQVdFLElBQUtGLElBQWlCLE1BQU8sVUFBVXJCLEVBQWF3QixFQUFZQyxHQUFpSixNQUE5SEQsSUFBWVIsRUFBaUJoQixFQUFZSyxVQUFXbUIsR0FBaUJDLEdBQWFULEVBQWlCaEIsRUFBYXlCLEdBQXFCekIsTUFF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LEVBQVVDLE9BQVFwQixLQUFLYyxLQUFLTSxPQUFRZSxTQUFVbkMsS0FBS2MsS0FBS3FCLGVBNEJsSWxFLElBQUssUUFDTGQsTUF2QkMsZ0JBak9FeUMsR0FBb0JQLElBQUlnSSxVQXVPL0JDLFFBQU9DLFFBQVUzSCIsImZpbGUiOiJjb3JlL2xzZC9jb21wb25lbnRzL2NfbXVsdGl1c2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIENFUyA9IHJlcXVpcmUoJ0NFUycpO1xudmFyIEJBQllMT04gPSByZXF1aXJlKCcuLi9saWIvYmFieWxvbicpO1xudmFyIHV0aWxzID0gcmVxdWlyZSgnLi4vdXRpbHMvdXRpbHMnKTtcbnZhciBkZWZhdWx0cyA9IHV0aWxzLmRlZmF1bHRBcmdzKCk7XG5kZWZhdWx0cy5fbmFtZSA9ICdtdWx0aXVzZXInO1xuLyoqXG4gKiAuLi5cbiAqIEBhdXRob3IgQnJlbmRvbiBTbWl0aFxuICogaHR0cDovL3NlYWNsb3VkOS5vcmdcbiAqIExpZ2h0V2VpZ2h0IDNEIFN5c3RlbSBEZXNpZ24gZW5naW5lXG4gKi9cbiBjbGFzcyBjX211bHRpdXNlciBleHRlbmRzIENFUy5Db21wb25lbnR7XG4gIGNvbnN0cnVjdG9yKF9vcHRzID0gZGVmYXVsdHMpe1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5uYW1lID0gX29wdHMuX25hbWU7XG4gICAgdGhpcy5maXJlYmFzZVJlZiA9IF9vcHRzLl9mYlVSTDtcbiAgICB0aGlzLnNjZW5lID0gIF9vcHRzLl9zY2VuZTtcbiAgICB0aGlzLnN5c0luaXQgPSBmYWxzZTtcbiAgICB0aGlzLnVzZXJJbml0ID0gZmFsc2U7XG4gICAgdXRpbHMubG9hZFNjcmlwdChcImh0dHBzOi8vY2RuLmZpcmViYXNlLmNvbS9qcy9jbGllbnQvMi4zLjAvZmlyZWJhc2UuanNcIiwgdGhpcy5zZXRNdWx0aVVzZXJEYXRhLmJpbmQodGhpcykpO1xuICAgIFxuICB9XG5cbiAgc2V0TXVsdGlVc2VyRGF0YSgpe1xuICAgIHRoaXMubXVsdGl1c2VyID0gbmV3IEZpcmViYXNlKHRoaXMuZmlyZWJhc2VSZWYpO1xuICAgIHRoaXMudXNlcnMgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICd1c2VycycpO1xuICAgIHRoaXMudXNlciA9IHtuYW1lOm51bGwsIHBvc2l0aW9uOnt4OjAsIHk6MCwgejowfSwgcm90YXRpb246e3g6MCwgeTowLCB6OjB9LCBzcHJpdGU6bnVsbH07XG4gICAgdGhpcy5jdXJyZW50VXNlcnMgPSBbXTtcbiAgICB0aGlzLmZha2VVc2VyID0gWydUb20nLCdSaWNoYXJkJywnSmFuZScsJ0pvaG4nLCdEYW4nLCdKb3NoJywnQnJlbmRvbicsJ0VtbWEnLCdQZXRlciddO1xuICAgIHRoaXMuc3ByaXRlSW1nID0gJ2Fzc2V0cy9zcHJpdGVzL3VzZXJzLnBuZyc7XG4gICAgdGhpcy5zcHJpdGVzID0gW107XG4gICAgdGhpcy5BbGVydHMgPSBuZXcgRmlyZWJhc2UodGhpcy5maXJlYmFzZVJlZiArICdhbGVydHMnKTtcbiAgICB0aGlzLmN1cnJlbnRBbGVydHMgPSBbXTtcbiAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gbnVsbDtcbiAgICB0aGlzLmV4ZWN1dGVVc2VyUmVtb3ZhbCA9IG51bGw7XG4gICAgdGhpcy51c2VyVG9VcGRhdGUgPSAgdGhpcy5maXJlYmFzZVJlZisgJ3VzZXJzLyc7XG4gICAgdGhpcy5zcHJpdGVBbmltYXRpb25zID0gWzIwLDQwLDYwLDgwXTtcbiAgICB0aGlzLnpvbWJpZU1vZGUgPSBmYWxzZTtcbiAgICB0aGlzLmlzQ3VycmVudGx5VXNpbmcgID0gZmFsc2U7XG4gICAgdGhpcy5zcE1hbmFnZXIgPSBudWxsO1xuICAgIHRoaXMucGxheWVyU3ByaXRlID0gbnVsbDtcbiAgICB0aGlzLnNwcml0ZUlEID0gMjA7XG4gICAgdGhpcy5pbml0U3lzKCk7XG4gIH1cblxuICBpbml0U3lzKCl7XG5cbiAgICB0aGlzLnNldFVzZXIobnVsbCwgdGhpcy5zY2VuZS5hY3RpdmVDYW1lcmEucG9zaXRpb24pO1xuXG4gICAgLypcbiAgICBpZiggISB0aGlzLmFwcC5fcGxhdGZvcm0uaXMoJ2FuZHJvaWQnKSApe1xuICAgICAgICB0aGlzLmh1ZCA9IG5ldyBCYXJ0VlJfSGVhZHNVcERpc3BsYXkodGhpcy5zY2VuZSwgdGhpcyk7XG4gICAgfVxuICAgICovXG5cbiAgICB0aGlzLnNwTWFuYWdlciAgPSBuZXcgQkFCWUxPTi5TcHJpdGVNYW5hZ2VyKFwidXNlck1hbmFnZXJcIiwgdGhpcy5zcHJpdGVJbWcsIDEwMDAsIDEyOCwgdGhpcy5zY2VuZSk7XG4gICAgdGhpcy5zcE1hbmFnZXIubGF5ZXJNYXNrID0gMztcbiAgICB0aGlzLnBsYXllclNwcml0ZSA9IG5ldyBCQUJZTE9OLlNwcml0ZShcInBsYXllclwiLCB0aGlzLnNwTWFuYWdlciApO1xuICAgIHRoaXMucGxheWVyU3ByaXRlLmlzUGlja2FibGUgPSB0cnVlO1xuXG4gICBcblxuICAgIGlmKHRoaXMuem9tYmllTW9kZSl7XG4gICAgICB0aGlzLnBsYXllclNwcml0ZS5wbGF5QW5pbWF0aW9uKCA4MCwgIDEwMCwgdHJ1ZSwgMTAwKTtcbiAgICB9ZWxzZXtcbiAgICAgIHRoaXMucGxheWVyU3ByaXRlLnBsYXlBbmltYXRpb24oTWF0aC5hYnMoIDIwIC0gdGhpcy51c2VyLnNwcml0ZUlEKSwgIHBhcnNlSW50KHRoaXMudXNlci5zcHJpdGVJRCksIHRydWUsIDEwMCk7XG4gICAgfVxuICAgIHRoaXMuc2NlbmUuYWN0aXZlQ2FtZXJhLnBvc2l0aW9uID0gbmV3IEJBQllMT04uVmVjdG9yMyh0aGlzLnVzZXIucG9zaXRpb24ueCwgdGhpcy51c2VyLnBvc2l0aW9uLnksIHRoaXMudXNlci5wb3NpdGlvbi56KTtcbiAgICB0aGlzLnBsYXllclNwcml0ZS5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjModGhpcy51c2VyLnBvc2l0aW9uLngsIHRoaXMudXNlci5wb3NpdGlvbi55LCB0aGlzLnVzZXIucG9zaXRpb24ueik7XG4gICAgLy8gdGhpcy5zY2VuZS5hY3RpdmVDYW1lcmEucm90YXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKHRoaXMuRGF0YS51c2VyLnJvdGF0aW9uLngsIHRoaXMuRGF0YS51c2VyLnJvdGF0aW9uLnksIHRoaXMuRGF0YS51c2VyLnJvdGF0aW9uLnopO1xuICAgIHRoaXMuc3ByaXRlcy5wdXNoKHtzcHJpdGU6dGhpcy5wbGF5ZXJTcHJpdGUsIGtleTp0aGlzLmN1cnJlbnRVc2VyS2V5fSk7XG5cbiAgIHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUoZnVuY3Rpb24oKXtcbiAgICB0aGlzLkFsZXJ0cy5vbihcImNoaWxkX2FkZGVkXCIsIGZ1bmN0aW9uKGFsZXJ0RGF0YSkge1xuICAgICAgdGhpcy5jdXJyZW50QWxlcnRzLnB1c2goYWxlcnREYXRhLnZhbCgpKTtcbiAgICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy5BbGVydHMub25jZShcInZhbHVlXCIsIGZ1bmN0aW9uKGFsZXJ0RGF0YSkge1xuICAgICAgYWxlcnREYXRhLmZvckVhY2goZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICB0aGlzLmN1cnJlbnRBbGVydHMucHVzaChkYXRhLnZhbCgpKTtcbiAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMudXNlcnMub24oXCJjaGlsZF9hZGRlZFwiLCBmdW5jdGlvbih1c2VyRGF0YSkge1xuICAgICAgLy90b2RvIGZpeCBpbml0aWFsIHVzZXJcbiAgICAgLyogdGhpcy51c2VyW3VzZXJEYXRhLmtleSgpXSA9IHVzZXJEYXRhLnZhbCgpO1xuICAgICAgaWYodXNlckRhdGEua2V5KCkgPT0gJ3Nwcml0ZUlEJyl7XG4gICAgICAgIHRoaXMuY3VycmVudFVzZXJzLnB1c2godGhpcy51c2VyKTtcbiAgICAgIH0qL1xuICAgIC8vIFxuICAgICB0aGlzLmN1cnJlbnRVc2Vycy5wdXNoKHtkYXRhOnVzZXJEYXRhLnZhbCgpLCBrZXk6IHVzZXJEYXRhLmtleSgpfSk7XG4gICAgLy8gc2V0VGltZW91dCh0aGlzLmFkZFVzZXJzLmJpbmQodGhpcyksIDUwMClcbiAgICAgXG4gICB9LmJpbmQodGhpcykpO1xuXG4gICAgdGhpcy51c2Vycy5vbihcImNoaWxkX2NoYW5nZWRcIiwgZnVuY3Rpb24odXNlckRhdGEpIHtcbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLmN1cnJlbnRVc2Vycy5sZW5ndGg7IGkrKyl7XG4gICAgICAgIGlmKHVzZXJEYXRhLmtleSgpID09IHRoaXMuY3VycmVudFVzZXJzW2ldLmtleSl7XG4gICAgICAgICB0aGlzLmN1cnJlbnRVc2Vyc1tpXS5kYXRhID0gIHVzZXJEYXRhLnZhbCgpO1xuICAgICAgIH1cbiAgICAgfVxuICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMudXNlcnMub25jZShcInZhbHVlXCIsIGZ1bmN0aW9uKHVzZXJEYXRhKSB7XG4gICAgICB1c2VyRGF0YS5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgaWYod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKFwidnJfdXNlcl9rZXlcIikgIT0gbnVsbCAmJiBkYXRhLmtleSgpID09IHdpbmRvdy5sb2NhbFN0b3JhZ2UuZ2V0SXRlbShcInZyX3VzZXJfa2V5XCIpICl7XG4gICAgICAgICAgdGhpcy51c2VyID0gZGF0YS52YWwoKTtcbiAgICAgICAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gZGF0YS5rZXkoKTtcbiAgICAgICAgICB0aGlzLnVzZXJUb1VwZGF0ZSArPSAgZGF0YS5rZXkoKTtcbiAgICAgICAgICB0aGlzLnVzZXJUb1VwZGF0ZSA9IG5ldyBGaXJlYmFzZSh0aGlzLnVzZXJUb1VwZGF0ZSk7XG4gICAgICAgICAgdGhpcy5pc0N1cnJlbnRseVVzaW5nID0gdHJ1ZTtcbiAgICAgICAgfSBcbiAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgfS5iaW5kKHRoaXMpKTtcblxuICAgIHRoaXMuc3lzSW5pdCA9IHRydWU7IFxuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAgIHRoaXMuYWRkVXNlcnMoKTtcbiAgICB9LmJpbmQodGhpcyksIDUwMCk7XG4gIH0uYmluZCh0aGlzKSk7XG59XG5cbmFkZFVzZXJzKCl7XG4gICAgZm9yKGxldCBpID0gMDsgaSA8IHRoaXMuY3VycmVudFVzZXJzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgaWYodGhpcy5jdXJyZW50VXNlcnNbaV0ua2V5ICE9IHRoaXMuY3VycmVudFVzZXJLZXkpe1xuICAgICAgICAgICAgdGhpcy5nZW5lcmF0ZVVzZXJTcHJpdGVzKHRoaXMuY3VycmVudFVzZXJzW2ldLCBpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICB0aGlzLnVzZXJJbml0ID0gdHJ1ZTtcbn1cblxuXG5nZW5lcmF0ZVVzZXJTcHJpdGVzKF9kYXRhLCBfaWQpe1xuICAgIHZhciBzcHJpdGVNYW5hZ2VyUmlkZXIgPSBuZXcgQkFCWUxPTi5TcHJpdGVNYW5hZ2VyKF9kYXRhLmtleSwgX2RhdGEuZGF0YS5zcHJpdGUsIDEsIDEyOCwgdGhpcy5zY2VuZSk7XG4gICAgc3ByaXRlTWFuYWdlclJpZGVyLmxheWVyTWFzayA9IDM7XG4gICAgc3ByaXRlTWFuYWdlclJpZGVyLnRleHR1cmUgPSB0aGlzLnNwTWFuYWdlci50ZXh0dXJlLmNsb25lKCk7XG4gICAgbGV0IHBsYXllciA9IG5ldyBCQUJZTE9OLlNwcml0ZShfZGF0YS5rZXksIHNwcml0ZU1hbmFnZXJSaWRlciApO1xuICAgIHBsYXllci5pc1BpY2thYmxlID0gdHJ1ZTtcbiAgICBpZih0eXBlb2YgIF9kYXRhLmRhdGEucG9zaXRpb24gIT0gdW5kZWZpbmVkKXtcbiAgICAgIHBsYXllci5wb3NpdGlvbiA9IF9kYXRhLmRhdGEucG9zaXRpb247XG4gICAgfWVsc2V7XG4gICAgICBwbGF5ZXIucG9zaXRpb24gPSBuZXcgQkFCWUxPTi5WZWN0b3IzKHRoaXMudXNlci5wb3NpdGlvbi54LCB0aGlzLnVzZXIucG9zaXRpb24ueSwgdGhpcy51c2VyLnBvc2l0aW9uLnopO1xuICAgIH1cbiAgICAvL3BsYXllci5yb3RhdGlvbiA9IF9kYXRhLmRhdGEucm90YXRpb247XG4gICAgcGxheWVyLnNpemUgPSAxNC4wO1xuICAgIGlmKF9kYXRhLmRhdGEuem9tYmllTW9kZSl7XG4gICAgICAgIHBsYXllci5wbGF5QW5pbWF0aW9uKCA4MCwgIDEwMCwgdHJ1ZSwgMTAwKTtcbiAgICB9ZWxzZXtcbiAgICAgICAgcGxheWVyLnBsYXlBbmltYXRpb24oTWF0aC5hYnMoIDIwIC0gcGFyc2VJbnQoX2RhdGEuZGF0YS5zcHJpdGVJRCkpLCAgcGFyc2VJbnQoX2RhdGEuZGF0YS5zcHJpdGVJRCksIHRydWUsIDEwMCk7XG4gICAgfVxuICAgIHRoaXMuc3ByaXRlcy5wdXNoKHtzcHJpdGU6cGxheWVyLCBrZXk6X2RhdGEua2V5fSk7XG59XG5cbmRlbGV0ZVVzZXIoX2RrZXkpe1xuICB2YXIgdXNlclJlZiA9IG5ldyBGaXJlYmFzZSh0aGlzLmZpcmViYXNlUmVmICsgJ3VzZXJzLycgICsgX2RrZXkpO1xuICB1c2VyUmVmLm9uY2UoXCJ2YWx1ZVwiLCBmdW5jdGlvbihfZGF0YSkge1xuICAgIHZhciBmb3VudGFpbiA9IEJBQllMT04uTWVzaC5DcmVhdGVCb3goXCJmb3V0YWluXCIsIDEuMCwgdGhpcy5iYWJ5bG9uTW9kLnNjZW5lKTtcbiAgICBmb3VudGFpbi5pc1Zpc2libGUgPSBmYWxzZTtcbiAgICBmb3VudGFpbi5wb3NpdGlvbiA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoX2RhdGEudmFsKCkucG9zaXRpb24ueCwgX2RhdGEudmFsKCkucG9zaXRpb24ueSwgX2RhdGEudmFsKCkucG9zaXRpb24ueilcbiAgICB2YXIgcGFydGljbGVTeXN0ZW0gPSBuZXcgQkFCWUxPTi5QYXJ0aWNsZVN5c3RlbShcInBhcnRpY2xlc1wiLCAxMDAwLCB0aGlzLmJhYnlsb25Nb2Quc2NlbmUpO1xuICAgIHBhcnRpY2xlU3lzdGVtLnBhcnRpY2xlVGV4dHVyZSA9IG5ldyBCQUJZTE9OLlRleHR1cmUoXCJiYXJ0dnIvaW1nL3RleHR1cmVzL2ZsYXJlLnBuZ1wiLCB0aGlzLmJhYnlsb25Nb2Quc2NlbmUpO1xuICAgIHBhcnRpY2xlU3lzdGVtLmVtaXR0ZXIgPSBmb3VudGFpbjsgLy8gdGhlIHN0YXJ0aW5nIG9iamVjdCwgdGhlIGVtaXR0ZXJcbiAgICBwYXJ0aWNsZVN5c3RlbS5taW5FbWl0Qm94ID0gbmV3IEJBQllMT04uVmVjdG9yMygtMSwgMCwgMCk7IC8vIFN0YXJ0aW5nIGFsbCBmcm9tXG4gICAgcGFydGljbGVTeXN0ZW0ubWF4RW1pdEJveCA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoMSwgMCwgMCk7IC8vIFRvLi4uXG4gICAgcGFydGljbGVTeXN0ZW0uY29sb3IxID0gbmV3IEJBQllMT04uQ29sb3I0KDAuNywgMC44LCAxLjAsIDEuMCk7XG4gICAgcGFydGljbGVTeXN0ZW0uY29sb3IyID0gbmV3IEJBQllMT04uQ29sb3I0KDAuMiwgMC41LCAxLjAsIDEuMCk7XG4gICAgcGFydGljbGVTeXN0ZW0uY29sb3JEZWFkID0gbmV3IEJBQllMT04uQ29sb3I0KDAsIDAsIDAuMiwgMC4wKTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5taW5TaXplID0gMC4xO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1heFNpemUgPSAwLjU7XG4gICAgcGFydGljbGVTeXN0ZW0ubWluTGlmZVRpbWUgPSAwLjE7XG4gICAgcGFydGljbGVTeXN0ZW0ubWF4TGlmZVRpbWUgPSAwLjM7XG4gICAgcGFydGljbGVTeXN0ZW0uZW1pdFJhdGUgPSAxMDAwO1xuICAgIHBhcnRpY2xlU3lzdGVtLmJsZW5kTW9kZSA9IEJBQllMT04uUGFydGljbGVTeXN0ZW0uQkxFTkRNT0RFX09ORU9ORTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5ncmF2aXR5ID0gbmV3IEJBQllMT04uVmVjdG9yMygwLCAtOS44MSwgMCk7XG4gICAgcGFydGljbGVTeXN0ZW0uZGlyZWN0aW9uMSA9IG5ldyBCQUJZTE9OLlZlY3RvcjMoLTQsIDYsIDQpO1xuICAgIHBhcnRpY2xlU3lzdGVtLmRpcmVjdGlvbjIgPSBuZXcgQkFCWUxPTi5WZWN0b3IzKDQsIDYsIC00KTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5taW5FbWl0UG93ZXIgPSAxO1xuICAgIHBhcnRpY2xlU3lzdGVtLm1heEVtaXRQb3dlciA9IDM7XG4gICAgcGFydGljbGVTeXN0ZW0udXBkYXRlU3BlZWQgPSAwLjAwNTtcbiAgICBwYXJ0aWNsZVN5c3RlbS5zdGFydCgpO1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAgIHBhcnRpY2xlU3lzdGVtLnN0b3AoKTtcbiAgICAgIHBhcnRpY2xlU3lzdGVtLmRpc3Bvc2UoKTtcbiAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCB0aGlzLnNjZW5lLnNwcml0ZU1hbmFnZXJzLmxlbmd0aDsgaSsrKXtcbiAgICAgICAgaWYoICB0aGlzLnNjZW5lLnNwcml0ZU1hbmFnZXJzW2ldLm5hbWUgPT0gX2RrZXkpe1xuICAgICAgICAgIHRoaXMuc2NlbmUuc3ByaXRlTWFuYWdlcnNbaV0uZGlzcG9zZSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB1c2VyUmVmLnJlbW92ZSgpO1xuICAgIH0uYmluZCh0aGlzKSwgNTAwMCk7ICAgICAgIFxuICB9LmJpbmQodGhpcyksIGZ1bmN0aW9uIChlcnJvck9iamVjdCkge1xuICAgY29uc29sZS5sb2coZXJyb3JPYmplY3QpO1xuIH0pO1xufVxuXG5zZXRVc2VyKF91c2VyID0ge25hbWU6ICd1c2VyTmFtZScsIHBvc2l0aW9uOiB7eDowLCB5OjAsIHo6MH19LCBfcG9zID0ge30gKXtcbiAgaWYod2luZG93LmxvY2FsU3RvcmFnZS5nZXRJdGVtKFwidnJfdXNlclwiKSA9PSBudWxsKXtcbiAgICBfcG9zLnggPSB1dGlscy5yYW5kb21Qb3MoLTg1LCAyKTtcbiAgICBfcG9zLnkgPSAwO1xuICAgIF9wb3MueiA9IHV0aWxzLnJhbmRvbVBvcyg1LCAxNSk7XG4gICAgdmFyIF91c2VybmFtZSA9IG51bGw7XG4gICAgaWYodGhpcy51c2VyLm5hbWUgPT0gbnVsbCl7XG4gICAgICBfdXNlcm5hbWUgPSAgdXRpbHMucmFuZG9tQXJyKHRoaXMuZmFrZVVzZXIpO1xuICAgIH1lbHNle1xuICAgICAgX3VzZXJuYW1lID0gdGhpcy51c2VyLm5hbWU7XG4gICAgfVxuICAgIHRyeXtcbiAgICAgIHdpbmRvdy5sb2NhbFN0b3JhZ2Uuc2V0SXRlbShcInZyX3VzZXJcIiwgX3VzZXJuYW1lKTtcbiAgICB9Y2F0Y2goZSl7XG4gICAgICBhbGVydCgncGxlYXNlIGFsbG93IGxvY2FsIHN0b3JhZ2UgcGxlYXNlIGRpc2FibGUgcHJpdmF0ZSBtb2RlJyk7XG4gICAgfVxuICAgIHRoaXMudXNlciA9IHtuYW1lOl91c2VybmFtZSwgcG9zaXRpb246IF9wb3MsIHJvdGF0aW9uOiBfcG9zLCBzcHJpdGU6dGhpcy5zcHJpdGVJbWcsIHNwcml0ZUlEOiB1dGlscy5yYW5kb21BcnIodGhpcy5zcHJpdGVBbmltYXRpb25zKSB9O1xuICAgIHRoaXMudXNlcnMgPSB0aGlzLnVzZXJzLnB1c2goIHRoaXMudXNlcik7ICBcbiAgICB0aGlzLmN1cnJlbnRVc2VyS2V5ID0gdGhpcy51c2Vycy5rZXkoKTtcbiAgICB0cnl7XG4gICAgICB3aW5kb3cubG9jYWxTdG9yYWdlLnNldEl0ZW0oXCJ2cl91c2VyX2tleVwiLCB0aGlzLmN1cnJlbnRVc2VyS2V5ICk7XG4gICAgfWNhdGNoKGUpe1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICB9XG5cbiAgfVxufVxuXG5cbnVwZGF0ZVVzZXIocG9zaXRpb24sIHJvdGF0aW9uKXtcbiAgaWYodGhpcy5zeXNJbml0KXtcbiAgICAgIGlmKHRoaXMuaXNDdXJyZW50bHlVc2luZyl7XG4gICAgICAgIHRoaXMudXNlclRvVXBkYXRlLnNldCh7bmFtZTogdGhpcy51c2VyLm5hbWUsIHBvc2l0aW9uOiBwb3NpdGlvbiwgcm90YXRpb246IHJvdGF0aW9uLCBzcHJpdGU6IHRoaXMudXNlci5zcHJpdGUsICBzcHJpdGVJRDogdGhpcy51c2VyLnNwcml0ZUlEIH0pO1xuICAgICAgfWVsc2V7XG4gICAgICAgIGlmKHRoaXMudXNlci5uYW1lICE9IG51bGwpe1xuICAgICAgICAgIHRoaXMudXNlcnMuc2V0KHtuYW1lOiB0aGlzLnVzZXIubmFtZSwgcG9zaXRpb246IHBvc2l0aW9uLCByb3RhdGlvbjogcm90YXRpb24sIHNwcml0ZTogdGhpcy51c2VyLnNwcml0ZSwgc3ByaXRlSUQ6IHRoaXMudXNlci5zcHJpdGVJRCB9KTtcbiAgICAgICAgfVxuICAgICAgfVxuICB9XG59XG5cbmRlYnVnKCl7XG5cbn1cblxuXG59XG5tb2R1bGUuZXhwb3J0cyA9IGNfbXVsdGl1c2VyOyJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==